Orion t^2 project based on Rubin's 2012 WFC3 data

* Messing around with the graphics
Abandoned both of these for the time being - more trouble than they were worth. 
** Fancy javascript effects
#+BEGIN_SRC python
import mpld3
mpld3.enable_notebook()
mpld3.disable_notebook()
#+END_SRC

** Better defaults for colors and the like
#+BEGIN_SRC python
import seaborn as sn
#+END_SRC

* Notes on particular objects

** Shadows 
:PROPERTIES:
:ID:       8D522091-DF9C-4446-8BA7-FBC707A126C7
:END:
There are at least three sorts of shadows: 
1. Observer shadows, such as foreground disks and clouds
   + Where we are in the shadow of the object
2. Shadow rays behind proplyds
   + These are low ionization: increase in [N II]/H\alpha and decrease in [O III]/H\beta
   + They are seen in the outer part of the field
3. Shadow holes
   + The prototype is the Dark Arc
   + They are /high/ ionization



     
* Learning to use a proper database
+ The main thing I want from a database is the ability to simultaneously update records from multiple programs running at the same time, without having
+ However, after spending an entire morning looking into this, it seems to be far more trouble than it is worth
  + Doing it properly, e.g., using SQLalchemy is way too complicated
  + There are easy-to-use wrappers such as dataset, but they are very limiting
    + You can't store nested dicts or dicts of numpy arrays very easily
    + Although you can do it by doing =json.dumps= on the sub-objects to convert them to a string
  + It is also necessary to be careful with concurrent connections, although I think I have that just about sorted
    + With SQLite, many processes can be reading from the database at any one time, but only one can be writing to it
* Final push to finish this - April/June 2014
:PROPERTIES:
:exports:  both
:END:

We have a lot of material that needs to be drawn together
** Plan for the final paper
*** TODO Short term priorities
DEADLINE: <2014-06-18 Wed>
+ [X] Do de-reddening
  + Pixel-by-pixel, or with a constant value?
+ [-] Make maps of the region of interest
  + [X] RGB image
  + [ ] [N II] and [S II] ratio images
    + [ ] multiscale?
  + [ ] Overlays of contours
    + [ ] scattered continuum
    + [ ] 469 excess
    + [ ] [S II] excess
  + [ ] Write these up

*** TODO Longer term
+ [ ] sensitivity to continuum color term
+ [ ] Generate the full-field images of the strong lines
  + [ ] Make images of each quadrant with suitable scaling in [S II] [N II] [O III] and also in scattered continuum
  + [ ] Draw attention to interesting features
    + Narrow sattering filaments in the south
    + Dark tendrils - which sort of [[id:8D522091-DF9C-4446-8BA7-FBC707A126C7][shadow]] are these?
*** Global plan
+ At the moment, I have three sections:
  1. Deriving diagnostic line ratios from the WFC3 filter images
  2. Deriving Te, ne from the line ratios
  3. Fluctuations in Te, ne
+ Where I have been stuck for months on the first part, and still don't have firm conclusions
+ To this I could add a fourth section: maps of Te and correlation with other indicators (in particular, the [Fe III] and the excess [S II])
*** TODO From filter ratios to line ratios
+ I had the following functions
#+BEGIN_SRC python
W547, W658, W575 = 169.0, 7.3, 4.7
Tn, Ta = 0.26, 0.23
k658 = 0.8  # We don't really know this one yet

def EWa(R575, k575=0.938):
    return (W547/(k575*R575) - W575)/Ta

def EWn(R658):
    return (W547/(k658*R658) - W658)/Tn

def ratio_nii(R, R575, R658, k575=0.938):
    """[N II] 5755/6584 ratio"""
    return R * (Tn/Ta) * (1.0 - W575*k575*R575/W547) / (1.0 - W658*k658*R658/W547)
#+END_SRC
+ Of course, some of this now needs modification - we should calculate the parameters directly from the filter bandpasses. 
#+BEGIN_SRC python :return table 
from wfc3_utils import get_filter, Tm, Wj, Wtwid

bands = ["F547M", "FQ575N", "F658N", "F673N", "FQ672N", "FQ674N"]
wav0s = [5755, 5755, 6583, 6731, 6716, 6731]
table = [["band", "Tm", "Wj Tm", "Wj", "Wtwid"], None]
fmts = ['{:s}', '{:.4f}', '{:.2f}', '{:.2f}', '{:.2f}']
for band, wav0 in zip(bands, wav0s):
    wavs, T = get_filter(band, return_wavelength=True)
    row = [band, Tm(T), Wj(wavs, T)*Tm(T), Wj(wavs, T), Wtwid(wav0, wavs, T)]
    table.append([fmt.format(item) for item, fmt in zip(row, fmts)])
#+END_SRC

#+RESULTS:
| band   |     Tm |  Wj Tm |     Wj |  Wtwid |
|--------+--------+--------+--------+--------|
| F547M  | 0.2675 | 173.89 | 650.19 | 899.79 |
| FQ575N | 0.2297 |   4.22 |  18.37 |  18.45 |
| F658N  | 0.2485 |   6.85 |  27.57 |  27.83 |
| F673N  | 0.2468 |  29.07 | 117.78 | 137.49 |
| FQ672N | 0.2460 |   4.77 |  19.38 |  19.46 |
| FQ674N | 0.1881 |   3.32 |  17.65 |  17.66 |

Now we have a nice equation for finding the ratios

#+caption: Filter sets
#+name: filter-sets
| 5755 | 6584 | FQ575N | F658N  | F547M  |
| 6716 | 6731 | FQ672N | FQ674N | F673N  |
| 6716 | 6731 | FQ672N | FQ674N | F547M  |
| 4363 | 5007 | FQ437N | F502N  | FQ436N |
| 4363 | 5007 | FQ437N | F502N  | F547M  |
| 4861 | 6563 | F487N  | F656N  | F547M  |

#+BEGIN_SRC python :return table :var intable=filter-sets
  from wfc3_utils import ratio_coefficients
  cols = ["alpha_1", "alpha_2", "beta_1", "beta_2"]

  table = [["I", "II", "III"] + cols, None]

  for wav1, wav2, FI, FII, FIII in intable:
      d = ratio_coefficients(wav1=wav1, wav2=wav2, I=FI, II=FII, III=FIII)
      table.append([FI, FII, FIII] + ["{:0.4g}".format(d[k]) for k in cols])


#+END_SRC

#+RESULTS:
| I      | II     | III    |   alpha_1 |   alpha_2 |  beta_1 |  beta_2 |
|--------+--------+--------+-----------+-----------+---------+---------|
| FQ575N | F658N  | F547M  |     0.845 | 1.269e-07 | 0.02426 | 0.03939 |
| FQ672N | FQ674N | F673N  |    0.9942 |     1.125 |   0.164 |  0.1142 |
| FQ672N | FQ674N | F547M  | 1.068e-07 | 2.027e-07 | 0.02742 | 0.01909 |
| FQ437N | F502N  | FQ436N |    0.9679 |  1.24e-07 |  0.7111 |   1.998 |
| FQ437N | F502N  | F547M  | 3.913e-06 |  0.001408 | 0.03426 | 0.09627 |
| F487N  | F656N  | F547M  | 2.459e-06 | 9.577e-08 | 0.08711 | 0.02375 |

So for the [N II] ratio, the continuum contribution coefficients \beta for 575 and 658 are comparable - 2 to 4%, but the result will be more important for 575 since R_{II} > R_{III} > R_{I} by factors of 100:10:1 re-show

The following serves to test the new =find_line_ratio= function and
compares the version with and without accounting for the line and
continuum contamination terms.  We use median count rates from the
spectrophotometry for each of the three filters. 

Now also grabbing suitable k values from the odh files

#+name: filter-set-fakes
| Wav1 | Wav2 | I      | II     | III    |   R_I | R_II | R_III | k_I_III | k_II_III |
|------+------+--------+--------+--------+-------+------+-------+---------+----------|
| 5755 | 6584 | FQ575N | F658N  | F547M  | 0.295 |  7.8 |   4.6 |    0.94 |     1.01 |
| 6716 | 6731 | FQ672N | FQ674N | F673N  |  0.34 |  0.4 |   1.0 |    1.07 |     1.02 |
| 6716 | 6731 | FQ672N | FQ674N | F547M  |  0.34 |  0.4 |   2.5 |    1.04 |     0.99 |
| 4363 | 5007 | FQ437N | F502N  | FQ436N |  0.18 |  8.0 |   0.4 |    0.75 |     0.59 |
| 4363 | 5007 | FQ437N | F502N  | F547M  |  0.18 |  8.0 |   2.5 |    1.37 |     1.07 |
| 4861 | 6563 | F487N  | F656N  | F547M  |   3.2 | 12.0 |   2.5 |     1.1 |     1.01 |

#+BEGIN_SRC python :return table :var intable=filter-set-fakes
  from wfc3_utils import find_line_ratio
  table = [["I", "II", "III", "I_1/I_2", "Naive I_1/I_2"], None]
  for wav1, wav2, FI, FII, FIII, RI, RII, RIII, kI, kII in intable[0:]:
      filterset = {"wav1": wav1, "wav2": wav2, "I": FI, "II": FII, "III": FIII}
      row = [FI, FII, FIII]
      row.extend(["{:.3f}".format(find_line_ratio(filterset,
                                                  RI, RII, RIII,
                                                  k_I=kI, k_II=kII, naive=naive))
                  for naive in (False, True)])
      table.append(row)
#+END_SRC

#+RESULTS:
| I      | II     | III    | I_1/I_2 | Naive I_1/I_2 |
|--------+--------+--------+---------+---------------|
| FQ575N | F658N  | F547M  |   0.031 |         0.046 |
| FQ672N | FQ674N | F673N  |   0.604 |         0.654 |
| FQ672N | FQ674N | F547M  |   0.586 |         0.654 |
| FQ437N | F502N  | FQ436N |  -0.012 |         0.030 |
| FQ437N | F502N  | F547M  |   0.011 |         0.030 |
| F487N  | F656N  | F547M  |   0.306 |         0.329 |

+ So many of these change significantly from the naive value
+ The set that uses FQ436N produces a negative ratio, which can't be right
  + Presumably this is due to neglecting the line contamination, which probably gives a large k value - adjusting the k value does at least stop it from going negative, but it still disagrees with the F547M version.  And doing the ktwiddle values more carefully actually gives a negative value again
*** Histograms of the continuum color
With correction for non-target lines


The first version is just for the continuum
#+name: filters-and-lines
| FQ672N | 6716 |
| F673N  | 6716 |
| FQ674N | 6731 |
| F656N  | 6563 |
| F658N  | 6583 |
| FQ575N | 5755 |
| F547M  | 5755 |
| F502N  | 5007 |
| F487N  | 4861 |
| FQ436N | 4340 |
| FQ437N | 4363 |
#+BEGIN_SRC python :var intab=filters-and-lines :return outtab :results verbatim
  from astropy.table import Table
  from matplotlib import pyplot as plt
  import numpy as np

  outtab = []
  kmin, kmax = 0.5, 2.5
  for filt, wav in intab:
      dataset = "odh"
      kay = "k"
      swav = str(wav)
      spectabfile = "{}-spectra-data-{}.tab".format(dataset, filt)
      spectab = Table.read(spectabfile, format="ascii.tab",
                           fill_values=('--', 0.0))
      fig = plt.figure(figsize=(3,3))
      plt.hist(spectab[kay+swav], bins=50, range=(kmin, kmax))
      if filt == "F547M":
          ktwid = (1.0 + spectab['Sum(E/W)'])
      elif filt == "FQ436N":
          ktwid = spectab[kay+swav]*(1.0 + spectab['E/W 4340'])
      elif filt == "F673N":
          # Correct for 6731 line, which is a target line
          frac = np.array([(1.0 - 0.01*int(s[-3:-1])) for s in spectab['Strongest']])
          ktwid = spectab[kay+swav]*(1.0 + frac*spectab['Sum(E/W)'])
      else:
          ktwid = spectab[kay+swav]*(1.0 + spectab['Sum(E/W)'])
      plt.hist(ktwid, bins=50, range=(kmin, kmax))
      plt.xlim(kmin, kmax)
      plt.title("{} {:.2f} +/- {:.2f}".format(filt, ktwid.mean(), ktwid.std()))
      pltfile = "color-hist-{}-{}.png".format(kay, filt)
      fig.savefig(pltfile, dpi=50)
      outtab.append("[[file:{}]]".format(pltfile))
  outtab = ' '.join(outtab)

#+END_SRC

#+RESULTS:
: [[file:color-hist-k-FQ672N.png]] [[file:color-hist-k-F673N.png]] [[file:color-hist-k-FQ674N.png]] [[file:color-hist-k-F656N.png]] [[file:color-hist-k-F658N.png]] [[file:color-hist-k-FQ575N.png]] [[file:color-hist-k-F547M.png]] [[file:color-hist-k-F502N.png]] [[file:color-hist-k-F487N.png]] [[file:color-hist-k-FQ436N.png]] [[file:color-hist-k-FQ437N.png]]
*** Now apply to the WFC3 maps
#+name: ratio-limits
| FQ575N | 0.005 | 0.07 |
| FQ672N |   0.4 |  1.0 |
| FQ437N | -0.01 | 0.03 |
| F487N  |  0.20 | 0.33 |
#+header: :var intable=filter-set-fakes limits=ratio-limits
#+BEGIN_SRC python :return plotlinks :results list
  import numpy as np
  from wfc3_utils import find_line_ratio
  from astropy.io import fits
  from matplotlib import pyplot as plt
  import matplotlib
  import pyregion
  fitsfilenames = {
      "FQ436N": "full_FQ436N_north_pad.fits",
      "FQ575N": "full_FQ575N_north_pad.fits",
      "FQ672N": "full_FQ672N_north_pad.fits",
      "FQ674N": "full_FQ674N_north_pad.fits",
      "F673N": "full_F673N_north_pad.fits",
      "F469N": "full_F469N_north_pad.fits",
      "F487N": "full_F487N_north_pad.fits",
      "F656N": "full_F656N_north_pad.fits",
      "F658N": "full_F658N_north_pad.fits",
      "F547M": "full_F547M_north_pad.fits",
      "F502N": "full_F502N_north_pad.fits",
      "FQ437N": "full_FQ437N_north_pad.fits"
  }

  minmax_dict = dict([(row[0], row[1:]) for row in limits])

  def get_fits_data(fn='FQ575N'):
      return fits.open(fitsfilenames[fn])[0].data

  plotlinks = []
  for wav1, wav2, FI, FII, FIII, _, _, _, kI, kII in intable[0:]:
      filterset = {"wav1": wav1, "wav2": wav2, "I": FI, "II": FII, "III": FIII}
      RI = get_fits_data(FI)
      RII = get_fits_data(FII)
      RIII = get_fits_data(FIII)
      x = find_line_ratio(filterset, RI, RII, RIII, k_I=kI, k_II=kII, naive=True)
      y = find_line_ratio(filterset, RI, RII, RIII, k_I=kI, k_II=kII, naive=False)
      hdu = fits.PrimaryHDU(y, header=fits.open(fitsfilenames[FI])[0].header)
      hdu.writeto("ratio-contam-correct-{}-{}-{}.fits".format(FI, FII, FIII), clobber=True)
      hdu = fits.PrimaryHDU(x, header=fits.open(fitsfilenames[FI])[0].header)
      hdu.writeto("ratio-naive-{}-{}-{}.fits".format(FI, FII, FIII), clobber=True)
      if '575' in FI:
          include = pyregion.open("will-nii-sweet-spot.reg")
          exclude = pyregion.open("will-nii-exclude.reg")
          ssmask = include.get_mask(hdu=hdu) & (~exclude.get_mask(hdu=hdu))
      else:
          region = pyregion.open("will-extended-sweet-spot.reg")
          ssmask = region.get_mask(hdu=hdu)
      xmin, xmax = minmax_dict[FI]
      ymin, ymax = xmin, xmax
      fig = plt.figure(figsize=(6,6))
      m = ssmask & np.isfinite(x) & np.isfinite(y) & ( xmin < x ) & (x < xmax) & (ymin < y) & (y < ymax) & (y <= x)
      x, y = x[m], y[m]
      pltfile = "contam-correct-{}-{}-{}.pdf".format(FI, FII, FIII)
      w = RII[m]
      H, xedges, yedges = np.histogram2d(x, y, 100,
                                         [[xmin, xmax], [ymin, ymax]],
                                         weights=w)
      plt.imshow(H.T, extent=[xmin, xmax, ymin, ymax],
                 interpolation='none', aspect='auto', origin='lower', 
                 cmap=plt.cm.gray_r, alpha=1.0)
      plt.xlabel("({} / {})*".format(wav1, wav2))
      plt.ylabel("({} / {})".format(wav1, wav2))
      plt.grid()
      plt.plot([xmin, xmax], [ymin, ymax], '--k')
      plt.axis([xmin, xmax, ymin, ymax])
      fig.savefig(pltfile)
      plotlinks.append("[[file:{}]]".format(pltfile))



#+END_SRC

#+RESULTS:
- [[file:contam-correct-FQ575N-F658N-F547M.pdf]]
- [[file:contam-correct-FQ672N-FQ674N-F673N.pdf]]
- [[file:contam-correct-FQ672N-FQ674N-F547M.pdf]]
- [[file:contam-correct-FQ437N-F502N-FQ436N.pdf]]
- [[file:contam-correct-FQ437N-F502N-F547M.pdf]]
- [[file:contam-correct-F487N-F656N-F547M.pdf]]
**** Correlations between ratios
Look at the following:
- The two ways of finding 6716/6731
- The [N II] ratio versus extinction
- The [N II] ratio versus [S II] ratio

In all cases, we weight by the nii brightness
#+name: interesting-ratios
| nii-red  | F487N-F656N-F547M   | 0.2 | 0.3 | FQ575N-F658N-F547M  | 0.00 | 0.04 |
| nii-sii  | FQ672N-FQ674N-F547M | 0.4 | 0.8 | FQ575N-F658N-F547M  | 0.00 | 0.04 |
| nii-sii2 | FQ672N-FQ674N-F673N | 0.4 | 0.8 | FQ575N-F658N-F547M  | 0.00 | 0.04 |
| sii-sii  | FQ672N-FQ674N-F547M | 0.4 | 0.8 | FQ672N-FQ674N-F673N |  0.4 |  0.8 |
#+header: :var tab=interesting-ratios
#+BEGIN_SRC python :return plotlinks :results list
  import numpy as np
  from astropy.io import fits
  from matplotlib import pyplot as plt
  import pyregion
  plotlinks = []
  snii = fits.open("full_F658N_north_pad.fits")[0].data
  for descrip, ratA, xmin, xmax, ratB, ymin, ymax in tab:
      hduA = fits.open("ratio-contam-correct-{}.fits".format(ratA))[0]
      hduB = fits.open("ratio-contam-correct-{}.fits".format(ratB))[0]
      region =  pyregion.open("will-extended-sweet-spot.reg")
      m = region.get_mask(hdu=hduA)
      x = hduA.data[m]
      y = hduB.data[m]
      w = snii[m]
      fig = plt.figure(figsize=(6,6))
      pltfile = "ratio-correl-{}.pdf".format(descrip)
      H, xedges, yedges = np.histogram2d(x, y, 100,
                                         [[xmin, xmax], [ymin, ymax]],
                                         weights=w)
      plt.imshow(H.T, extent=[xmin, xmax, ymin, ymax],
                 interpolation='none', aspect='auto', origin='lower', 
                 cmap=plt.cm.gray_r, alpha=1.0)
      plt.xlabel(ratA)
      plt.ylabel(ratB)
      plt.grid()
      if descrip == "sii-sii":
          plt.plot([xmin, xmax], [ymin, ymax], '--k')
      fig.savefig(pltfile)
      plotlinks.append("[[file:{}]]".format(pltfile))
#+END_SRC  

#+RESULTS:
- [[file:ratio-correl-nii-red.pdf]]
- [[file:ratio-correl-nii-sii.pdf]]
- [[file:ratio-correl-nii-sii2.pdf]]
- [[file:ratio-correl-sii-sii.pdf]]
**** Curves for T,n diagnostics
#+name: pyneb-setup
#+header: :python /Users/will/anaconda/envs/py27/bin/python
#+BEGIN_SRC python
import pyneb
sii = pyneb.Atom('S', 2)
nii = pyneb.Atom('N', 2)
#+END_SRC

#+name: T-n-curves
#+BEGIN_SRC python

denrange = np.linspace(0.0, 3.e4, 100)
for tem in [9e3, 1e4, 1.1e4, 1.2e4, 1.3e4]:
    As = sii.getEmissivity(tem, denrange, wave=6716)
    Bs = sii.getEmissivity(tem, denrange, wave=6731)
    An = nii.getEmissivity(tem, denrange, wave=5755)
    Bn = nii.getEmissivity(tem, denrange, wave=6583)
    plt.plot(As/Bs, An/Bn, label="T = {:.0f} K".format(tem))

temrange = np.linspace(5000.0, 20000.0, 100)
for den in [1000, 2000, 4000, 8000, 16000]:
    As = sii.getEmissivity(temrange, den, wave=6716)
    Bs = sii.getEmissivity(temrange, den, wave=6731)
    An = nii.getEmissivity(temrange, den, wave=5755)
    Bn = nii.getEmissivity(temrange, den, wave=6583)
    plt.plot(As/Bs, An/Bn, '--', label="n = {:.0f} pcc".format(den))
#+END_SRC

#+name: two-phase-func
#+BEGIN_SRC python
def two_phase_rsii_rnii(den_hi, f_hi, den_lo=1000.0, T0=8000.0, T_hi=None):
    """Calculate [S II] and [N II] ratios from mixture of 2 densities"""
    if T_hi is None:
        T_hi = T0
    As_hi = sii.getEmissivity(T_hi, den_hi, wave=6716) 
    As_lo = sii.getEmissivity(T0, den_lo, wave=6716) 
    Bs_hi = sii.getEmissivity(T_hi, den_hi, wave=6731)
    Bs_lo = sii.getEmissivity(T0, den_lo, wave=6731)
    rsii = (f_hi*As_hi + (1.-f_hi)*As_lo)/(f_hi*Bs_hi + (1.-f_hi)*Bs_lo)
    
    An_hi = nii.getEmissivity(T_hi, den_hi, wave=5755) 
    An_lo = nii.getEmissivity(T0, den_lo, wave=5755) 
    Bn_hi = nii.getEmissivity(T_hi, den_hi, wave=6583)
    Bn_lo = nii.getEmissivity(T0, den_lo, wave=6583)
    rnii = (f_hi*An_hi + (1.-f_hi)*An_lo)/(f_hi*Bn_hi + (1.-f_hi)*Bn_lo)
    return rsii, rnii
#+END_SRC

**** Corrected [N II] versus [S II] ratio map

Adal's measurements corrected for reddening
#+name: adal-ratios
#+BEGIN_SRC python
from astropy.table import Table
adaltab = Table.read("adal-slit6-extract.dat", format="ascii.tab")
adal_rnii_raw = adaltab["5755"]/adaltab["6583"]
adal_rsii = adaltab["6716"]/adaltab["6731"]
# correct for reddening
adal_rnii = adal_rnii_raw * 10**0.06

bob_rsii = np.array([0.5953, 0.6133, 0.5316])
bob_rnii = np.array([0.0215, 0.0172, 0.0221])
cesar_rsii = np.array([3.303/6.023, 2.59/4.71])
cesar_rnii_raw = np.array([0.858/61.589, 0.962/52.5])
cesar_rnii = cesar_rnii_raw * 10**0.06

plt.plot(adal_rsii, adal_rnii, "co", 
         alpha=0.6, label="Mesa-Delgado et al. (2008)")
plt.plot(cesar_rsii, cesar_rnii, "mo", label="Esteban et al. (1998, 2004)")
plt.plot(bob_rsii, bob_rnii, "yo", label="O'Dell & Harris (2010)")

#+END_SRC

The 2d histogram plot itself
#+name: rnii-rsii-histogram
#+BEGIN_SRC python
  snii = fits.open("full_F658N_north_pad.fits")[0].data
  hduA = fits.open("ratio-contam-correct-FQ672N-FQ674N-F547M.fits")[0]
  hduB = fits.open("ratio-FQ575N-F658N-deredden-2874.fits")[0]

  xmin, xmax, ymin, ymax = 0.4, 0.8, 0.0, 0.05
  include = pyregion.open("will-nii-sweet-spot.reg")
  exclude = pyregion.open("will-nii-exclude.reg")
  m = include.get_mask(hdu=hduA) & (~exclude.get_mask(hdu=hduA))

  include = pyregion.open("will-sii-sweet-spot.reg")
  exclude = pyregion.open("will-sii-exclude.reg")
  m = m & include.get_mask(hdu=hduA) & (~exclude.get_mask(hdu=hduA))

  m = m & np.isfinite(hduA.data) & np.isfinite(hduB.data)
  x = hduA.data[m]
  y = hduB.data[m]
  w = snii[m]
  fig = plt.figure(figsize=(7,7))
  H, xedges, yedges = np.histogram2d(x, y, 100,
                                     [[xmin, xmax], [ymin, ymax]],
                                     weights=w)
  plt.imshow((H.T)**(1.0/gamma), extent=[xmin, xmax, ymin, ymax],
             interpolation='none', aspect='auto', origin='lower', 
             cmap=plt.cm.gray_r, alpha=1.0)
#+END_SRC

Putting it all together with the 1-phase curves
#+header: :python /Users/will/anaconda/envs/py27/bin/python
#+header: :var gamma=1.5 :noweb yes
#+BEGIN_SRC python :return pltfile :results file
  import numpy as np
  from astropy.io import fits
  from matplotlib import pyplot as plt
  import pyregion
  <<rnii-rsii-histogram>>
  <<pyneb-setup>>
  <<T-n-curves>>
  <<adal-ratios>>
  pltfile = "nii-deredden-vs-sii-ratios.pdf"
  plt.legend(ncol=2, fontsize='x-small', handlelength=2.2, numpoints=1)
  plt.xlabel("[S II] 6716 / 6731")
  plt.ylabel("Dereddened [N II] 5755 / 6584")
  plt.grid()
  plt.axis([xmin, xmax, ymin, ymax])
  fig.savefig(pltfile)

#+END_SRC

#+RESULTS:
[[file:nii-deredden-vs-sii-ratios.pdf]]

And now try with the 2-phase curves

#+header: :python /Users/will/anaconda/envs/py27/bin/python
#+header: :var gamma=1.5 :noweb yes
#+BEGIN_SRC python :return pltfile :results file
  import numpy as np
  from astropy.io import fits
  from matplotlib import pyplot as plt
  import pyregion
  <<rnii-rsii-histogram>>
  <<pyneb-setup>>
  <<two-phase-func>>
  T_lo, T_hi, f0 = 10000, 10000, 0.5
  for den_hi in [1.e4, 4e4, 1.e5, 2e5, 4.e5]:
      denrange = np.logspace(2.0, np.log10(den_hi), 100)
      rsii, rnii = two_phase_rsii_rnii(den_hi, f0, denrange, T_lo, T_hi)
      plt.plot(rsii, (10**(-0.6*0.095))*rnii, 
              label="den(hi) = {:.0e} pcc".format(den_hi))
  for den_lo in [1000.0, 2000.0, 4000.0, 8000.0, 16000.0]:
      denrange = np.linspace(den_lo, 1.e6, 100)
      rsii, rnii = two_phase_rsii_rnii(denrange, f0, den_lo, T_lo, T_hi)
      plt.plot(rsii, (10**(-0.6*0.095))*rnii, 
              '--', label="den(lo) = {:.0e} pcc".format(den_lo))
  pltfile = "nii-sii-ratios-two-phase.pdf"
  plt.legend(ncol=2, fontsize='x-small',
             title="f(hi) = f(lo) = 0.5; T(lo) = T(hi) = 1e4 K",
             handlelength=2.2, numpoints=1)
  plt.xlabel("[S II] 6716 / 6731")
  plt.ylabel("Dereddened [N II] 5755 / 6584")
  plt.grid()
  plt.title('Two-density models')
  plt.axis([xmin, xmax, ymin, ymax])
  fig.savefig(pltfile)
#+END_SRC

#+RESULTS:
[[file:nii-sii-ratios-two-phase.pdf]]

***** 
**** The excess line maps
We have several of these: 
+ Excess (scattered) continuum:
#+BEGIN_SRC python :results output
from astropy.io import fits
s547 = fits.open("full_F547M_north_pad.fits")[0]
s487 = fits.open("full_F487N_north_pad.fits")[0]
s656 = fits.open("full_F656N_north_pad.fits")[0]
shii = (2*s487.data + s656.data/2.874)/3
r547 = s547.data/shii
xs547 = s547.data - 0.45*shii
s547.data = xs547
s547.writeto("scattered_continuum_045.fits")
#+END_SRC 

#+RESULTS:

+ Excess [S II] emission
#+BEGIN_SRC python :results output
from astropy.io import fits
s672 = fits.open("full_F673N_north_pad.fits")[0]
s658 = fits.open("full_F658N_north_pad.fits")[0]
siix = s672.data - 0.07*s658.data
s672.data = siix
s672.writeto("excess_sii_007.fits")
#+END_SRC 

#+RESULTS:

+ Excess 469 emission ([Fe III])
#+BEGIN_SRC python :results output
from astropy.io import fits
s469 = fits.open("full_F469N_north_pad.fits")[0]
s547 = fits.open("full_F547M_north_pad.fits")[0]
s469.data -= 0.047*s547.data
s469.writeto("excess_469_047.fits")
#+END_SRC 

#+RESULTS:



**** DONE Effects of extinction
CLOSED: [2014-06-17 Tue 12:02]
+ F(\lambda) values are 
| H\beta 4861  |    0.0 |
| [N II] 5755  | -0.123 |
| H\alpha 6563 | -0.220 |
| [N II] 6584  | -0.222 |

+ Calculate CHB from observed Balmer decrement R = Ha/Hb
  - I'(Ha) = I(Ha) 10**(-(1+F) CHB)
  - I'(Hb) = I(Hb) 10**(-CHB)
  - => R' = R 10**(-(1+F) CHB  + CHB) = R 10**(-F CHB)
  - => CHB = log10(R'/R) / (-F) = 4.5454 log10(R'/R)

+ Calculate correction to 5755/6584
  - I'(6584) = I(6584) 10**(-(1+Fn) CHB)
  - I'(5755) = I(5755) 10**(-(1+Fa) CHB)
  - => R' = R 10**((Fa - Fn) CHB) = R 10**(0.099 CHB)


#+header: :var balmer0=2.874
#+BEGIN_SRC python :results output
from astropy.io import fits
import numpy as np
hdu = fits.open("ratio-contam-correct-F487N-F656N-F547M.fits")[0]
chb = -np.log10(balmer0*hdu.data) / 0.220
hdu.data = chb
b0string = str(int(1000*balmer0))
hdu.writeto("new-chb-{}.fits".format(b0string), clobber=True)

hdu = fits.open("ratio-contam-correct-FQ575N-F658N-F547M.fits")[0]
hdu.data *= 10**(0.099*chb)
hdu.writeto("ratio-FQ575N-F658N-deredden-{}.fits".format(b0string), clobber=True)
#+END_SRC

#+RESULTS:
: WARNING: Overwriting existing file 'new-chb-2874.fits'. [astropy.io.fits.file]
: WARNING: Overwriting existing file 'ratio-FQ575N-F658N-deredden-2874.fits'. [astropy.io.fits.file]

This means that the
***** Variation of Balmer decrement with density and temperature
#+header: :python /Users/will/anaconda/envs/py27/bin/python
#+BEGIN_SRC python :return table
import pyneb
h1 = pyneb.RecAtom('H', 1)
tem = [7000, 8000, 9000, 10000, 11000]
den = [1e3, 3e3, 1e4, 3e4]
bdec = h1.getEmissivity(tem, den, label='3_2')/h1.getEmissivity(tem, den, label='4_2')
table = []
table.append(['density'] + ['T = {} K'.format(t) for t in tem])
table.append(None)
for d, results in zip(den, bdec):
    table.append([d] + ['{:.3f}'.format(x) for x in results])
#+END_SRC

#+RESULTS:
| density | T = 7000 K | T = 8000 K | T = 9000 K | T = 10000 K | T = 11000 K |
|---------+------------+------------+------------+-------------+-------------|
|  1000.0 |      2.947 |      2.909 |      2.886 |       2.857 |       2.842 |
|  3000.0 |      2.937 |      2.904 |      2.881 |       2.852 |       2.837 |
| 10000.0 |      2.930 |      2.895 |      2.874 |       2.847 |       2.833 |
| 30000.0 |      2.919 |      2.884 |      2.862 |       2.839 |       2.826 |


**** Mask out the bad areas in the ratio maps
#+name: files-to-mask
| nii | ratio-FQ575N-F658N-deredden-2874.fits         | ratio-FQ575N-F658N-masked.fits  |
| sii | ratio-contam-correct-FQ672N-FQ674N-F547M.fits | ratio-FQ672N-FQ674N-masked.fits |
#+BEGIN_SRC python :var tab=files-to-mask :results output
  from astropy.io import fits
  import numpy as np
  import pyregion
  f547 = fits.open("full_F547M_north_pad.fits")[0].data
  mm = np.isfinite(f547) & (f547 > 0.0)
  for name, infile, outfile in tab:
      hdu = fits.open(infile)[0]
      include = pyregion.open("will-{}-sweet-spot.reg".format(name))
      exclude = pyregion.open("will-{}-exclude.reg".format(name))
      m = include.get_mask(hdu=hdu) & (~exclude.get_mask(hdu=hdu))
      hdu.data[~m | ~mm] = np.nan
      hdu.writeto(outfile, clobber=True)
#+END_SRC

#+RESULTS:
: WARNING: AstropyDeprecationWarning: The ascard function is deprecated and may be removed in a future version.
:         Use the `.cards` attribute instead. [pyregion.wcs_helper]
: WARNING: AstropyDeprecationWarning: The CardList class has been deprecated; all its former functionality has been subsumed by the Header class, so CardList objects should not be directly created.  See the PyFITS 3.1.0 CHANGELOG for more details. [astropy.io.fits.card]
: WARNING: AstropyDeprecationWarning: The ascard function is deprecated and may be removed in a future version.
:         Use the `.cards` attribute instead. [pyregion.wcs_helper]
: WARNING: Overwriting existing file 'ratio-FQ575N-F658N-masked.fits'. [astropy.io.fits.file]
: WARNING: Overwriting existing file 'ratio-FQ672N-FQ674N-masked.fits'. [astropy.io.fits.file]

*** Making some nice images
**** Three-color imageof entire field: [S II], [N II], [O III]
+ Note that this doesn't work in python3
#+header: :python /Users/will/anaconda/envs/py27/bin/python
#+BEGIN_SRC python :return figfile :results file
  import aplpy
  from astropy.io import fits
  import matplotlib.pyplot as plt
  r_file = "full_F673N_north_pad.fits"
  g_file = "full_F658N_north_pad.fits"
  b_file = "full_F502N_north_pad.fits"
  aplpy.make_rgb_image([r_file, g_file, b_file], "full_RGB.jpg",
                       vmin_r=0.0, vmax_r=2.5,
                       vmin_g=0.1, vmax_g=15.0, stretch_g='sqrt',
                       vmin_b=0.3, vmax_b=20.0)
  f = aplpy.FITSFigure("full_RGB.jpg")
  f.show_rgb(interpolation='none')
  figfile = "full_RGB_test.pdf"
  plt.gcf().savefig(figfile)
#+END_SRC

#+RESULTS:
[[file:full_RGB_test.pdf]]
**** Positions of embedded stars
#+name: embedded-sources
|      ID | RA | Dec |
|---------+----+-----|
| 143-353 |    |     |
| 144-351 |    |     |
| 136-355 |    |     |
| 136-400 |    |     |

#+name: embedded-markers
#+BEGIN_SRC python

#+END_SRC
**** Fix coordinates
Turns out there is a displacement between WFC3 and ACS
|-----------+-----------+----------|
| 83.805445 | 83.805524 |  -7.9e-5 |
| 83.811726 | 83.811802 |  -7.6e-5 |
|-----------+-----------+----------|
|           |           | -7.75e-5 |
#+TBLFM: @3$3=vmean(@I..@II)

|------------+------------+---------|
|  -5.398054 | -5.3980803 | 2.63e-5 |
| -5.3962191 | -5.3962342 | 1.51e-5 |
|------------+------------+---------|
|            |            | 2.07e-5 |
#+TBLFM: $3=$1 - $2::@3$3=vmean(@I..@II)

Alignment of Robberto ACS for the Western side of the field (e.g., LL1)
#+BEGIN_SRC sh
xpaset -p ds9 pan -6.25e-5 3.07e-5 wcs
#+END_SRC

Alignment of Robberto ACS for the Eastern side of the field (e.g., Orion S). 
Callibrated with the following sources: 
| 5:35:14.816 | -5:23:46.39 |
| 5:35:15.152 | -5:23:46.61 |
| 5:35:15.756 | -5:23:38.33 |
|             |             |
#+BEGIN_SRC sh
xpaset -p ds9 pan -6.75e-5 2.57e-5 wcs
#+END_SRC

#+RESULTS:

Extra alignment for Bally ACS image
#+BEGIN_SRC sh
xpaset -p ds9 pan 0e-5 -0.75e-5 wcs
#+END_SRC

#+RESULTS:

Apply the alignment directly to the images
#+BEGIN_SRC python :results output
from astropy.io import fits
import os
data_dir = "/Users/will/Work/OrionTreasury"
bally_file = os.path.join(data_dir, "Bally-ACS/j8oc01010_wcs.fits")
robb_file = os.path.join(data_dir, "acs/hlsp_orion_hst_acs_strip0l_f658n_v1_drz.fits")

def shift_header(hdr, dx, dy):
    """Shift the reference coordinate in a FITS header by dx, dy (in degrees)"""
    x = hdr.get('CRVAL1')
    y = hdr.get('CRVAL2')
    hdr['CRVAL1'] = x + dx
    hdr['CRVAL2'] = y + dy

hdulist = fits.open(bally_file)
shift_header(hdulist['SCI'].header, 6.75e-5, -1.82e-5)
hdulist.writeto("f658n-acs-bally-quadalign.fits", clobber=True)

hdulist = fits.open(robb_file)
shift_header(hdulist['SCI'].header, 6.75e-5, -2.57e-5)
hdulist.writeto("f658n-acs-robberto-quadalign.fits", clobber=True)
#+END_SRC

#+RESULTS:
: WARNING: Overwriting existing file 'f658n-acs-bally-quadalign.fits'. [astropy.io.fits.file]
**** Proper motions
Add together the F658N and F656N wfc3 filters so as to better compare with the ACS f658n filter.

#+BEGIN_SRC python :results none
from astropy.io import fits
hdu656 = fits.open("F656N_quadalign.fits")[1]
hdu658 = fits.open("ibrd01070_quadalign.fits")[1]
hdu656.data += hdu658.data
hdu656.writeto("F656N_plus_F658N_quadalign.fits", clobber=True)
#+END_SRC

#+RESULTS:

***** Epochs
+ Bally ACS : 2004-01
+ Robberto ACS : 2004-10
+ WFC3 : 2012-04
***** Make a GIF movie
#+BEGIN_SRC sh
ls *epoch*.jpg
#+END_SRC

#+RESULTS:
| proper-motion-orion-s-epoch01.jpg |
| proper-motion-orion-s-epoch02.jpg |
| proper-motion-orion-s-epoch03.jpg |

#+BEGIN_SRC sh
ORDER="\
   proper-motion-orion-s-epoch01.jpg   \
   proper-motion-orion-s-epoch02.jpg   \
   proper-motion-orion-s-epoch03.jpg"
convert $(for a in "$ORDER"; do printf -- "-delay 100 %s " $a; done; ) proper-motion-orion-s-vslow.gif
#+END_SRC


Animation for Bob that shows why sub-pixel alignment is necessary for the Ha/Hb ratio
#+BEGIN_SRC sh :results none
convert $(for a in 01 02; do printf -- "-delay 100 screenshot-ha-hb-%s.jpg " $a; done; ) screenshot-ha-hb.gif
#+END_SRC


**** Field of interest
The general region of the jet sources, including nearly as far as th1C
#+name: jet-region
| 83.80716 | -5.3976835 | 0.02 | 0.015 |
It turns out that we need to pass the width,height in pixels but the center coords in degrees
#+header: :python /Users/will/anaconda/envs/py27/bin/python
#+header: :var recenter_box=jet-region
#+BEGIN_SRC python :return figfile :results file
  import aplpy
  from astropy.io import fits
  import matplotlib.pyplot as plt
  f = aplpy.FITSFigure("full_RGB.jpg")
  f.show_rgb(interpolation='none')
  [ra0, dec0, dra, ddec], = recenter_box
  f.recenter(ra0, dec0, width=dra*3600/0.04, height=ddec*3600/0.04)
  f.show_colorbar()
  f.colorbar.hide()
  f.add_grid()
  f.grid.set_alpha(0.2)
  figfile = "jet_region_RGB.pdf"
  plt.gcf().set_size_inches(12, 9)
  plt.gcf().tight_layout()
  plt.gcf().savefig(figfile)
#+END_SRC

#+RESULTS:
[[file:jet_region_RGB.pdf]]

Now the ratios
#+header: :var recenter_box=jet-region
#+BEGIN_SRC python :return figfile :results file
  import aplpy
  from astropy.io import fits
  import matplotlib.pyplot as plt
  f = aplpy.FITSFigure("ratio-FQ575N-F658N-masked.fits")
  f.show_grayscale(interpolation='none', vmin=0.01, vmax=0.055)
  [ra0, dec0, dra, ddec], = recenter_box
  f.recenter(ra0, dec0, width=dra, height=ddec)
  f.add_colorbar()
  f.add_label(0.8, 0.9, '[N II] 5755 / 6583', relative=True, size='x-large')
  f.add_grid()
  f.grid.set_alpha(0.2)
  f.ticks.set_color('black')
  figfile = "jet_region_niiratio.pdf"
  plt.gcf().set_size_inches(12, 9)
  plt.gcf().tight_layout()
  plt.gcf().savefig(figfile)
#+END_SRC

#+RESULTS:
[[file:jet_region_niiratio.pdf]]

#+header: :var recenter_box=jet-region
#+BEGIN_SRC python :return figfile :results file
  import aplpy
  from astropy.io import fits
  import matplotlib.pyplot as plt
  f = aplpy.FITSFigure("ratio-FQ672N-FQ674N-masked.fits")
  f.show_grayscale(interpolation='none', stretch='sqrt', vmin=0.42, vmax=0.8, invert=True)
  [ra0, dec0, dra, ddec], = recenter_box
  f.recenter(ra0, dec0, width=dra, height=ddec)
  f.add_colorbar()
  f.add_label(0.8, 0.9, '[S II] 6716 / 6731', relative=True, size='x-large')
  f.add_grid()
  f.grid.set_alpha(0.2)
  f.ticks.set_color('black')
  figfile = "jet_region_siiratio.pdf"
  plt.gcf().set_size_inches(12, 9)
  plt.gcf().tight_layout()
  plt.gcf().savefig(figfile)
#+END_SRC

#+RESULTS:
[[file:jet_region_siiratio.pdf]]

Now the excess emissions:

#+header: :var recenter_box=jet-region
#+BEGIN_SRC python :return figfile :results file
  import aplpy
  from astropy.io import fits
  import matplotlib.pyplot as plt
  f = aplpy.FITSFigure("scattered_continuum_045.fits")
  f.show_grayscale(interpolation='none', stretch='linear', vmin=0.5, vmax=2.7, invert=True)
  [ra0, dec0, dra, ddec], = recenter_box
  f.recenter(ra0, dec0, width=dra, height=ddec)
  f.add_colorbar()
  f.add_label(0.8, 0.9, 'Dust-scattered continuum', relative=True, size='x-large')
  f.add_grid()
  f.grid.set_alpha(0.2)
  figfile = "jet_region_scattered.pdf"
  f.ticks.set_color('black')
  plt.gcf().set_size_inches(12, 9)
  plt.gcf().tight_layout()
  plt.gcf().savefig(figfile)
#+END_SRC

#+RESULTS:
[[file:jet_region_scattered.pdf]]

#+header: :var recenter_box=jet-region
#+BEGIN_SRC python :return figfile :results file
  import aplpy
  from astropy.io import fits
  import matplotlib.pyplot as plt
  f = aplpy.FITSFigure("excess_sii_007.fits")
  f.show_grayscale(interpolation='none', stretch='linear', vmin=0.2, vmax=2.3, invert=True)
  [ra0, dec0, dra, ddec], = recenter_box
  f.recenter(ra0, dec0, width=dra, height=ddec)
  f.add_colorbar()
  f.add_label(0.8, 0.9, 'Excess [S II] (partially ionized)', relative=True, size='x-large')
  f.add_grid()
  f.grid.set_alpha(0.2)
  f.ticks.set_color('black')
  figfile = "jet_region_excess-sii.pdf"
  plt.gcf().set_size_inches(12, 9)
  plt.gcf().tight_layout()
  plt.gcf().savefig(figfile)
#+END_SRC

#+RESULTS:
[[file:jet_region_excess-sii.pdf]]

#+header: :var recenter_box=jet-region
#+BEGIN_SRC python :return figfile :results file
  import aplpy
  from astropy.io import fits
  import matplotlib.pyplot as plt
  f = aplpy.FITSFigure("excess_469_047.fits")
  f.show_grayscale(interpolation='none', stretch='linear', vmin=0.02, vmax=0.12, invert=True)
  [ra0, dec0, dra, ddec], = recenter_box
  f.recenter(ra0, dec0, width=dra, height=ddec)
  f.add_colorbar()
  f.add_label(0.5, 0.1, 'Excess F469N emission: [Fe III] + He I + blue continuum', relative=True, size='x-large')
  f.add_grid()
  f.grid.set_alpha(0.4)
  f.ticks.set_color('black')
  figfile = "jet_region_excess-feiii.pdf"
  plt.gcf().set_size_inches(12, 9)
  plt.gcf().tight_layout()
  plt.gcf().savefig(figfile)
#+END_SRC

#+RESULTS:
[[file:jet_region_excess-feiii.pdf]]




*** Applying the sweet spot
:PROPERTIES:
:ID:       4D18B76C-DA2B-4E8A-9E2F-336A793B9C35
:END:
+ For the time being we will use [[file:will-extended-sweet-spot.reg]]
+ But that elminates some interesting parts of the [N II] ratio map
  + The base of HH 528
+ So eventually I want to use a separate mask for each line ratio
  + Currently I have [[file:FQ672N-good-box.reg]]
  + [X] Need to do the others
#+BEGIN_SRC python
#+END_SRC

** Revisiting the Te, ne calculations and spatial variations
+ We want to migrate the relevant material from the ipynb files and check that it is using the correct calibration
+ How to calculate the 5755/6583 ratio from the filter 
** Applying the final calibrations of the WFC3 filters
+ For F658N/F547M, the original calibration seems to be right
+ For FQ575N/F547M, the best fit seems to be r0 = 1.1, q1 = 1.1
  + But what is actually changing there?
*** DONE [7/7] Absolute calibration of the filters
CLOSED: [2014-04-28 Mon 09:34]
+ A simpler approach would be to simply integrate the spectra over the nominal filter bandwidth and compare this with the WFC3 images
+ This would have the disadvantage that it is depends on a combination of the filter width and peak transmission, but on the other hand the r0 and q1 etc also have this problem
+ Also, we have the problem that some filters wavebands have coverage gaps in the Adal and Manu datasets - only F547M really
+ So we actually don't need any of the line fitting at all
**** DONE [3/3] Getting the normalizations right
CLOSED: [2014-04-25 Fri 12:05]
+ Summary:
  + Orion absolute photometry is good to within 20%
  + Ring is pverestimated by about 60%
+ From the WFC3 images we have counts/s/pixel (I think)
  + In the XXX-calibration.py programs we take the average value in the spectrograph aperture, so the units are not changed
+ From the spectroscopy we ought to have erg/s/cm^{2}/sr/\AA
  + But we don't
    + Manu has just erg/s/cm^{2}/\AA, which is /presumably/ implicitly per fiber
      + Fiber area is pi (2.69/2.0)**2 = 5.6832 square arcsec
    + Bob has erg/s/cm^{2}/\AA, which I am assuming is per pixel: slit width = 1.9 arcsec, pixel_size = 1.3 \arcsec
    + Adal has erg/s/cm^{2}/\AA/pixel too.  His pixels are 1.2 arcsec and his slit width is 1.03 arcsec
  + Which I then multiply by 1e15
+ So in XXX-fold-filters.py I calculate \int \lambda I_{\lambda} T_{\lambda} d\lambda
  + which now has units erg \cdot \AA / s / cm^{2} / sr
+ The C_{WFC3} constant is in units count \cdot cm^{2} \cdot sr / erg / \AA
+ So I just have to take C_{WFC3} \int \lambda I_{\lambda} T_{\lambda} d\lambda to get to count/s
+ [X] The problem is that I am a factor of 4 adrift
  + The factor is the same with all 3 Orion datasets, suggesting that it is either a problem with the WFC3 images, or an error in the calculation of the conversion.
  + Slightly different with the Ring spectra - more like a factor of 6
+ [X] I should check out the photometry kwds in the FITS header
  + Orion images
    + Example of F658N
      + Header values
        + GAIN = 1.5 elec
        + PHOTFLAM = 9.789e-18 erg/cm2/Ang/electron
        + PHOTBW = 148.97 Ang
      + Updated values
        + PHOTFLAM = 9.7358e-18 erg/cm2/Ang/electron
        + PHOTBW = 147.88
      + Or for 0.4'' aperture
        + PHOTFLAM = 1.07193e-17
        + PHOTBW = 147.88
        + This takes into account that only 91% of total energy is encircled in a 0.4'' radius aperture, but that is not relevant to us
      + The updated values are from http://www.stsci.edu/hst/wfc3/phot_zp_lbn
    + FQ575N
      + Header values
        + PHOTFLAM = 1.8167775E-17
        + PHOTBW = 4.2453072E+01
+ [X] I should compare with some 3rd party measurements
  + Esteban for Orion? Or Baldwin?
  + Manchado for the Ring Nebula
    + They give a dereddened H\beta flux for each of the regions
      + With C(H\beta) = 0.14 everywhere = 1.38 times increase in F(H\beta)
    + Units are erg/cm^{2}/s/\AA, presumably in one 0.96 x 1.2 arcsec pixel
***** Provenance of the throughput tables
+ The tables I have are the same as the ones recommended in the instrument handbook
  + http://www.stsci.edu/hst/wfc3/ins_performance/throughputs/Throughput_Tables
  + Except that those ones are not complete (no quad filters that I can find)
***** DONE The issue of the gain
CLOSED: [2014-04-24 Thu 19:45]
+ This is 1.5 for WFC3
+ It seems that the images are in electrons, not in ADU
+ [X] So we should multiply all our measured rates by 1.5?
  + *NO* - this is already included in the transmission curves
***** DONE Use pysynphot to double-check my normalizations
CLOSED: [2014-04-24 Thu 19:45]
+ Initial tests in [[file:pysynphot-explore.org][this]] separate org file
  + pysynphot requires python 2.7
+ Full-scale test done in [[file:odh-synphot.py]]
  + Works perfectly - agrees with previous method to within about 1%
  + Turns out that the gain is *included* in the transmission curves
***** DONE The area factor
CLOSED: [2014-04-21 Mon 22:07]
It seems that the fraction of the mirror circular area that is blocked by the secondary is included in the transmission factors, so it /should not be included in the area/

Relevant quote from A.2.1 of Instrument Handbook

: The first figure for each filter gives the integrated system throughput based on on-orbit observations of spectrophotometric standards. This is the combination of the efficiencies of the detector and of the optical elements in the light path. The throughput is defined as the number of detected counts/second/cm2 of telescope area relative to the incident flux in photons/cm2/s. For both the UVIS and IR channels, “counts” is the number of electrons detected. In both channels the detected counts obey Poisson statistics, except that at short wavelengths in the UVIS channel, a single incoming photon has a finite chance of producing multiple electrons in the CCD. Section 5.4.2 describes this phenomenon, which was measured to have a much smaller effect in the UVIS detectors compared to theoretical predictions. The plots in this appendix have been corrected to remove multiple electrons generated by UV photons, using a correction that is intermediate between the theoretical and measured UVIS “quantum yields.” The throughput includes all obscuration effects in the optical train (e.g., due to the HST secondary).

Note in particular the final sentence.


***** Comments on possible shifts from the instrument handbook 
: All measurements of the UVIS filters which involve wavelengths, as tabulated in Table 6.2 and plotted in Figures 6.3 through 6.6 and in Appendix A:WFC3 Filter Throughputs, were done in air. The data have been converted to vacuum wavelengths using the formula given by D. C. Morton (1991, ApJS 77, 119). It should also be noted that the laboratory measurements were done at a temperature of 20°C, whereas the UVIS filters are operated on orbit at 0°C. The temperature difference may lead to wavelength shifts that are no more than 0.14 nm in the worst cases, according to the filter manufacturing specifications.

***** DONE Vacuum versus air wavelengths
CLOSED: [2014-04-21 Mon 22:48]
+ Instrument Handbook says that all the filters are in vacuum wavelengths
+ Refractive index of air at STP 1.000277 according to Wikipedia
+ This is equivalent to a shift of 83 km/s or 1.8 Ang at H alpha, so it might not make much difference.
  + It is about 10% of the width of the narrow filters
  + The vacuum wavelengths are longer
***** DONE Why are the PHOTBW values so strange?
CLOSED: [2014-04-21 Mon 20:06]
+ Mystery solved
  + It turns out to be a bizarre definition of width
  + See Table 5.1 of http://stsdas.stsci.edu/stsci_python_epydoc/SynphotManual.pdf
  + This was simplified in pysynphot,
    + They now use the standard RMS width 
    + but it is not clear which of these was used in the headers
  + Whichever it was, it is not useful to us at all really
+ Comparison of some filters
| Name  | Description    | Pivot λp (nm) | Width (nm) | Peak T | PHOTBW |       |
| 1     | 2              |             3 |          4 |        |        |       |
|-------+----------------+---------------+------------+--------+--------+-------|
| F218W | ISM feature    |         222.4 |       32.2 |   0.05 | 129.14 | 2.493 |
| F225W | UV wide        |         235.9 |       46.7 |   0.10 | 177.54 | 2.630 |
| F275W | UV wide        |         270.4 |       39.8 |   0.13 | 164.51 | 2.419 |
| F336W | U, Strömgren u |         335.5 |       51.1 |   0.20 | 158.44 | 3.225 |
| F390W | Washington C   |         392.1 |       89.6 |   0.25 | 291.22 | 3.077 |
| F438W | WFPC2 B        |         432.5 |       61.8 |   0.24 | 197.30 | 3.132 |
| F475W | SDSS g′        |         477.3 |      134.4 |   0.27 | 421.23 | 3.191 |
| F555W | WFPC2 V        |         530.8 |      156.2 |   0.28 | 517.14 | 3.020 |
| F606W | WFPC2 Wide V   |         588.7 |      218.2 |   0.29 | 656.58 | 3.323 |
| F625W | SDSS r′        |         624.2 |      146.3 |   0.28 | 451.03 | 3.244 |
| F775W | SDSS i′        |         764.7 |      117.1 |   0.23 | 419.11 | 2.794 |
| F814W | WFPC2 Wide I   |         802.4 |      153.6 |   0.23 | 663.33 | 2.316 |
#+TBLFM: $7=10 $4 /$6 ; f3

**** DONE [6/6] Little tweaks to improve things
CLOSED: [2014-04-25 Fri 22:50]
+ [X] Need to mask out some Ring positions
  + Particularly for FQ672N and FQ674N
+ [X] Plate scale for Ring Nebula - need to expand it a bit, and shift the PA150
+ [X] Zero point of Adal spectra
  + and others?
  + Adal F469N - add 0.08 to spectrum?
  + We could just try to add a constant value of 2e-16
    + /Still needs work/
+ [X] Correct 5007 flux from Adal spectra
  + Use the average ratio of 5007/4959
  + This gives a factor of 1.62
+ [X] Split Manu dataset into different fields
  + there is clearly an offset between the fields
+ [X] Extend wavelength ranges for F547M calculation
  + Particularly for Adal
  + Strangely, it seems OK already for Manu
**** Table of gradients
These should all be 1, but they ain't ...
|        |  ODH | Manu | Adal | Ring | ODH' | Manu' | Adal' | Ring' | Average'      |   | Ring |
|--------+------+------+------+------+------+-------+-------+-------+---------------+---+------|
| F658N  | 0.73 | 0.89 | 0.83 | 0.55 | 0.90 |  1.02 |  0.90 |  1.08 | 0.98 +/- 0.05 | ? | 0.99 |
| F656N  | 0.92 | 0.95 | 0.93 | 0.58 | 1.14 |  1.09 |  1.01 |  1.14 | 1.10 +/- 0.03 | * | 1.02 |
| F673N  | 0.80 | 0.73 | 0.81 | 0.58 | 0.99 |  0.84 |  0.88 |  1.14 | 0.96 +/- 0.07 |   | 1.01 |
| F502N  | 0.83 | 0.91 | 0.91 | 0.53 | 1.02 |  1.05 |  0.99 |  1.04 | 1.03 +/- 0.01 | * | 0.94 |
| F487N  | 0.81 | 0.88 | 0.86 | 0.57 | 1.00 |  1.01 |  0.93 |  1.12 | 1.02 +/- 0.04 |   | 1.01 |
| F469N  | 0.73 | 0.61 | 0.88 | 0.76 | 0.90 |  0.70 |  0.96 |  1.49 | 1.01 +/- 0.17 | ? | 1.35 |
| F547M  | 0.81 | 0.87 | 0.92 | 0.51 | 1.00 |  1.00 |  1.00 |  1.00 | 1.00          |   | 1.00 |
| FQ575N | 0.91 | 0.79 | 0.92 | 0.61 | 1.12 |  0.91 |  1.00 |  1.20 | 1.06 +/- 0.06 |   | 1.09 |
| FQ672N | 0.79 | 0.75 | 0.84 | 0.48 | 0.98 |  0.86 |  0.91 |  0.94 | 0.92 +/- 0.03 | * | 0.97 |
| FQ674N | 0.88 | 0.79 | 0.87 | 0.46 | 1.09 |  0.91 |  0.95 |  0.90 | 0.96 +/- 0.04 |   | 0.87 |
| FQ437N | 0.76 | 0.61 | 0.84 | 0.66 | 0.94 |  0.70 |  0.91 |  1.29 | 0.96 +/- 0.12 |   | 1.13 |
| FQ436N | 0.78 | 0.66 | 0.87 | 0.55 | 0.96 |  0.76 |  0.95 |  1.08 | 0.94 +/- 0.07 |   | 0.97 |
|--------+------+------+------+------+------+-------+-------+-------+---------------+---+------|
| F645N  |  nan |  nan |  nan | 0.52 |  nan |   nan |   nan |  1.02 | nan +/- nan   |   | 0.95 |
|--------+------+------+------+------+------+-------+-------+-------+---------------+---+------|
| mean   |      |      |      |      | 1.00 |  0.90 |  0.95 |  1.12 | 1.00          |   |      |
| std    |      |      |      |      | 0.08 |  0.13 |  0.04 |  0.16 | 0.10 +/- 0.03 |   |      |
#+TBLFM: $6=$2/@8$2;f2::$7=$3/@8$3;f2::$8=$4/@8$4;f2::$9=$5/@8$5;f2::$10=vmeane($6..$9);f2::@15$6..@15$10=vmean(@I..@II);f2::@16$6..@16$9=vsdev(@I..@II);f2
+ The primed columns are normalized by the F547M value
+ Manu's F547M needs sorting out - it runs off the end of the wav scale, so we are missing some flux
  + this will reduce the value from 0.87 by a bit, so that the primed values will all be higher
  + That will help the quad features, but make F658N even more anomalou
**** Lines that show a possible deviation from the nominal calibration
***** F658N
+ This has a low value with ODH and Adal - transmission 90% of predicted
+ But this is reversed in Manu and (especially) Ring
+ The Ring should really be the best quality since highest EW and minimal contamination from H\alpha or continuum
  + But 0.56 might be a better choice than 0.51 for the F547M gradient, which would put F658N just a tad below unity
+ Manu's data shows a lot of variation between fields
**** Plotting some ratios
#+BEGIN_SRC python

#+END_SRC

**** DONE Absolute fluxes from ODH spectra
CLOSED: [2014-04-18 Fri 00:30]
+ This should be even easier
+ Although I had to go back to the FITS files to extract the spectra
+ [X] Fix the positions of the slits - I don't believe that they are all centered on RA of th1C
  + These are the positions from the FITS headers
    | Slit |          RA |         Dec |
    |------+-------------+-------------|
    | S30  | 05:35:16.26 | -05:23:33.3 |
    | S60  | 05:35:16.07 | -05:24:03.2 |
    | S90  | 05:35:16.11 | -05:24:34.0 |
  + So the Dec intervals are consistent with 30'' between each slit (+/- 1 '')
  + And the RA changes by 0.19s = 2.8'', so that is not as much as I had thought
  + This is now done, based on what I found from plotting the profiles
+ Workflow:
  + [[file:odh-fold-filters.py]]
    + Reads the spectra from the original FITS files and fold with each of the filter transmission profiles.
    + We do this in sections of length 2 pixels, which is smaller than what I had used for the line fitting.  But the s/n is still acceptable, and it is much better to have more points - it made the spatial alignment easier to do
    + Normalise to counts/s/WFC3 pixel
      + /Supposedly/, although we get values that are too large by a factor of about 4 to 5
    + Writes a table [[file:odh-filter-predicted-rates.tab]] with a column for each filter
  + [[file:odh-calib-fold.py]]
    + This is a new version of [[file:odh-calibration.py]] that uses the new smaller slit sections.
    + It reads in the WFC3 images and convolves them with a gaussian to simulate seeing of 2.5 arcsec FWHM
    + Then it extracts the average count rate per pixel in the aperture corresponding to each section of the spectrograph slit
    + Writes a table [[file:odh-filter-wfc3-rates.tab]] with a column for each filter, and also a column with the offset =x0= along the slit from the slit center.
      + The slit center positions are specified in [[file:odh_common.py]].  I had to move them a bit in RA from the nominal positions (centered on RA of th1C). 
**** DONE Absolute fluxes from Ring spectra
CLOSED: [2014-04-19 Sat 14:02]
:LOGBOOK:
CLOCK: [2014-04-19 Sat 09:07]--[2014-04-19 Sat 11:21] =>  2:14
:END:
+ This time I am not going to mess with changing the apertures
+ We already have [[file:~/Work/RingNebula/WFC3/2013-Geometry/ring-calibration.py][ring-calibration.py]], which writes the WFC3 aperture rates to [[file:~/Work/RingNebula/WFC3/2013-Geometry/ring_calibration_db.tab][ring_calibration_db.tab]]
  + This reads the sections from [[file:~/Work/RingNebula/WFC3/2013-Geometry/Spectra/spectral_fit_fine_db.json][Spectra/spectral_fit_fine_db.json]]
+ So I just need to write [[file:ring-fold-filters.py]]
  + Problem is that the json file only has x1, x2 - not j1, j2
  + But we just have to use the same conversion as in [[file:~/Work/RingNebula/WFC3/2013-Geometry/ring-photom-fine.py][ring-photom-fine.py]]

**** DONE Absolute fluxes from Adal spectra
CLOSED: [2014-04-18 Fri 23:21]
+ This should not be too difficult since we already did it once in the [[file:Adal%20spectra.ipynb][ipython notebook]]
+ Follow similar pattern as for ODH dataset:
  + [[file:adal-fold-filters.py]]
    + Use each pixel along the slit as a section
  + [[file:adal-calib-fold.py]]

**** DONE Absolute fluxes from Manu spectra
CLOSED: [2014-04-18 Fri 00:29]
+ Calculated by [[file:manu-fold-filters.py][file:~/Work/RubinWFC3/Tsquared/manu-fold-filters.py]]
+ Results in [[file:manu-filter-fluxes.tab][file:~/Work/RubinWFC3/Tsquared/manu-filter-fluxes.tab]]
+ [X] Need to check that we haven't subtracted the continuum
**** DONE Plot the results
CLOSED: [2014-04-28 Mon 09:34]
***** Common functionality

#+name: aesthetics
#+BEGIN_SRC python
bgcolor = "#c0c0c0" # light gray
cmap = plt.cm.get_cmap('hot')
#+END_SRC

#+name: read-manu-data
#+BEGIN_SRC python
  spectab = Table.read('manu-filter-predicted-rates.tab', format='ascii.tab')
  wfc3tab = Table.read('manu_calibration_db.tab', format='ascii.tab',
                       fill_values=('nan', np.nan))

  fulltab = astropy.table.join(spectab, wfc3tab, keys=['Section', 'x', 'y'],
                               table_names=['s', 'w'], join_type='outer')

#+END_SRC

#+name: sweetspot-function
#+BEGIN_SRC python :tangle sweetspot_utils.py
  import numpy as np

  def find_sweetspot_mask(fn, x, y):
      """Create a mask for Bob's so-called sweet spot"""
      sweetmask = np.ones_like(x).astype(bool)
      if 'Q' in fn.upper():
          # Common boundaries for all the quad filters
          theta = np.radians(56.0)
          s = -x*np.cos(theta) + y*np.sin(theta)
          sweetmask[s > 10.0] = False
          sweetmask[s < -70.0] = False
          theta = np.radians(-34.0)
          s = -x*np.cos(theta) + y*np.sin(theta)
          sweetmask[s > 82.0] = False
          sweetmask[s < 40.0] = False
      if fn.upper() in ['FQ672N', 'FQ674N']:
          # extra cut-off for [S II] filters
           sweetmask[x > -30.0] = False
      if fn.upper() in ['FQ575N', 'FQ436N']:
          # extra cut-off for [N II] and [O III] filters
          sweetmask[x < -75.0] = False

      return sweetmask
#+END_SRC
***** Maps of the ODH slits and the Manu fibers compared with WFC3
+ This now includes inset graphs showing the slit profiles
+ Result is that *all* the slits need to be shifted in x, from 7 to 10 arcsec
+ Shifts in y are less clear, so we won't do those
+ [X] Now we need to go back and re-run the odh programs, taking into account the shifts
  + Also increase the seeing width to 2.5 arcsec

#+name: manu-map-comparison
#+header: :var fn="FQ575N" :var band="red" :var maxmeds=4.0
#+BEGIN_SRC python :noweb yes :results file 
  import numpy as np
  from astropy.table import Table
  import astropy.table
  from matplotlib import pyplot as plt
  from sweetspot_utils import find_sweetspot_mask
  from odh_common import slit_center, PA
  import coord_utils

  <<read-manu-data>>  

  spectab = Table.read('odh-filter-predicted-rates.tab', format='ascii.tab')
  wfc3tab = Table.read('odh-filter-wfc3-rates.tab', format='ascii.tab',
                       fill_values=('nan', np.nan))
  odhtab = astropy.table.join(spectab, wfc3tab, keys=['Section'],
                               table_names=['s', 'w'])


  spectab = Table.read('adal-filter-predicted-rates.tab', format='ascii.tab')
  wfc3tab = Table.read('adal-filter-wfc3-rates.tab', format='ascii.tab',
                       fill_values=('--', np.nan))

  adaltab = astropy.table.join(spectab, wfc3tab, keys=['Section'],
                               table_names=['s', 'w'])


  # Make an adjustment to the absolute calibrations
  fulltab[fn+'_s'] *= 0.87
  odhtab[fn+'_s'] *= 0.81
  adaltab[fn+'_s'] *= 0.92

  x = fulltab['x']
  y = fulltab['y']
  m = np.array([sec[:-10] == band for sec in fulltab['Section']])
  m = m & np.isfinite(x) & np.isfinite(y) 
  m = m & np.isfinite(fulltab[fn + '_w']) & np.isfinite(fulltab[fn + '_s'])
  m = m & find_sweetspot_mask(fn, x, y) 
  flux = fulltab[fn + '_s'][m]
  fmax = maxmeds*np.median(flux)
  xmin, xmax = x[m].min(), x[m].max()

  # coordinates for ODH slits
  yy = np.array([-float(s[1:3]) for s in odhtab['Section']])
  xx = np.empty_like(yy)
  for slitid, yslit in [['S30', -30.0], ['S60', -60.0], ['S90', -90.0]]:
      # Fill in RA offsets from th1C for each slit in turn.  We cannot
      # just use the 'x0' column unchanged, since it is measured from
      # the center of the slit, which now varies
      mms = (yy == yslit)
      xx[mms], _ = coord_utils.radec_offsets_from_slitx(odhtab['x0'][mms], slit_center[slitid], PA=PA)
  mm = np.isfinite(yy) & find_sweetspot_mask(fn, xx, yy) 
  odh_flux = odhtab[fn + '_s'][mm]

  # coordinates from Adal slits
  xxx = adaltab['dRA']
  yyy = adaltab['dDEC']
  mmm = np.isfinite(xxx) & np.isfinite(yyy)
  mmm = mmm & find_sweetspot_mask(fn, xxx, yyy)
  aband = band
  if band == 'green':
      aband = 'red' if fn == 'F547M' else 'blue'
  mmm = mmm & np.array([aband in s for s in adaltab['Section']])
  adal_flux = adaltab[fn + '_s'][mmm]
  
  fig = plt.figure(figsize=(16,8))
  <<aesthetics>>
  ax_spec = plt.axes([0.06, 0.35, 0.25, 0.6], axisbg=bgcolor)
  ax_wfc3 = plt.axes([0.36, 0.35, 0.25, 0.6], sharex=ax_spec, sharey=ax_spec, axisbg=bgcolor)
  # ax_cb = plt.axes([0.56, 0.35, 0.02, 0.65])
  
  ax_spec.scatter(xx[mm], yy[mm], c=odh_flux, vmin=0.0, vmax=fmax, s=50, alpha=0.6, marker='s', cmap=cmap)
  ax_spec.scatter(xxx[mmm], yyy[mmm], c=adal_flux, vmin=0.0, vmax=fmax, s=50, alpha=0.6, marker='>', cmap=cmap)
  scat0 = ax_spec.scatter(x[m], y[m], c=flux, vmin=0.0, vmax=fmax, s=50, alpha=0.6, edgecolors='none', cmap=cmap)
  ax_spec.set_title('Slit and IFU Spectra: ' + fn)
  # fig.colorbar(scat0, ax=ax_spec)
  flux = fulltab[fn + '_w'][m]
  # fmax = maxmeds*np.median(flux)
  odh_flux = odhtab[fn + '_w'][mm]
  adal_flux = adaltab[fn + '_w'][mmm]
  scat1 = ax_wfc3.scatter(xx[mm], yy[mm], c=odh_flux, vmin=0.0, vmax=fmax, s=50, alpha=0.6, marker='s', cmap=cmap)
  ax_wfc3.scatter(xxx[mmm], yyy[mmm], c=adal_flux, vmin=0.0, vmax=fmax, s=50, alpha=0.6, marker='>', cmap=cmap)
  ax_wfc3.scatter(x[m], y[m], c=flux, vmin=0.0, vmax=fmax, s=50, alpha=0.6, edgecolors='none', cmap=cmap)
  ax_wfc3.set_title('Interpolated/smoothed WFC3 Images: ' + fn)
  plt.setp(ax_wfc3.get_yticklabels(), visible=False)
  cb = fig.colorbar(scat1, ax=[ax_spec, ax_wfc3], fraction=0.1, aspect=40, orientation='horizontal')
  cb.set_label('WFC3 count rate, e-/s/pixel')
  ax_spec.set_xlabel('RA offset from th1, arcsec', fontsize='small')
  ax_spec.set_ylabel('DEC offset from th1C, arcsec', fontsize='small')
  ax_spec.grid()
  ax_wfc3.grid()

  # inset plots with the S30, S60, S90 profiles
  for yslit, vport in [[30.0, [0.68, 0.7, 0.25, 0.25]],
                       [60.0, [0.68, 0.375, 0.25, 0.25]],
                       [90.0, [0.68, 0.05, 0.25, 0.25]]]:
      ax_inset = plt.axes(vport, sharex=ax_spec)
      mms = mm & (yy == -yslit)
      mf = m & (np.abs(y + yslit) <= 3.0) 
      ax_inset.plot(xx[mms],  odhtab[fn + '_s'][mms], '.-', label='spectra')
      ax_inset.plot(xx[mms],  odhtab[fn + '_w'][mms], '.-', label='WFC3')
      ax_inset.plot(x[mf],  fulltab[fn + '_s'][mf], '.', alpha=0.4, label='fibers')
      ax_inset.plot(x[mf],  fulltab[fn + '_w'][mf], '.', alpha=0.4, label='WFC3 @ fibers')
      ax_inset.tick_params(axis='both', which='major', labelsize='xx-small')
      # ax_inset.set_ylim(0.0, maxmeds*np.median(odhtab[fn + '_s'][mms]))
      ax_inset.set_ylim(0.0, fmax)
      ax_inset.grid()
      ax_inset.set_title('O\'Dell & Harris Slit S{:.0f} Profiles'.format(yslit), fontsize='x-small')
      ax_inset.legend(fontsize='x-small')
      ax_inset.set_xlabel('RA offset from th1, arcsec', fontsize='x-small')

  # inset plots with the Adal profiles
  for islit, vport in [[5, [0.06, 0.05, 0.25, 0.25]],
                       [6, [0.36, 0.05, 0.25, 0.25]]]:
      ax_inset = plt.axes(vport, sharex=ax_spec)
      mmms = mmm & np.array([int(s[1]) == islit for s in adaltab['Section']])
      ax_inset.plot(xxx[mmms],  adaltab[fn + '_s'][mmms], '.-', label='spectra')
      ax_inset.plot(xxx[mmms],  adaltab[fn + '_w'][mmms], '.-', label='WFC3')
      # ax_inset.plot(x[mf],  fulltab[fn + '_s'][mf], '.', alpha=0.2, label='fibers')
      # ax_inset.plot(x[mf],  4*fulltab[fn + '_w'][mf], '.', alpha=0.2, label='WFC3 @ fibers')
      ax_inset.tick_params(axis='both', which='major', labelsize='xx-small')
      # ax_inset.set_ylim(0.0, maxmeds*np.median(adaltab[fn + '_s'][mmms]))
      ax_inset.set_ylim(0.0, fmax)
      ax_inset.grid()
      ax_inset.set_title('Mesa Delgado Slit {:.0f} Profiles'.format(islit), fontsize='x-small')
      ax_inset.legend(fontsize='x-small')
      ax_inset.set_xlabel('RA offset from th1, arcsec', fontsize='x-small')

  ax_spec.set_xlim(-10.0, -100.0)
  ax_spec.set_ylim(-100.0, 0.0)
  ax_spec.set_aspect('equal', adjustable='box-forced')
  ax_wfc3.set_aspect('equal', adjustable='box-forced')
  # ax_spec.axis('equal')
  pltfile = 'manu-{}-{}-maps.pdf'.format(fn, band)
  # fig.tight_layout()
  fig.savefig(pltfile)
  return pltfile
#+END_SRC

#+RESULTS: manu-map-comparison
[[file:manu-FQ575N-red-maps.pdf]]

#+call: manu-map-comparison(fn="F502N", band="green", maxmeds=2.5) :results file

#+RESULTS:
[[file:manu-F502N-green-maps.pdf]]

#+call: manu-map-comparison(fn="F658N", band="red") :results file

#+RESULTS:
[[file:manu-F658N-red-maps.pdf]]

#+call: manu-map-comparison(fn="F656N", band="red", maxmeds=2.8) :results file

#+RESULTS:
[[file:manu-F656N-red-maps.pdf]]

#+call: manu-map-comparison(fn="F547M", band="green", maxmeds=3.0) :results file

#+RESULTS:
[[file:manu-F547M-green-maps.pdf]]

#+call: manu-map-comparison(fn="F547M", band="red") :results file

#+RESULTS:
[[file:manu-F547M-red-maps.pdf]]

#+call: manu-map-comparison(fn="F673N", band="red", maxmeds=2.5) :results file

#+RESULTS:
[[file:manu-F673N-red-maps.pdf]]

#+call: manu-map-comparison(fn="F487N", band="green", maxmeds=2.5) :results file

#+RESULTS:
[[file:manu-F487N-green-maps.pdf]]

#+call: manu-map-comparison(fn="F487N", band="blue") :results file

#+RESULTS:
[[file:manu-F487N-blue-maps.pdf]]

Note that there are some blue fibers that are drop-outs in the F487N filter.  Presumably, this is what Manu warned me about concerning lines at the end of the ranges. 

#+call: manu-map-comparison(fn="F469N", band="blue", maxmeds=2.5) :results file

#+RESULTS:
[[file:manu-F469N-blue-maps.pdf]]

#+call: manu-map-comparison(fn="F469N", band="green", maxmeds=2.5) :results file

#+RESULTS:
[[file:manu-F469N-green-maps.pdf]]

#+call: manu-map-comparison(fn="FQ437N", band="blue", maxmeds=2.0) :results file

#+RESULTS:
[[file:manu-FQ437N-blue-maps.pdf]]

#+call: manu-map-comparison(fn="FQ436N", band="blue", maxmeds=2.0) :results file

#+RESULTS:
[[file:manu-FQ436N-blue-maps.pdf]]

#+call: manu-map-comparison(fn="FQ672N", band="red", maxmeds=2.0) :results file

#+RESULTS:
[[file:manu-FQ672N-red-maps.pdf]]

#+call: manu-map-comparison(fn="FQ674N", band="red", maxmeds=2.0) :results file

#+RESULTS:
[[file:manu-FQ674N-red-maps.pdf]]

The [S II] lines show a strong peak in the S60 spectrum
***** Results for the Manu spectra
#+NAME: manu-absolute
#+HEADER: :var fn="FQ575N" :var band="red" :var maxmeds=4.0 
#+BEGIN_SRC python :results file :noweb yes
  import numpy as np
  from astropy.table import Table
  import astropy.table
  from matplotlib import pyplot as plt
  from sweetspot_utils import find_sweetspot_mask

  <<read-manu-data>>

  x = fulltab[fn + '_s']
  y = fulltab[fn + '_w']
  d = np.hypot(fulltab['x'], fulltab['y'])
  m = np.array([sec[:-10] == band for sec in fulltab['Section']])
  m = m & np.isfinite(x) & np.isfinite(y)
  m = m & (x > 0.0) & (y > 0.0)
  m = m & find_sweetspot_mask(fn, fulltab['x'], fulltab['y']) 
  m = m & ~x.mask & ~y.mask
  m = m & (y < x)
  xmax = maxmeds*np.median(x[m])
  ymax = maxmeds*np.median(y[m])
  m = m & (x < xmax) & (y < ymax)
  # m = m & (fulltab['aperture'] > 60)
  x = np.array(x)[m]
  y = np.array(y)[m]
  d = np.array(d)[m]

  pointing = fulltab['pointing'][m]
  pset = set(pointing)
  pmin = pointing.min()
  pmax = pointing.max()
  ncols = pmax - pmin + 1
  # cmap = plt.cm.get_cmap('Dark2_r', ncols)
  cmap = plt.cm.get_cmap('Accent_r', ncols)
  gradient = y.sum()/x.sum()
  order = np.random.permutation(len(x))
  plt.scatter(x[order], y[order], c=fulltab['pointing'][m][order], vmin=pmin-0.5, vmax=pmax+0.5, cmap=cmap, alpha=0.8, edgecolor=None, linewidths=0.1, s=10)
  plt.colorbar(label='Field number')
  # plt.text(0.2, 0.25, str(pset))
  plt.plot([0.0, x.max()], [0.0, gradient*x.max()], '-', zorder=-10,
           label="gradient: {:.2f}".format(gradient))
  plt.xlim(0.0, xmax)
  plt.ylim(0.0, ymax)
  plt.xlabel("Manu spectra predicted count rate per pixel / s$^{-1}$")
  plt.ylabel("WFC3 image count rate per pixel / s$^{-1}$")
  plt.title('{} - {} band'.format(fn, band))
  plt.legend()
  plt.tight_layout()
  pltfile = 'manu-{}-{}-absolute.pdf'.format(fn, band)
  plt.savefig(pltfile)
  return pltfile

#+END_SRC

#+RESULTS: manu-absolute
[[file:manu-FQ575N-red-absolute.pdf]]

#+call: manu-absolute(fn="F658N", band="red") :results file

#+RESULTS:
[[file:manu-F658N-red-absolute.pdf]]


#+call: manu-absolute(fn="F656N", band="red", maxmeds=2.5) :results file

#+RESULTS:
[[file:manu-F656N-red-absolute.pdf]]

#+call: manu-absolute(fn="F502N", band="green", maxmeds=3.5) :results file

#+RESULTS:
[[file:manu-F502N-green-absolute.pdf]]

#+call: manu-absolute(fn="F487N", band="green", maxmeds=3.5) :results file

#+RESULTS:
[[file:manu-F487N-green-absolute.pdf]]

#+call: manu-absolute(fn="F487N", band="blue", maxmeds=3.5) :results file

#+RESULTS:
[[file:manu-F487N-blue-absolute.pdf]]

#+call: manu-absolute(fn="F547M", band="green", maxmeds=2.5) :results file

#+RESULTS:
[[file:manu-F547M-green-absolute.pdf]]

#+call: manu-absolute(fn="F547M", band="red", maxmeds=2.5) :results file

#+RESULTS:
[[file:manu-F547M-red-absolute.pdf]]

#+call: manu-absolute(fn="F673N", band="red", maxmeds=3.0) :results file

#+RESULTS:
[[file:manu-F673N-red-absolute.pdf]]

#+call: manu-absolute(fn="FQ672N", band="red", maxmeds=3.0) :results file

#+RESULTS:
[[file:manu-FQ672N-red-absolute.pdf]]

#+call: manu-absolute(fn="FQ674N", band="red", maxmeds=3.0) :results file

#+RESULTS:
[[file:manu-FQ674N-red-absolute.pdf]]

#+call: manu-absolute(fn="FQ437N", band="blue", maxmeds=2.0) :results file

#+RESULTS:
[[file:manu-FQ437N-blue-absolute.pdf]]

#+call: manu-absolute(fn="FQ436N", band="blue", maxmeds=2.0) :results file

#+RESULTS:
[[file:manu-FQ436N-blue-absolute.pdf]]

#+call: manu-absolute(fn="F469N", band="blue", maxmeds=2.0) :results file

#+RESULTS:
[[file:manu-F469N-blue-absolute.pdf]]

#+call: manu-absolute(fn="F469N", band="green", maxmeds=2.0) :results file

#+RESULTS:
[[file:manu-F469N-green-absolute.pdf]]
***** Results for the Adal spectra


#+name: adal-absolute
#+header: :var fn="F656N" band="red" maxcount=1000.0 norm=0.92 offset=0.0
#+BEGIN_SRC python :noweb yes :results file 
  import numpy as np
  from astropy.table import Table
  import astropy.table
  from matplotlib import pyplot as plt
  from matplotlib.ticker import MaxNLocator
  from sweetspot_utils import find_sweetspot_mask

  <<aesthetics>>

  spectab = Table.read('adal-filter-predicted-rates.tab', format='ascii.tab')
  wfc3tab = Table.read('adal-filter-wfc3-rates.tab', format='ascii.tab',
                       fill_values=('--', np.nan))

  fulltab = astropy.table.join(spectab, wfc3tab, keys=['Section'],
                               table_names=['s', 'w'])

  slitx = fulltab['x0_s']
  islit = np.array([int(s[1]) for s in fulltab['Section']])

  d = np.hypot(fulltab['dRA'], fulltab['dDEC'])

  x = (fulltab[fn + '_s'] - offset)*norm
  y = fulltab[fn + '_w']
  m = np.isfinite(x) & np.isfinite(y)
  m = m & find_sweetspot_mask(fn, fulltab['dRA'], fulltab['dDEC']) 
  m = m & np.array([band in s for s in fulltab['Section']])
  # Eliminate some spurious points
  m = m & (y < 4*x) & (x < maxcount)
  gradient = y[m].sum()/x[m].sum()
  order = np.random.permutation(len(x[m]))
  fig, ax = plt.subplots(1, 1, subplot_kw=dict(axisbg=bgcolor))
  scat = ax.scatter(x[m][order], y[m][order], c=d[m][order], s=100.0/(islit[m][order]-4), vmin=0.0, vmax=150.0, alpha=0.8, cmap=cmap)
  cb = fig.colorbar(scat, ax=ax)
  cb.set_label('Radius, arcsec')
  ax.plot([0.0, x[m].max()], [0.0, gradient*x[m].max()], '--',
           label="gradient: {:.2f}".format(gradient))
  ax.plot([0.0, x[m].max()], [0.0, x[m].max()], '-',
           label="gradient: {:.2f}".format(1.0))
  ax.set_xlabel("Adal spectra predicted count rate per pixel / s$^{-1}$")
  ax.set_ylabel("WFC3 image count rate per pixel / s$^{-1}$")
  ax.set_title(fn)
  plotmax = 1.1*max(x[m].max(), y[m].max())
  ax.set_xlim(0.0, plotmax)
  ax.set_ylim(0.0, plotmax)
  ax.xaxis.set_major_locator(MaxNLocator(nbins=8, prune='lower'))
  ax.yaxis.set_major_locator(MaxNLocator(nbins=8, prune='lower'))
  ax.legend(loc='upper left')
  ax.set_aspect('equal', adjustable='box')
  ax.grid(ls='-', c='w', alpha=0.3)
  ax.set_axisbelow(True)
  plt.tight_layout()
  pltfile = 'adal-{}-absolute.pdf'.format(fn)
  plt.savefig(pltfile)
  return pltfile
#+END_SRC

#+RESULTS: adal-absolute
[[file:adal-F656N-absolute.pdf]]


#+call: adal-absolute("F502N", "blue") :results file 
#+results:
[[file:adal-F502N-absolute.pdf]]

#+call: adal-absolute("FQ575N", "red") :results file 

#+RESULTS:
[[file:adal-FQ575N-absolute.pdf]]

#+call: adal-absolute("F658N", "red") :results file 

#+RESULTS:
[[file:adal-F658N-absolute.pdf]]

#+call: adal-absolute("F673N", "red", maxcount=2.5) :results file 

#+RESULTS:
[[file:adal-F673N-absolute.pdf]]

#+call: adal-absolute("F469N", "blue", maxcount=0.25) :results file 

#+RESULTS:
[[file:adal-F469N-absolute.pdf]]

#+call: adal-absolute("F487N", "blue") :results file 

#+RESULTS:
[[file:adal-F487N-absolute.pdf]]

#+call: adal-absolute("F547M", "red", maxcount=6) :results file 

#+RESULTS:
[[file:adal-F547M-absolute.pdf]]

#+call: adal-absolute("FQ437N", "blue") :results file 

#+RESULTS:
[[file:adal-FQ437N-absolute.pdf]]

#+call: adal-absolute("FQ436N", "blue") :results file 

#+RESULTS:
[[file:adal-FQ436N-absolute.pdf]]

#+call: adal-absolute("FQ672N", "red") :results file 

#+RESULTS:
[[file:adal-FQ672N-absolute.pdf]]

#+call: adal-absolute("FQ674N", "red") :results file 

#+RESULTS:
[[file:adal-FQ674N-absolute.pdf]]

# #+header: :results output
#+name: adal-profile-test
#+header: :results file
#+header: :var band="red" :var islit=6 :var floor=0.0 :var fudge=4.0
#+BEGIN_SRC python :var fn="F658N" 
  import numpy as np
  from astropy.table import Table
  import astropy.table
  from matplotlib import pyplot as plt
  from sweetspot_utils import find_sweetspot_mask

  spectab = Table.read('adal-filter-predicted-rates.tab', format='ascii.tab')
  wfc3tab = Table.read('adal-filter-wfc3-rates.tab', format='ascii.tab',
                       fill_values=('--', np.nan))

  fulltab = astropy.table.join(spectab, wfc3tab, keys=['Section'],
                               table_names=['s', 'w'], join_type='outer')
  m = np.array([int(s[1]) == islit for s in fulltab['Section']])
  m = m & find_sweetspot_mask(fn, fulltab['dRA'], fulltab['dDEC']) 
  m = m & (fulltab[fn+'_w'] < fulltab[fn+'_s']) 
  plt.plot(fulltab['x0_s'][m], fulltab[fn+'_s'][m] + floor, 'o', label='spectrum')
  plt.plot(fulltab['x0_w'][m], fudge*fulltab[fn+'_w'][m], 'r', label='WFC3')
  plt.ylim(0.0, 5.0*np.median(fulltab[fn+'_s'][m] + floor))
  plt.grid()
  plt.legend()
  pltfile = 'adal-profile-s{}-{}-{}.pdf'.format(islit, fn, band)
  plt.savefig(pltfile)
  return pltfile
#+END_SRC

#+RESULTS: adal-profile-test
[[file:adal-profile-s6-F658N-red.pdf]]

#+call: adal-profile-test(islit=5) :results file

#+RESULTS:
[[file:adal-profile-s5-F658N-red.pdf]]

#+call: adal-profile-test(fn="F502N", band="blue", islit=5, fudge=2.2) :results file

#+RESULTS:
[[file:adal-profile-s5-F502N-blue.pdf]]

#+call: adal-profile-test(fn="F502N", band="blue", islit=6, fudge=2.2) :results file

#+RESULTS:
[[file:adal-profile-s6-F502N-blue.pdf]]

#+call: adal-profile-test(fn="FQ575N", band="red", islit=5) :results file

#+RESULTS:
[[file:adal-profile-s5-FQ575N-red.pdf]]

#+call: adal-profile-test(fn="FQ575N", band="red", islit=6) :results file

#+RESULTS:
[[file:adal-profile-s6-FQ575N-red.pdf]]

#+call: adal-profile-test(fn="F547M", band="red", islit=6, fudge=2.4, floor=0.5) :results file

#+RESULTS:
[[file:adal-profile-s6-F547M-red.pdf]]

#+call: adal-profile-test(fn="F547M", band="red", islit=5, fudge=2.4, floor=0.5) :results file

#+RESULTS:
[[file:adal-profile-s5-F547M-red.pdf]]

#+call: adal-profile-test(fn="F673N", band="red", islit=6) :results file

#+RESULTS:
[[file:adal-profile-s6-F673N-red.pdf]]


The next ones have problems with the zero level, but it is unclear whether this is in the spectra or in the images

#+call: adal-profile-test(fn="F469N", band="blue", islit=6, floor=0.15) :results file

#+RESULTS:
[[file:adal-profile-s6-F469N-blue.pdf]]

#+call: adal-profile-test(fn="FQ437N", band="blue", islit=6, floor=0.15) :results file

#+RESULTS:
[[file:adal-profile-s6-FQ437N-blue.pdf]]

#+call: adal-profile-test(fn="FQ437N", band="blue", islit=5, floor=0.17) :results file

#+RESULTS:
[[file:adal-profile-s5-FQ437N-blue.pdf]]

#+call: adal-profile-test(fn="FQ672N", band="red", islit=5) :results file

#+RESULTS:
[[file:adal-profile-s5-FQ672N-red.pdf]]

#+call: adal-profile-test(fn="FQ674N", band="red", islit=5) :results file

#+RESULTS:
[[file:adal-profile-s5-FQ674N-red.pdf]]

#+call: adal-profile-test(fn="FQ672N", band="red", islit=6) :results file

#+RESULTS:
[[file:adal-profile-s6-FQ672N-red.pdf]]

#+call: adal-profile-test(fn="FQ674N", band="red", islit=6) :results file

#+RESULTS:
[[file:adal-profile-s6-FQ674N-red.pdf]]

***** Results for the Ring spectra
:LOGBOOK:
CLOCK: [2014-04-19 Sat 14:05]--[2014-04-19 Sat 15:05] =>  1:00
:END:

****** Ring correlation graph
#+name: empty-ranges
|  60 | 0.0 | 0.0 |
| 150 | 0.0 | 0.0 |

#+name: range-test
#+BEGIN_SRC python :var exclude=empty-ranges :results verbatim :return d
d = {k: (x1, x2) for k, x1, x2 in exclude}
#+END_SRC

#+RESULTS: range-test
: {60: (0.0, 0.0), 150: (0.0, 0.0)}

#+name: ring-absolute
#+header: :var fn="F656N" brightmax=1000.0 offset=0.0 exclude=empty-ranges norm=0.35
#+BEGIN_SRC python :noweb yes :results file 
  import numpy as np
  from pathlib import Path
  from astropy.table import Table
  import astropy.table
  from matplotlib import pyplot as plt
  from matplotlib.ticker import MaxNLocator
  from sweetspot_utils import find_sweetspot_mask

  <<aesthetics>>
  root_dir = Path.cwd().parent.parent
  data_dir = root_dir/"RingNebula"/"WFC3"/"2013-Geometry"

  spectab = Table.read('ring-filter-predicted-rates.tab', format='ascii.tab')
  wfc3tab = Table.read(str(data_dir/'ring_calibration_db.tab'),
                       format='ascii.tab',
                       fill_values=('--', 0.0))

  fulltab = astropy.table.join(spectab, wfc3tab, keys=['Section', 'PA'],
                               table_names=['s', 'w'])

  d = np.abs(fulltab['x0_w'])

  x = (fulltab[fn + '_s'] - offset)*norm
  y = fulltab[fn + '_w']

  m = np.isfinite(x) & np.isfinite(y) & (x < brightmax) & (x > 0.0) & (y > 0.0)
  for pa, x1, x2 in exclude:
      excluded = (pa == fulltab['PA']) & (fulltab['x0_w'] >= x1) & (fulltab['x0_w'] <= x2)
      m = m & ~excluded
      
  gradient = y[m].sum()/x[m].sum()
  order = np.random.permutation(len(x[m]))
  fig, ax = plt.subplots(1, 1, subplot_kw=dict(axisbg=bgcolor))
  scat = ax.scatter(x[m][order], y[m][order], c=d[m][order], s=fulltab['PA'][m][order], vmin=0.0, alpha=0.8, cmap=cmap)
  cb = fig.colorbar(scat, ax=ax)
  cb.set_label('Radius, arcsec')
  ax.plot([0.0, x[m].max()], [0.0, gradient*x[m].max()], '--',
           label="gradient: {:.2f}".format(gradient))
  ax.plot([0.0, x[m].max()], [0.0, x[m].max()], '-',
           label="gradient: {:.2f}".format(1.0))
  ax.set_xlabel("Ring spectra predicted count rate per pixel / s$^{-1}$")
  ax.set_ylabel("WFC3 image count rate per pixel / s$^{-1}$")
  ax.set_title(fn)
  plotmax = 1.1*max(x[m].max(), y[m].max())
  ax.set_xlim(0.0, plotmax)
  ax.set_ylim(0.0, plotmax)
  # Omit number from 0.0 tick on both axes
  ax.xaxis.set_major_locator(MaxNLocator(nbins=8, prune='lower'))
  ax.yaxis.set_major_locator(MaxNLocator(nbins=8, prune='lower'))
  ax.legend(loc='upper left')
  ax.set_aspect('equal', adjustable='box')
  ax.grid(ls='-', c='w', alpha=0.3)
  ax.set_axisbelow(True)
  pltfile = 'ring-{}-absolute.pdf'.format(fn)
  fig.tight_layout()
  fig.savefig(pltfile)
  return pltfile

#+END_SRC

#+RESULTS: ring-absolute
[[file:ring-F656N-absolute.pdf]]


****** Ring profiles
#+name: ring-profile-test
#+header: :results file
#+header: :var PA=60 :var floor=0.0 fudge=0.35
#+BEGIN_SRC python :var fn="F658N" 
  import numpy as np
  from pathlib import Path
  from astropy.table import Table
  import astropy.table
  from matplotlib import pyplot as plt
  from sweetspot_utils import find_sweetspot_mask

  root_dir = Path.cwd().parent.parent
  data_dir = root_dir/"RingNebula"/"WFC3"/"2013-Geometry"

  spectab = Table.read('ring-filter-predicted-rates.tab', format='ascii.tab')
  wfc3tab = Table.read(str(data_dir/'ring_calibration_db.tab'),
                       format='ascii.tab',
                       fill_values=('--', 0.0))

  fulltab = astropy.table.join(spectab, wfc3tab, keys=['Section', 'PA'],
                               table_names=['s', 'w'])
  fulltab.sort(['PA', 'x0_w'])

  m = fulltab['PA'] == PA
  # m = m & find_sweetspot_mask(fn, fulltab['dRA'], fulltab['dDEC']) 
  # m = m & (fulltab[fn+'_w'] < fulltab[fn+'_s']) 
  plt.plot(fulltab['x0_w'][m], fudge*fulltab[fn+'_s'][m] + floor, 'o', label='spectrum')
  # xx = fulltab['x0_s'][m]*stretch + shift
  # yy = np.interp(xx, fulltab['x0_s'][m], )
  plt.plot(fulltab['x0_w'][m], fulltab[fn+'_w'][m], 'r', label='WFC3')
  plt.ylim(0.0, None)
  # plt.ylim(0.0, 5.0*np.median(fulltab[fn+'_s'][m] + floor))
  plt.grid()
  plt.legend(loc='upper left', title='Ring Nebula: PA{}'.format(PA))
  plt.xlabel("Radius, arcsec")
  plt.ylabel("{} count rate, ADU/s/pixel".format(fn))
  pltfile = 'ring-profile-pa{}-{}.pdf'.format(PA, fn)
  plt.savefig(pltfile)
  return pltfile
#+END_SRC

#+RESULTS: ring-profile-test
[[file:ring-profile-pa60-F658N.pdf]]

******* F658N Ring profiles
#+name: f658n-exclude
|  60 | -20.0 |   3.0 |
| 150 | -20.0 | -10.0 |

#+call: ring-absolute("F658N", exclude=f658n-exclude) :results file

#+RESULTS:
[[file:ring-F658N-absolute.pdf]]

#+call: ring-profile-test(fn="F658N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-F658N.pdf]]

#+call: ring-profile-test(fn="F658N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-F658N.pdf]]
******* F656N Ring profiles
#+name: f656n-exclude
|  60 | -20.0 |   3.0 |
| 150 | -20.0 | -10.0 |

#+call: ring-absolute("F656N") :results file

#+RESULTS:
[[file:ring-F656N-absolute.pdf]]

#+call: ring-profile-test(fn="F656N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-F656N.pdf]]

#+call: ring-profile-test(fn="F656N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-F656N.pdf]]
******* F673N Ring profiles
#+name: f673n-exclude
|  60 | -45.0 | -20.0 |
| 150 |   0.0 |   0.0 |

#+call: ring-absolute("F673N", exclude=f673n-exclude) :results file

#+RESULTS:
[[file:ring-F673N-absolute.pdf]]

#+call: ring-profile-test(fn="F673N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-F673N.pdf]]

#+call: ring-profile-test(fn="F673N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-F673N.pdf]]
******* FQ672N Ring profiles
#+name: fq672n-exclude
|  60 | -60.0 |   3.0 |
| 150 | -50.0 | -10.0 |

#+call: ring-absolute("FQ672N", exclude=fq672n-exclude) :results file

#+RESULTS:
[[file:ring-FQ672N-absolute.pdf]]

#+call: ring-profile-test(fn="FQ672N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-FQ672N.pdf]]

#+call: ring-profile-test(fn="FQ672N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-FQ672N.pdf]]

******* FQ674N Ring profiles
#+name: fq674n-exclude
|  60 | -60.0 |   3.0 |
| 150 | -50.0 | -10.0 |

#+call: ring-absolute("FQ674N", exclude=fq674n-exclude) :results file

#+RESULTS:
[[file:ring-FQ674N-absolute.pdf]]

#+call: ring-profile-test(fn="FQ674N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-FQ674N.pdf]]

#+call: ring-profile-test(fn="FQ674N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-FQ674N.pdf]]

******* FQ575N Ring profiles
#+name: fq575n-exclude
|  60 | -60.0 |  10.0 |
| 150 | -50.0 | -15.0 |
| 150 |  -4.0 |   4.0 |

#+call: ring-absolute("FQ575N", exclude=fq575n-exclude) :results file

#+RESULTS:
[[file:ring-FQ575N-absolute.pdf]]

#+call: ring-profile-test(fn="FQ575N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-FQ575N.pdf]]

#+call: ring-profile-test(fn="FQ575N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-FQ575N.pdf]]

******* FQ437N Ring profiles
#+name: fq437n-exclude
|  60 | -60.0 |  10.0 |
| 150 | -50.0 | -15.0 |
| 150 |  -4.0 |   4.0 |

#+call: ring-absolute("FQ437N", exclude=fq437n-exclude) :results file

#+RESULTS:
[[file:ring-FQ437N-absolute.pdf]]

#+call: ring-profile-test(fn="FQ437N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-FQ437N.pdf]]

#+call: ring-profile-test(fn="FQ437N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-FQ437N.pdf]]

******* FQ436N Ring profiles
#+name: fq436n-exclude
|  60 | -60.0 |  10.0 |
| 150 | -50.0 | -15.0 |
| 150 |  -4.0 |   4.0 |

#+call: ring-absolute("FQ436N", exclude=fq436n-exclude) :results file

#+RESULTS:
[[file:ring-FQ436N-absolute.pdf]]

#+call: ring-profile-test(fn="FQ436N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-FQ436N.pdf]]

#+call: ring-profile-test(fn="FQ436N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-FQ436N.pdf]]

******* F547M Ring profiles
#+name: f547m-exclude
|  60 | -5.0 | 5.0 |
| 150 | -5.0 | 5.0 |

#+call: ring-absolute("F547M", 2.0, 0.01, f547m-exclude) :results file

#+RESULTS:
[[file:ring-F547M-absolute.pdf]]


#+call: ring-profile-test(fn="F547M", PA=60, fudge=0.35, floor=-0.002) :results file

#+RESULTS:
[[file:ring-profile-pa60-F547M.pdf]]


#+call: ring-profile-test(fn="F547M", PA=150, fudge=0.35, floor=-0.005) :results file

#+RESULTS:
[[file:ring-profile-pa150-F547M.pdf]]

******* F645N Ring profiles
#+name: f645n-exclude
|  60 |  -5.0 |   5.0 |
|  60 | -22.0 | -15.0 |
|  60 |   7.0 |  15.0 |
|  60 |  32.0 |  38.0 |
| 150 |  -5.0 |   5.0 |

#+call: ring-absolute("F645N", exclude=f645n-exclude, offset=0.002) :results file

#+RESULTS:
[[file:ring-F645N-absolute.pdf]]

#+call: ring-profile-test(fn="F645N", PA=60, floor=-0.0005) :results file

#+RESULTS:
[[file:ring-profile-pa60-F645N.pdf]]

#+call: ring-profile-test(fn="F645N", PA=150, floor=-0.0009) :results file

#+RESULTS:
[[file:ring-profile-pa150-F645N.pdf]]

******* F487N Ring profiles
#+name: f487n-exclude
|  60 | -5.0 | 5.0 |
| 150 | -5.0 | 5.0 |

#+call: ring-absolute("F487N", exclude=f487n-exclude) :results file

#+RESULTS:
[[file:ring-F487N-absolute.pdf]]

#+call: ring-profile-test(fn="F487N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-F487N.pdf]]

#+call: ring-profile-test(fn="F487N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-F487N.pdf]]

******* F502N Ring profiles
#+name: f502n-exclude
|  60 | -10.0 | 5.0 |
| 150 |   0.0 | 0.0 |

#+call: ring-absolute("F502N", exclude=f502n-exclude) :results file

#+RESULTS:
[[file:ring-F502N-absolute.pdf]]

#+call: ring-profile-test(fn="F502N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-F502N.pdf]]

#+call: ring-profile-test(fn="F502N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-F502N.pdf]]

******* F469N Ring profiles
#+name: f469n-exclude
|  60 | -5.0 | 5.0 |
| 150 | -5.0 | 5.0 |

#+call: ring-absolute("F469N", exclude=f469n-exclude) :results file

#+RESULTS:
[[file:ring-F469N-absolute.pdf]]

#+call: ring-profile-test(fn="F469N", PA=60) :results file

#+RESULTS:
[[file:ring-profile-pa60-F469N.pdf]]

#+call: ring-profile-test(fn="F469N", PA=150) :results file

#+RESULTS:
[[file:ring-profile-pa150-F469N.pdf]]

***** Results for the ODH spectra


#+name: odh-absolute
#+header: :var fn="F547M" norm=0.93 offset=0.0
#+BEGIN_SRC python :noweb yes :results file :noweb yes
  import numpy as np
  from astropy.table import Table
  import astropy.table
  from matplotlib import pyplot as plt
  from matplotlib.ticker import MaxNLocator
  from sweetspot_utils import find_sweetspot_mask

  <<aesthetics>>

  spectab = Table.read('odh-filter-synphot-rates.tab', format='ascii.tab')
  wfc3tab = Table.read('odh-filter-wfc3-rates.tab', format='ascii.tab',
                       fill_values=('--', 0.0))

  fulltab = astropy.table.join(spectab, wfc3tab, keys=['Section'],
                               table_names=['s', 'w'])

  dec = -np.array([float(s[1:3]) for s in fulltab['Section']])
  ra = -fulltab['x0']
  d = np.hypot(ra, dec)

  x = (fulltab[fn + '_s'] - offset)*norm
  y = fulltab[fn + '_w']
  m = np.isfinite(x) & np.isfinite(y)
  m = m & find_sweetspot_mask(fn, ra, dec) 

  gradient = y[m].sum()/x[m].sum()
  order = np.random.permutation(len(x[m]))
  fig, ax = plt.subplots(1, 1, subplot_kw=dict(axisbg=bgcolor))
  scat = ax.scatter(x[m][order], y[m][order], c=d[m][order], s=3000.0/np.abs(dec[m][order]), vmin=0.0, vmax=150.0, alpha=0.8, cmap=cmap)
  cb = fig.colorbar(scat, ax=ax)
  cb.set_label('Radius, arcsec')
  ax.plot([0.0, x[m].max()], [0.0, gradient*x[m].max()], '--',
           label="gradient: {:.2f}".format(gradient))
  ax.plot([0.0, x[m].max()], [0.0, x[m].max()], '-',
           label="gradient: {:.2f}".format(1.0))
  ax.set_xlabel("ODH spectra predicted count rate per pixel / s$^{-1}$")
  ax.set_ylabel("WFC3 image count rate per pixel / s$^{-1}$")
  ax.set_title(fn)
  plotmax = 1.1*max(x[m].max(), y[m].max())
  ax.set_xlim(0.0, plotmax)
  ax.set_ylim(0.0, plotmax)
  ax.xaxis.set_major_locator(MaxNLocator(nbins=8, prune='lower'))
  ax.yaxis.set_major_locator(MaxNLocator(nbins=8, prune='lower'))
  ax.legend(loc='upper left')
  ax.set_aspect('equal', adjustable='box')
  ax.grid(ls='-', c='w', alpha=0.3)
  ax.set_axisbelow(True)
  plt.tight_layout()
  pltfile = 'odh-{}-absolute.pdf'.format(fn)
  plt.savefig(pltfile)
  return pltfile

#+END_SRC

#+RESULTS: odh-absolute
[[file:odh-F547M-absolute.pdf]]

#+call: odh-absolute("F547M", offset=0.3) :results file

#+RESULTS:
[[file:odh-F547M-absolute.pdf]]



#+call: odh-absolute("FQ575N") :results file

#+RESULTS:
[[file:odh-FQ575N-absolute.pdf]]



#+call: odh-absolute("F658N", offset=0.5) :results file

#+RESULTS:
[[file:odh-F658N-absolute.pdf]]


#+call: odh-absolute("F656N", offset=0.7) :results file

#+RESULTS:
[[file:odh-F656N-absolute.pdf]]


#+call: odh-absolute("F673N", offset=0.1) :results file

#+RESULTS:
[[file:odh-F673N-absolute.pdf]]

#+call: odh-absolute("FQ672N") :results file

#+RESULTS:
[[file:odh-FQ672N-absolute.pdf]]

#+call: odh-absolute("FQ674N") :results file

#+RESULTS:
[[file:odh-FQ674N-absolute.pdf]]

#+call: odh-absolute("F502N", offset=0.5) :results file

#+RESULTS:
[[file:odh-F502N-absolute.pdf]]

#+call: odh-absolute("FQ437N") :results file

#+RESULTS:
[[file:odh-FQ437N-absolute.pdf]]

#+call: odh-absolute("FQ436N") :results file

#+RESULTS:
[[file:odh-FQ436N-absolute.pdf]]

#+call: odh-absolute("F469N", offset=0.04) :results file

#+RESULTS:
[[file:odh-F469N-absolute.pdf]]

#+call: odh-absolute("F487N", offset=0.3) :results file

#+RESULTS:
[[file:odh-F487N-absolute.pdf]]



** Redoing the spatial scale calculation
* Recombination line temperatures and densities
** Revisiting ORL diagnostics with Adal
   DEADLINE: <2014-06-27 Fri>
   :LOGBOOK:
   CLOCK: [2014-06-23 Mon 08:30]--[2014-06-23 Mon 08:38] =>  0:08
   CLOCK: [2014-06-22 Sun 21:46]--[2014-06-22 Sun 22:49] =>  1:03
   CLOCK: [2014-06-22 Sun 17:12]--[2014-06-22 Sun 18:12] =>  1:00
   CLOCK: [2014-06-22 Sun 13:25]--[2014-06-22 Sun 13:44] =>  0:19
   CLOCK: [2014-06-21 Sat 23:10]--[2014-06-22 Sun 01:43] =>  2:33
   CLOCK: [2014-06-21 Sat 14:49]--[2014-06-21 Sat 23:09] =>  8:20
   :END:
*** TODO [1/4] Plan of action for ORLs
**** TODO Fit Gaussians to Adal's lines
+ Get other slits from Adal
**** TODO Do some sort of spatial averaging on the Manu data
+ It would be better to average before fitting
+ But we need some criterion for eliminating bad positions

**** TODO Make maps of the full-resolution, full-field Manu maps
+ New program [[file:manu-extract-line.py]]
  + Writes a table for each line: x, y, Flux, dFlux, etc
***** Plots of the Manu maps
:PROPERTIES:
:dir:      Manu-Nil
:noweb:    yes
:END:

#+name: manu-make-map
#+header: :var column="Flux" wav="4959" band="green" vmin="0.0" vmax="auto"
#+BEGIN_SRC python :return pltfile :results file 
  from astropy.table import Table
  import matplotlib.pyplot as plt
  <<aesthetics>>
  fig = plt.figure(figsize=(10, 10))
  ax_map = plt.subplot(111, axisbg=bgcolor)
  table = Table.read("Tables/{}-{}.tab".format(wav, band), format='ascii.tab')
  if vmax == "auto":
      vmax = 4*table[column].mean()
  scat = ax_map.scatter(table['x'], table['y'], s=30, c=table[column], vmin=float(vmin), vmax=float(vmax), alpha=0.6, edgecolors='none', cmap=cmap)
  cb = fig.colorbar(scat, ax=ax_map)
  ax_map.set_xlim(120.0, -120.0)
  ax_map.set_ylim(-160.0, 160.0)
  ax_map.set_aspect('equal', adjustable='box-forced')
  ax_map.set_xlabel('RA offset from th1, arcsec', fontsize='small')
  ax_map.set_ylabel('DEC offset from th1C, arcsec', fontsize='small')
  ax_map.set_title('{} {} {}'.format(column, wav, band))
  pltfile = "Maps/{}-{}-{}.pdf".format(column, wav, band)
  fig.savefig(pltfile, dpi=300)
#+END_SRC



#+name: manu-ratio-map
#+header: :var wavA="4363" wavB="4649", band="blue" vmin="0.0" vmax="auto"
#+BEGIN_SRC python :return pltfile :results file 
  from astropy.table import Table
  import matplotlib.pyplot as plt
  import numpy as np
  <<aesthetics>>
  column = 'Flux'
  fig = plt.figure(figsize=(10, 10))
  ax_map = plt.subplot(111, axisbg=bgcolor)
  tableA = Table.read("Tables/{}-{}.tab".format(wavA, band), format='ascii.tab')
  tableB = Table.read("Tables/{}-{}.tab".format(wavB, band), format='ascii.tab')
  ratio = tableA[column]/tableB[column]
  meanratio = tableA[column].mean()/tableB[column].mean()
  if vmax == "auto":
      vmax = 4*meanratio
  scat = ax_map.scatter(tableA['x'], tableA['y'], s=30, c=ratio, vmin=float(vmin), vmax=float(vmax), alpha=0.6, edgecolors='none', cmap=cmap)
  print(ratio.min(), ratio.max(), ratio.mean(), np.median(ratio), meanratio)
  cb = fig.colorbar(scat, ax=ax_map)
  ax_map.set_xlim(120.0, -120.0)
  ax_map.set_ylim(-160.0, 160.0)
  ax_map.set_aspect('equal', adjustable='box-forced')
  ax_map.set_xlabel('RA offset from th1, arcsec', fontsize='small')
  ax_map.set_ylabel('DEC offset from th1C, arcsec', fontsize='small')
  ax_map.set_title('Ratio {} / {} ({})'.format(wavA, wavB, band))
  pltfile = "Maps/Ratio-{}-{}-{}.pdf".format(wavA, wavB, band)
  fig.savefig(pltfile, dpi=300)
#+END_SRC

#+RESULTS: manu-ratio-map
: 5.23194386008e-12 2.33738127253e+15 322390979346.0 10.5513768152 9.49827430764

#+name: manu-diff-map
#+header: :var column="V" wavA="4363" wavB="4649", band="blue" vmin="auto" vmax="auto"
#+BEGIN_SRC python :return pltfile :results file 
  from astropy.table import Table
  import matplotlib.pyplot as plt
  import numpy as np
  <<aesthetics>>
  fig = plt.figure(figsize=(10, 10))
  ax_map = plt.subplot(111, axisbg=bgcolor)
  tableA = Table.read("Tables/{}-{}.tab".format(wavA, band), format='ascii.tab')
  tableB = Table.read("Tables/{}-{}.tab".format(wavB, band), format='ascii.tab')
  diff = tableA[column] - tableB[column]
  if vmax == "auto":
      vmax = diff.mean() + 4*diff.std()
  if vmin == "auto":
      vmin = diff.mean() - 4*diff.std()
  scat = ax_map.scatter(tableA['x'], tableA['y'], s=30, c=diff, vmin=float(vmin), vmax=float(vmax), alpha=0.6, edgecolors='none', cmap=cmap)
  print(diff.min(), diff.max(), diff.mean(), np.median(diff), diff.std())
  cb = fig.colorbar(scat, ax=ax_map)
  ax_map.set_xlim(120.0, -120.0)
  ax_map.set_ylim(-160.0, 160.0)
  ax_map.set_aspect('equal', adjustable='box-forced')
  ax_map.set_xlabel('RA offset from th1, arcsec', fontsize='small')
  ax_map.set_ylabel('DEC offset from th1C, arcsec', fontsize='small')
  m = np.isfinite(diff)
  ax_map.set_title('{} difference: {} - {} ({}) mean, median, std = {:.1f}, {:.1f}, {:.1f}'.format(column, wavA, wavB, band, diff[m].mean(), np.median(diff[m]), diff[m].std()))
  pltfile = "Maps/Diff-{}-{}-{}-{}.pdf".format(column, wavA, wavB, band)
  fig.savefig(pltfile, dpi=300)
#+END_SRC

#+RESULTS: manu-diff-map
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Diff-V-4363-4649-blue.pdf]]


#+name: manu-qdiff-map
#+header: :var column="W" wavA="4363" wavB="4649", band="blue" vmin="auto" vmax="auto"
#+BEGIN_SRC python :return pltfile :results file 
  from astropy.table import Table
  import matplotlib.pyplot as plt
  import numpy as np
  <<aesthetics>>
  fig = plt.figure(figsize=(10, 10))
  ax_map = plt.subplot(111, axisbg=bgcolor)
  tableA = Table.read("Tables/{}-{}.tab".format(wavA, band), format='ascii.tab')
  tableB = Table.read("Tables/{}-{}.tab".format(wavB, band), format='ascii.tab')
  diff = np.sqrt(tableA[column]**2 - tableB[column]**2)
  if vmax == "auto":
      vmax = diff.mean() + 4*diff.std()
  if vmin == "auto":
      vmin = diff.mean() - 4*diff.std()
  scat = ax_map.scatter(tableA['x'], tableA['y'], s=30, c=diff, vmin=float(vmin), vmax=float(vmax), alpha=0.6, edgecolors='none', cmap=cmap)
  print(diff.min(), diff.max(), diff.mean(), np.median(diff), diff.std())
  cb = fig.colorbar(scat, ax=ax_map)
  ax_map.set_xlim(120.0, -120.0)
  ax_map.set_ylim(-160.0, 160.0)
  ax_map.set_aspect('equal', adjustable='box-forced')
  ax_map.set_xlabel('RA offset from th1, arcsec', fontsize='small')
  ax_map.set_ylabel('DEC offset from th1C, arcsec', fontsize='small')
  m = np.isfinite(diff)
  ax_map.set_title('{} difference: {} - {} ({})  mean, median, std = {:.1f}, {:.1f}, {:.1f}'.format(column, wavA, wavB, band, diff[m].mean(), np.median(diff[m]), diff[m].std()))
  pltfile = "Maps/Qdiff-{}-{}-{}-{}.pdf".format(column, wavA, wavB, band)
  fig.savefig(pltfile, dpi=300)
#+END_SRC


****** Results of ratio plots
#+call: manu-ratio-map("4363", "4649", vmin=3.0, vmax=15.0) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Ratio-4363-4649-blue.pdf]]

#+call: manu-ratio-map("4591", "4649", vmin=0.05, vmax=0.3) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Ratio-4591-4649-blue.pdf]]

#+call: manu-ratio-map("5538", "5518", "green", vmin=0.8, vmax=2.2) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Ratio-5538-5518-green.pdf]]

#+call: manu-ratio-map("4649", "4651", "blue", vmin=0.0, vmax=4.0) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Ratio-4649-4651-blue.pdf]]

#+call: manu-ratio-map("4649", "4642", "blue", vmin=0.5, vmax=1.3) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Ratio-4649-4642-blue.pdf]]

Ratio between N II and O II brightness
#+call: manu-ratio-map("4631", "4642", "blue", vmin=0.0, vmax=1.0) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Ratio-4631-4642-blue.pdf]]

****** Results of making single-line plots
#+call: manu-make-map() :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4959-green.pdf]]

#+call: manu-make-map("W", "4959", "green", vmin="20", vmax="45") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/W-4959-green.pdf]]

#+call: manu-make-map("V", "4959", "green", vmin="-20", vmax="45") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/V-4959-green.pdf]]

+ Compare widths of 4642 and 4639 lines of O II V1 multiplet
+ 4642 should have contamination from N II 4641
#+call: manu-make-map("W", "4642", "blue", vmin="20", vmax="70") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/W-4642-blue.pdf]]

#+call: manu-make-map("W", "4639", "blue", vmin="20", vmax="70") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/W-4639-blue.pdf]]

#+call: manu-qdiff-map("W", "4642", "4639", "blue", vmin=30.0, vmax=75) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Qdiff-W-4642-4639-blue.pdf]]

#+call: manu-diff-map("V", "4642", "4639", "blue", vmin=-15, vmax=15) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Diff-V-4642-4639-blue.pdf]]


Velocity of [Cl III] lines wrt the [O I] 5577 sky line - looks pretty random
#+call: manu-diff-map("V", "5538", "5577", "green", vmin=-2, vmax=34) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Diff-V-5538-5577-green.pdf]]
#+call: manu-diff-map("V", "5518", "5577", "green", vmin=-2, vmax=34) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Diff-V-5518-5577-green.pdf]]
And here is the difference between the two [Cl III] lines

#+call: manu-diff-map("V", "5518", "5538", "green", vmin=-4, vmax=16) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Diff-V-5518-5538-green.pdf]]
This mainly seems to be an instrumental effect

[O III] 4363 V diff with He I 4388 - nothing there
#+call: manu-diff-map("V", "4363", "4388", "blue", vmin=-6, vmax=6) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Diff-V-4363-4388-blue.pdf]]

[Fe II] 4359 V diff with [O III] 4363 - interesting but it mainly traces the [Fe II] brightness. Maybe it is a blend with another line
#+call: manu-diff-map("V", "4359", "4363", "blue", vmin=-50, vmax=-10) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Diff-V-4359-4363-blue.pdf]]


Two He I lines.  Velocity difference shows almost no structure, which is good. 
#+call: manu-diff-map("V", "4388", "4438", "blue", vmin=-10, vmax=10) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Diff-V-4388-4438-blue.pdf]]

[Fe III] with O II velocity difference.
#+call: manu-diff-map("V", "4658", "4639", "blue", vmin=-30, vmax=30) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Diff-V-4658-4639-blue.pdf]]

#+call: manu-diff-map("V", "4658", "4667", "blue", vmin=-20, vmax=20) :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Diff-V-4658-4667-blue.pdf]]



#+call: manu-make-map("V", "4363", "blue", vmin="0", vmax="30") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/V-4363-blue.pdf]]

#+call: manu-make-map("W", "4363", "blue", vmin="30", vmax="70") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/W-4363-blue.pdf]]

#+call: manu-make-map("EW", "4363", "blue", vmax="6.5") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/EW-4363-blue.pdf]]

#+call: manu-make-map("EW", "4959", "green", vmax="800") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/EW-4959-green.pdf]]

#+call: manu-make-map("Flux", "4363", "blue", vmax="120") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4363-blue.pdf]]


#+call: manu-make-map("Flux", "4649", "blue", vmax="12") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4649-blue.pdf]]

#+call: manu-make-map("Flux", "4651", "blue", vmax="5") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4651-blue.pdf]]

#+call: manu-make-map("Flux", "4591", "blue", vmax="1.7") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4591-blue.pdf]]

#+call: manu-make-map("Flux", "4631", "blue", vmax="4.0") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4631-blue.pdf]]

An [Fe III] line
#+call: manu-make-map("Flux", "4658", "blue") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4658-blue.pdf]]

And another [Fe III] line
#+call: manu-make-map("Flux", "4667", "blue") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4667-blue.pdf]]

#+call: manu-make-map("Flux", "5876", "red", vmax="1350") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-5876-red.pdf]]

#+call: manu-make-map("Flux", "6678", "red") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-6678-red.pdf]]

#+call: manu-make-map("Flux", "5048", "green") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-5048-green.pdf]]

#+call: manu-make-map("Flux", "5041", "green", vmax="14") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-5041-green.pdf]]

#+call: manu-make-map("Flux", "5056", "green", vmax="24") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-5056-green.pdf]]

#+call: manu-make-map("Flux", "4359", "blue", vmin="4", vmax="14") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4359-blue.pdf]]

#+call: manu-make-map("Flux", "4368", "blue", vmax="12") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4368-blue.pdf]]

#+call: manu-make-map("Flux", "4388", "blue", vmax="auto") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4388-blue.pdf]]

#+call: manu-make-map("Flux", "4438", "blue", vmax="7") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4438-blue.pdf]]

#+call: manu-make-map("Flux", "5538", "green", vmax="auto") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-5538-green.pdf]]

#+call: manu-make-map("Flux", "5518", "green", vmax="auto") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-5518-green.pdf]]

#+call: manu-make-map("Flux", "4676", "blue", vmax="auto") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4676-blue.pdf]]

#+call: manu-make-map("Flux", "4667", "blue", vmax="auto") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4667-blue.pdf]]

#+call: manu-make-map("Flux", "4634", "blue", vmax="auto") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-4634-blue.pdf]]

#+call: manu-make-map("Flux", "5592", "green", vmax="0.5") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-5592-green.pdf]]

#+call: manu-make-map("Flux", "5555", "green", vmax="4") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-5555-green.pdf]]

#+call: manu-make-map("Flux", "5577", "green", vmax="auto") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Flux-5577-green.pdf]]

#+call: manu-make-map("V", "5577", "green", vmin="-20", vmax="40") :results file

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/V-5577-green.pdf]]
****** Deblending the O II 4642 line

#+BEGIN_SRC python :return pltfile :results file :tangle Manu-Nil/deblend4642.py
    from astropy.table import Table
    import matplotlib.pyplot as plt
    import numpy as np

    vA, vB = -75.6, 80.8

    <<aesthetics>>

    fig, (axA, axB) = plt.subplots(1, 2, sharex=True, sharey=True)

    tableA = Table.read("Tables/4642-blue.tab", format='ascii.tab')
    tableB = Table.read("Tables/4639-blue.tab", format='ascii.tab')
    sigsq = tableA['W']**2 - tableB['W']**2
    vmean = tableA['V'] - tableB['W']
    sumsq = sigsq + vmean**2
    A = vB*(vmean*vB - sumsq) / ((vB - vA)*(vB*vA + sumsq) - vmean*(vA**2 - vB**2))
    B = vA*(vmean*vA - sumsq) / ((vA - vB)*(vA*vB + sumsq) - vmean*(vB**2 - vA**2))
    vmin, vmax = 0.0, 1.0

    scatA = axA.scatter(tableA['x'], tableA['y'], s=30, c=A,
                        vmin=float(vmin), vmax=float(vmax),
                        alpha=0.6, edgecolors='none', cmap=cmap)
    scatB = axB.scatter(tableA['x'], tableA['y'], s=30, c=B,
                        vmin=float(vmin), vmax=float(vmax),
                        alpha=0.6, edgecolors='none', cmap=cmap)
    print(A.min(), A.max(), A.mean(), np.median(A), A.std())
    print(B.min(), B.max(), B.mean(), np.median(B), B.std())
    cb = fig.colorbar(scatB, ax=[axA, axB])
    axA.set_xlim(120.0, -120.0)
    axA.set_ylim(-160.0, 160.0)
    axA.set_aspect('equal', adjustable='box-forced')
    axB.set_aspect('equal', adjustable='box-forced')
    axA.set_xlabel('RA offset from th1, arcsec', fontsize='small')
    axA.set_ylabel('DEC offset from th1C, arcsec', fontsize='small')
    Amean = np.sum(A*tableA['Flux'])/np.sum(tableA['Flux'])
    Bmean = np.sum(B*tableA['Flux'])/np.sum(tableA['Flux'])
    axA.set_title('A = N III 4641 / O II 4642 (mean, median = ' +
                  '{:.2f}, {:.2f})'.format(Amean, np.median(A)), fontsize='x-small')
    axB.set_title('B = N II 4643 / O II 4642 (mean, median = ' +
                  '{:.2f}, {:.2f})'.format(Bmean, np.median(B)), fontsize='x-small')
    fig.set_size_inches(15, 8)
    pltfile = "Maps/Deblend-AB.pdf"
    fig.savefig(pltfile, dpi=300)
#+END_SRC

#+RESULTS:
[[file:/Users/will/Work/RubinWFC3/Tsquared/Manu-Nil/Maps/Deblend-AB.pdf]]

**** DONE [6/6] Redo the fitting to Manu's lines, but now including the entire map
+ [X] Make sure python installation is up to scratch on nil
  + Installed Anaconda3 2.01 in /fs/nil/other0/anaconda3
  + The default version is Python 3.4, but I have also added an enviroment with Python 2.7
    + Switch between them with =source activate py27= and =source deactivate=
+ [X] Transfer the original Manu data files to nil
   #+BEGIN_EXAMPLE
   will@nil:orion-tsq(master)$ mkdir -p Manu-Data
   will@nil:orion-tsq(master)$ cd Manu-Data/
   will@nil:Manu-Data(master)$ ln -s ~/Dropbox/Manuel-2014/M42_blue .
   will@nil:Manu-Data(master)$ ln -s ~/Dropbox/Manuel-2014/M42_green .
   will@nil:Manu-Data(master)$ ln -s ~/Dropbox/Manuel-2014/M42_red .
   #+END_EXAMPLE
+ [X] Add option to manu-photom-select.py to not restrict area to Orion S
+ [X] Check what extra lines we might want to add to the fitting
  + [X] Next to He I 4388: 4391.94 Ne II, 4409.30 NeII
    + CANCELLED: not really visible
  + [X] Next to O II 4591:
    1) O II 4596 (4595.95 + 4596.18), [Ni III] 4596.83
    2) N II + O II 4602 (4601.48 + 4602.11)
    3) N II 4613.87
  + [X] He I lines that were missing: 5016, 5048
    + Plus accompanying Si II 5041, 5056
    + There are problems with these:
      1. 5016 is in the flank of 5007 and is not fit very well
      2. 5048 is in the far flank, where the local quadratic continuum picks up most of the slack, but there are still problems.  The precision will not be very high, especially since the line is so weak.  It also seems to be affected by an inordinate number of cosmic rays.  Finally, we are going to have to take the ratio with 5876, which is in the red 

+ [X] Check that everything works on nil
  + [X] manu-photom-select.py
  + [X] manu-photom-fit.py
    + [X] need to get the tolerance parameters right
      + looks like 1e-5 is necessary for both --xtol and --ftol
  + [X] manu-photom-plot.py
  + [X] Look at the output
    + Put the new fits in =Manu-Nil/=
+ [X] First production runs on nil
  + For the entire field, but only selected wav ranges
  + Example for blue 4651 line
    #+BEGIN_EXAMPLE
time python manu-photom-fit.py --pattern blue* --only 4651 --ftol 1e-5 --xtol 1e-5
    #+END_EXAMPLE
  + Table of wav ranges we have done
      | blue  | 4650_O_II_Fe_III | x |
      | blue  | 4610_O_II_Fe_III | x |
      | blue  | 4350_            | x |
      | green | 4960_O_III       | x |
      | green | 5550_Cl_III      | x |
      | green | 5050_He_I_Si_II  | x |
      | red   | 5880_He_I        | x |
      | red   | 6680_He_I        | x |
*** The issue of underlying stellar absorption
+ This /might/ be happening for O II 4591
+ By looking at the spectrum when it is over a star, e.g. th2A, then there is a hint of an absorption feature with an absorption depth of 5% maximum.
+ We also see absorption at 4649/51, this is much deeper than 4591 at the position of th2A
+ At position of th1C, there are no features in the 4650 range or the 4591 range
+ At (+9.7, +7.6), which is close to th1D, we see absorption of both 4591 and 4649/51
+ [ ] We need to look for correlations with EW
*** TODO The N III 4634 line
+ This is mainly supposed to be excited by Bowen resonance fluorescence (via O III resonance line)
+ It shows a peak in the Big Arc S, which may be due to that
+ But it also shows right regions around the Trapezium and around th2A
+ Might these be due to starlight fluorescence of N^{3+} ?
*** Fluorescence vs recombination for the permitted lines

**** Arguments in favor of recombination

**** Arguments in favor of fluorescence
+ The N II 4631 line looks very much like the O II 4651 line
  + Escalante & Morisset [[x-bdsk://Escalante:2005a][2005]] say that this line is mainly fluorescence
  + From their Fig 2, it can be seen that the fluorescence occurs manily near the illuminated face of their model, where N+/N is very small (< 0.1)
  + This is consistent with the appearance of the 4631 line, which is particularly bright in the inner [O III] ring
+ So the argument would be that what works for N II could work for O II too
  + But are there any calculations of fluorescent contributions to O II lines?
  + Yes, we have Escalante et al [[x-bdsk://Escalante:2012a][2012]], which gives relative contributions of fluorescence for various lines.
    + Calculated for an exciting star with Teff ~ 40,000 K, which is very similar to th1C
    + See [[id:C66F4EB0-5E9B-499F-93D1-B7865EA6B3D9][table below]]
    + For N II they say that fluorescence is more important in Orion than in IC418
      + Is the same true of O II?
    + Anyway, for IC418 they have 70 - 80% recombination contribution to the V1 multiplet
***** Selected O II lines
:PROPERTIES:
:ID:       C66F4EB0-5E9B-499F-93D1-B7865EA6B3D9
:END:
| Lower - Upper       |  \lambda (\AA) | Irec/Icalc | Icalc |   Iobs | Will comment  |
|---------------------+--------+------------+-------+--------+---------------|
| Graphic - 3d 4F3/2  | 4069.6 |      0.921 |  1.46 |   2.04 | Blend         |
| Graphic - 3d 4F5/2  | 4069.9 |      0.924 |  2.32 |   1.99 | with          |
| 3d 4F7/2 - Graphic  | 4071.2 |      1.000 |  0.26 |      - | [S II]        |
| Graphic - 3d 4F7/2  | 4072.3 |      0.952 |  3.41 |   3.27 | + C III       |
|---------------------+--------+------------+-------+--------+---------------|
| Graphic - 3d 4F9/2  | 4075.9 |      0.956 |  4.90 |   4.42 | Blend [S II]  |
|---------------------+--------+------------+-------+--------+---------------|
| 3d 4D7/2 - Graphic  | 4275.5 |      1.000 |  0.84 |   0.65 | Blend [Fe II] |
| 3d 4D3/2 - Graphic  | 4275.9 |      1.000 |  0.16 |      - |               |
| 3d 4D5/2 - Graphic  | 4276.3 |      1.000 |  0.12 |      - |               |
| 3d 4D5/2 - Graphic  | 4276.8 |      1.000 |  0.31 | 0.79 ? |               |
| 3d 4D1/2 - Graphic  | 4277.4 |      1.000 |  0.21 |   0.33 |               |
| 3d 4D7/2 - Graphic  | 4277.8 |      1.000 |  0.15 |      - |               |
|---------------------+--------+------------+-------+--------+---------------|
| 3s 4P5/2 - Graphic  | 4366.8 |      0.605 |  1.67 |   1.36 | Blend O I     |
|---------------------+--------+------------+-------+--------+---------------|
| 3s 2P3/2 - Graphic  | 4414.9 |      0.812 |  5.26 |   3.03 | Blend [Fe II] |
| 3s 2P1/2 - Graphic  | 4416.8 |      0.815 |  2.95 |   1.97 | Blend [Fe II] |
|---------------------+--------+------------+-------+--------+---------------|
| 3s′ 2D5/2 - Graphic | 4590.9 |      0.729 |  0.60 |   1.43 |  V15          |
| 3s′ 2D3/2 - Graphic | 4596.2 |      0.774 |  0.53 |   0.94 |               |
|---------------------+--------+------------+-------+--------+---------------|
| 3s 4P1/2 - Graphic  | 4638.8 |      0.731 |  2.07 |   1.96 | V1            |
| 3s 4P3/2 - Graphic  | 4641.6 |      0.794 |  4.68 |   4.22 |               |
| 3s 4P5/2 - Graphic  | 4649.2 |      0.795 |  8.35 |   6.70 |               |
| 3s 4P1/2 - Graphic  | 4650.9 |      0.688 |  2.05 |   2.17 |               |
| 3s 4P3/2 - Graphic  | 4661.6 |      0.731 |  2.30 |   2.31 |               |
| 3s 4P3/2 - Graphic  | 4673.8 |      0.688 |  0.35 |   0.41 |               |
| 3s 4P5/2 - Graphic  | 4676.2 |      0.794 |  1.59 |   1.58 |               |
|---------------------+--------+------------+-------+--------+---------------|

***** Table 7 (Complete)
+ Note that some of the lower/upper states are given as images o nthe web page
+ http://mnras.oxfordjournals.org/content/426/3/2318/T7.expansion.html
| Lower–Upper        |  λ  (Å) | Irec/Icalc | Icalc |   Iobs |
| Graphic–3d 4D3/2   |  3842.8 |      0.605 |  0.15 |      – |
| Graphic–3d 4D5/2   |  3850.7 |      0.686 |  0.16 |      – |
| Graphic–3d 4D3/2   |  3851.1 |      0.605 |  0.30 |      – |
| Graphic–3d 4D7/2   |  3863.6 |      0.825 |  0.10 |      – |
| Graphic–3d 4D5/2   |  3864.5 |      0.686 |  0.54 |      – |
| Graphic–3d 4D3/2   |  3864.8 |      0.605 |  0.20 |      – |
| Graphic–3d 4D7/2   |  3882.3 |      0.825 |  0.86 |   0.63 |
| Graphic–3d 4D5/2   |  3883.1 |      0.686 |  0.10 |   0.27 |
| Graphic–3d 4P5/2   |  3907.6 |      0.711 |  0.09 |   0.35 |
| 3d 4F7/2–Graphic   |  4048.2 |      1.000 |  0.10 |      – |
| 3d 4F9/2–Graphic   |  4062.8 |      1.000 |  0.19 |      – |
| Graphic–3d 4F3/2   |  4069.6 |      0.921 |  1.46 |   2.04 |
| Graphic–3d 4F5/2   |  4069.9 |      0.924 |  2.32 |   1.99 |
| 3d 4F7/2–Graphic   |  4071.2 |      1.000 |  0.26 |      – |
| Graphic–3d 4F7/2   |  4072.3 |      0.952 |  3.41 |   3.27 |
| Graphic–3d 4F9/2   |  4075.9 |      0.956 |  4.90 |   4.42 |
| Graphic–3d 4F3/2   |  4078.8 |      0.921 |  0.53 |   0.56 |
| 3d 4F5/2–Graphic   |  4083.8 |      1.000 |  0.44 | 0.49 ? |
| Graphic–3d 4F5/2   |  4085.2 |      0.924 |  0.65 |   0.76 |
| 3d 4F3/2–Graphic   |  4087.1 |      1.000 |  0.42 |   0.45 |
| 3d 4F9/2–Graphic   |  4089.2 |      1.000 |  1.54 |   1.14 |
| Graphic–3d 4F7/2   |  4093.0 |      0.952 |  0.46 |   0.32 |
| 3d 4F5/2–Graphic   |  4095.6 |      1.000 |  0.30 |   0.42 |
| 3d 4F7/2–Graphic   | 4097.2* |      0.795 |  1.96 | 1.15 ? |
| 3d 4F3/2–Graphic   |  4098.2 |      1.000 |  0.25 |      – |
| Graphic–3d 4D5/2   |  4104.8 |      0.686 |  1.97 | 1.60 ? |
| Graphic–3d 4D3/2   |  4105.1 |      0.605 |  0.76 |   0.46 |
| 3d 4F5/2–Graphic   |  4107.0 |      1.000 |  0.18 |      – |
| Graphic–3d 4D1/2   |  4110.9 |      0.868 |  0.07 |   0.75 |
| Graphic–3d 4D7/2   |  4119.2 |      0.825 |  2.23 |   2.19 |
| Graphic–3d 4D5/2   |  4120.2 |      0.686 |  0.15 |   0.68 |
| Graphic–3d 4P1/2   |  4121.3 |      0.465 |  0.41 |   1.66 |
| Graphic–3d 4P1/2   |  4129.3 |      0.465 |  0.64 |      – |
| Graphic–3d 4P3/2   |  4132.7 |      0.655 |  0.24 |   0.83 |
| Graphic–3d 4P3/2   |  4140.8 |      0.655 |  0.42 |      – |
| Graphic–3d 4P5/2   |  4153.4 |      0.711 |  0.70 |   1.84 |
| Graphic–3d 4P3/2   |  4156.4 |      0.655 |  0.70 | 1.59 ? |
| Graphic–3d 4P5/2   |  4169.2 |      0.711 |  0.96 |      – |
| Graphic–3d′ 2G7/2† |  4185.5 |      0.997 |  0.79 |   0.81 |
| Graphic–3d′ 2G9/2  |  4189.9 |      0.997 |  0.82 |   1.24 |
| 3d 4D7/2–Graphic   |  4275.5 |      1.000 |  0.84 |   0.65 |
| 3d 4D3/2–Graphic   |  4275.9 |      1.000 |  0.16 |      – |
| 3d 4D5/2–Graphic   |  4276.3 |      1.000 |  0.12 |      – |
| 3d 4D5/2–Graphic   |  4276.8 |      1.000 |  0.31 | 0.79 ? |
| 3d 4D1/2–Graphic   |  4277.4 |      1.000 |  0.21 |   0.33 |
| 3d 4D7/2–Graphic   |  4277.8 |      1.000 |  0.15 |      – |
| 3d 4P5/2–Graphic   |  4281.3 |      1.000 |  0.08 |   0.19 |
| 3d 4D3/2–Graphic   |  4282.9 |      1.000 |  0.24 |   0.26 |
| 3d 4D3/2–Graphic   |  4283.6 |      1.000 |  0.15 |      – |
| 3d 2F5/2–Graphic   |  4285.6 |      1.000 |  0.29 |   0.31 |
| 3d 4P5/2–Graphic   |  4291.2 |      1.000 |  0.24 |      – |
| 3d 2F5/2–Graphic   |  4292.2 |      1.000 |  0.14 |      – |
| 3d 4P3/2–Graphic   |  4294.8 |      1.000 |  0.36 |   0.59 |
| 3d 4D7/2–Graphic   |  4303.5 |      1.000 |  0.09 |      – |
| 3d 4P5/2–Graphic   |  4303.8 |      1.000 |  0.63 |   0.66 |
| 3d 4P1/2–Graphic   |  4307.3 |      1.000 |  0.16 |   1.19 |
| 3d 2F7/2–Graphic   |  4312.2 |      1.000 |  0.10 |      – |
| 3d 2F7/2–Graphic   |  4313.5 |      1.000 |  0.19 |      – |
| 3s 4P1/2–Graphic   |  4317.0 |      0.605 |  1.58 |   1.59 |
| 3d 4P3/2–Graphic   |  4317.7 |      1.000 |  0.11 |      – |
| 3s 4P3/2–Graphic   |  4319.6 |      0.747 |  1.25 | 0.83 ? |
| 3s 4P1/2–Graphic   |  4325.8 |      0.522 |  0.34 |      – |
| 3d 4D5/2–Graphic   |  4331.2 |      1.000 |  0.12 |      – |
| 3d 4D7/2–Graphic   |  4332.6 |      1.000 |  0.15 |      – |
| 3s 4P3/2–Graphic   |  4336.7 |      0.605 |  0.67 |   0.37 |
| 3d 2F5/2–Graphic   |  4340.3 |      1.000 |  0.34 |      – |
| 3d 2F7/2–Graphic   |  4342.1 |      1.000 |  0.85 |      – |
| 3d 4D5/2–Graphic   |  4344.4 |      1.000 |  0.18 |      – |
| 3s 4P3/2–Graphic   |  4345.6 |      0.522 |  1.92 |   1.92 |
| 3s′ 2D3/2–Graphic† |  4347.5 |      0.649 |  0.57 |      – |
| 3s 4P5/2–Graphic   |  4349.5 |      0.747 |  3.51 |   3.30 |
| 3s′ 2D5/2–Graphic  |  4351.2 |      0.571 |  0.69 |   0.80 |
| 3d 2F5/2–Graphic   |  4353.5 |      1.000 |  0.16 |      – |
| 3s 4P5/2–Graphic   |  4366.8 |      0.605 |  1.67 |   1.36 |
| 3d 2F7/2–Graphic   |  4371.7 |      1.000 |  0.15 |      – |
| 3s 2P3/2–Graphic   |  4414.9 |      0.812 |  5.26 |   3.03 |
| 3s 2P1/2–Graphic   |  4416.8 |      0.815 |  2.95 |   1.97 |
| 3s 2P3/2–Graphic   |  4452.2 |      0.815 |  0.54 | 0.88 ? |
| 3d 2P3/2–Graphic   |  4466.4 |      1.000 |  0.14 |   0.29 |
| 3d 2P3/2–Graphic   |  4477.9 |      1.000 |  0.13 |      – |
| 3d 2P1/2–Graphic   |  4489.4 |      1.000 |  0.10 |   0.07 |
| 3d 2P3/2–Graphic   |  4491.2 |      1.000 |  0.21 |      – |
| 3s′ 2D5/2–Graphic  |  4590.9 |      0.729 |  0.60 |   1.43 |
| 3s′ 2D3/2–Graphic  |  4596.2 |      0.774 |  0.53 |   0.94 |
| 3d 2D3/2–Graphic   |  4602.1 |      1.000 |  0.27 |   0.22 |
| 3d 2D5/2–Graphic   |  4609.3 |      1.000 |  0.66 |   0.60 |
| 3d 2D3/2–Graphic   |  4610.2 |      1.000 |  0.21 |      – |
| 3s 4P1/2–Graphic   |  4638.8 |      0.731 |  2.07 |   1.96 |
| 3s 4P3/2–Graphic   |  4641.6 |      0.794 |  4.68 |   4.22 |
| 3s 4P5/2–Graphic   |  4649.2 |      0.795 |  8.35 |   6.70 |
| 3s 4P1/2–Graphic   |  4650.9 |      0.688 |  2.05 |   2.17 |
| 3s 4P3/2–Graphic   |  4661.6 |      0.731 |  2.30 |   2.31 |
| 3s 4P3/2–Graphic   |  4673.8 |      0.688 |  0.35 |   0.41 |
| 3s 4P5/2–Graphic   |  4676.2 |      0.794 |  1.59 |   1.58 |
| 3s 4P5/2–Graphic   |  4696.4 |      0.731 |  0.17 |   0.27 |
| Graphic–3d 2F5/2   |  4699.3 |      0.441 |  0.70 | 1.33 ? |
| Graphic–3d 2F7/2   |  4705.2 |      0.472 |  1.36 |   1.83 |
| Graphic–3d 4D5/2   |  4856.4 |      0.686 |  0.11 |      – |
| Graphic–3d 4P1/2   |  4890.8 |      0.465 |  0.41 |   1.37 |
| Graphic–3d 4P3/2   |  4906.9 |      0.655 |  0.71 |   0.42 |
| Graphic–3d 4P5/2   |  4924.7 |      0.711 |  0.41 |   0.89 | 
  
〈Irec/Icalc〉 = 0.838	〈Icalc/Iobs〉 = 0.898
*λ 4097.2 includes the emission of Graphic–3d 4D3/2.

† 3p′ and 3d′ are the core-excited configurations 2p2(1D)3p and 2p2(1D)3d, respectively.

†3p′ and 3d′ are the core-excited terms 2p2(1D)3p and 2p2(1D)3d, respectively.

Online ISSN 1365-2966 - Print ISSN 0035-8711
Copyright ©  2014  The Royal Astronomical Society
** Original notes on ORL diagnostics
From the Manu spectra we can measure various useful ratios:
+ O II 4649/(4639+51+62) is density sensitive
  + We have it in the blue and green spectra but the green spectra are
    not so good
  + We have fitted the lines by assuming common velocity and width of all lines in the multiplet, and also that the 4639, 4651, 4662 components have a equal intensities.
    + This is somewhat justified by the very similar density dependences of those 3 lines, so long as the density is not too low (see Fig 6 of Fang & Liu 2013MNRAS.429.2791F).
+ O II Sum(V1)/[O III] 4959 is temperature sensitive
  + There are actually 8 lines in the V1 multiplet in total.  The four that we use for the density plus:
    + 4642, which we measure and is quite strong - theoretically it is about 22% of the total multiplet intensity with almost no density dependence above 1e3 pcc
      + However, it is blended with an N III line, which we would need to control for
    + 4676, which we measure but is weaker - 8% of the multiplet theoretically, again with almost no density dependence
    + 4674 and 4696 are very weak and we do not attempt to fit them.  But they add up to less than 2% of the total multiplet.
  + So there would be two possible approaches:
    1. Just use 4649+39+51+62 and then correct for the missing 4 components by dividing by (1 - 0.22 - 0.08 - 0.02) = 0.68 to get the total V1 intensity.
    2. Also add 4642 and 4676 and divide by (1 - 0.02) = 0.98 to get the total
       + But in this case we need to check for contamination of the 4642 line.  We could look at the histogram of 4642/(4639+51+62), which ought to be constant at about 0.22/0.68 = 0.32
       + Also with 4676 line we should maybe add in 4674 since it is probably blended.  So the expected ratio of (4674+4676)/(4639+51+62) is (0.08 + 0.02)/0.68 = 0.15
+ O II 4649/4591 is temperature sensitive
  + 4591 comes from a different multiplet - V15 supposedly
    + Fang calls them
      + M1 2p23p 4Do – 2p23s 4P λ4652
      + M48a 4f G[5,4,3]o – 3d 4 F λ4089
      + M15 3p′ 2Fo – 3s′ 2D has 4591
        + Supposedly the upper level is 6.76 eV below the ionization threshold
  + There is a graph in Fang 2013a Fig 21 upper.
    + Note that it is a *log scale* of 4649/4591
    + Typical value from our observations is log10(ratio) = 0.8 \pm 0.2, which implies log T = 3.65 \pm 0.25, which is (3000, 4500, 8000) K
    + To get > 8000 K require log10(ratio) < 0.6, which means 4591 > 1/4 4649
      + Very few of our positions have such strong 4591 lines
      + Looking at the fits to 4591, it seems that many have failed
      + Just taking ones that look like good fits, we get 4649/4591 ratios of 4.6, 10.3, 8.9, 9.9, 11.6 -> log(R) = 0.96 +/- 0.06, which means an even lower T
      + However, in some of the better quality spectra (e.g., blue-0226-0196) there is slight evidence for an underlying absorption line.  This indicates that 4649 may be under-estimated
      + This can be best investigating by looking at the spectra with low EW(H gamma)
        + For instance, blue-0382-0641 shows faint absorption on the blue side of all the He I lines.  Even here, it is hard to say there is any absorption at 4649 but probably there is. 
  + In summary we are probably on a hiding to nothing with this line.  Maybe we could order all the regions by 4363 ratio, split them into 4 parts and look at the average spectrum of each quartile to see if there is any variation in 4649/4591
    + Actually, it doesn't look so bad.  There is also the 4189 line from the V36 multiplet.  This and its companion 4185 lne are clearly detected.  There are no other lines to blend with them, although 4189 is actually two lines: 4189.79 + 4189.59.  The He II 4200 absorption line is nearby but does ot interfere with it.
    + 4649/4189 and 4649/4591 have almost identical dependences on T, falling with rising T.  They need to be about as low as 4 for "normal" temperatures of 8000 K.  The observed values of around 10 imply much lower T (4000 K or so)
    + 4649/4089 on the other hand should increase with increasing T.  The nominal observed value in Orion is 6.2, which actually implies temperatures > 1e4 K.  For 8000 K we expect a ratio of 3.7 (Fang & Liu 2013 Fig 17)
    + However, as Peimbert & Peimbert (2013) point out, this ignores the Si IV line at 4088.86, which has two effects:
      + Emission, being about 50% of the strength of the O II 4089.29 line
      + Underlying absorption: Simón-Díaz et al (2006) show the Si IV absorption in the wing of the H\delta line, with the following absorption depths:
        + th1C (O7V): 0.1
        + th1A and th1D (B0.5V): 0.2
        + th2A (O9V): 0.1
      + The He II 4200, 4541 lines that are seen in absorption show depths in the Orion spectra of about 3-4%, which is 4-5 times less that that seen in th1C.
      + If there were similar dilution of the Si IV feature, then this would be about a 2% absorption with a width of about 2 Angstrom.  EW ~= 0.04 \AA
      + But there may be less dilution since the later-type OB stars will contribute more than in the case of the He II lines.  Say that the continuum is 50% atomic, 25% th1C and 25% th1A/D, then the absorption will be 7%, with an EW of 0.15 \AA
      + But in that case, the high-resolution Esteban spectra should show a broad absorption trough with a narrower emission line
        + Even Adal's spectra should show that, and they don't
      + The 4089.29 emission line should have an EW of about -0.1 \AA
      + For comparison, the 4649 line has an EW of about -0.5 \AA
  + Try to find quantitative data on the lines from Storey (1994).  These are effective recombination coefficients in units of (1e-14 cm^{3} s^{-1}) for the whole multiplet as a function of T, and for n = 1e4
    | Mult | Transition             | wav (nm) |   n | Case | 5000 | 7500 | 10,000 | 12,500 | 15,000 | 20,000 |
    |------+------------------------+----------+-----+------+------+------+--------+--------+--------+--------|
    |    1 | 3p (.^{4}D^{o}) -- 3s (.^{4}P^{e}) |    465.2 | 1e4 | A    | 60.3 | 43.8 |   34.9 |   29.5 |   25.9 |   21.9 |
    |      |                        |          | 1e4 | B    | 62.4 | 45.4 |   36.2 |   30.6 |   26.9 |   22.8 |
    |      |                        |          | 1e2 | A    | 59.8 | 43.5 |   34.7 |   29.3 |   25.8 |   21.9 |
    |      |                        |          | 1e2 | B    | 61.8 | 45.1 |   36.0 |   30.5 |   26.8 |   22.7 |
    |      |                        |          | 1e6 | A    | 61.4 | 44.2 |   35.0 |   29.5 |   25.9 |   21.9 |
    |      |                        |          | 1e6 | B    | 63.6 | 45.8 |   36.3 |   30.6 |   26.9 |   22.7 |
  + So there is a difference of 5% between Case A/B but almost no dependence on density.
  + This is the data from NIST on the 4591 and 4649 line.  
    | Obs Wav (Å) | Ritz Wav (Å) | Aki (s-1) | Ei  (cm-1)  | Ek  (cm-1)  | Lower Level         | Upper Level          |
    |-------------+--------------+-----------+-------------+-------------+---------------------+----------------------|
    | 4 590.972   | 4 590.974    |  8.85e+07 | 206 971.68  | 228 747.45  | 2s22p2(1D)3s 2D 5/2 | 2s22p2(1D)3p 2F° 7/2 |
    | 4 649.1348  | 4 649.1347   |  7.84e+07 | 185 499.124 | 207 002.482 | 2s22p2(3P)3s 4P 5/2 | 2s22p2(3P)3p 4D° 7/2 |
  + So the core electrons are in a different ang mom state for the 4591 line.
    + This seems to be referred to as the *parentage*: most lines are .^{3}P but 4591 is .^{1}D
    + According to Sec 4.2 of Storey (1994), it is low-temperature dielectronic recombination that populates the .^{1}D and .^{1}S parentages.  He says it is very small, and doesn't show results for any lines, claiming that they all have \alpha_{eff} < 1e-14 cm^{3} s^{-1}
    + Note that the 4650 multiplet has a total recombination coefficient of about 4.4e-13 @ 7500 K, of which the 4649 line represents about 35% at a density of 1e4 pcc
  + Measurements from Figure of Fang & Liu for ratio, combined with data from Storey (1994) for V1:
    |     T | log10(4649 / 4591) | V1 4649 / V15 4591 |   Fit | Sum(V1) | 4649 @ 1e4 | 4591 @ 1e4 | V1 Dielec |
    |-------+--------------------+--------------------+-------+---------+------------+------------+-----------|
    |  1000 |               1.74 |              54.95 | 58.45 |         |         0. |      0.000 |   5.5e-12 |
    |  5000 |               0.75 |               5.62 |  5.46 |    60.3 |     21.105 |      3.755 |      0.01 |
    |  7500 |               0.62 |               4.17 |  4.06 |    43.8 |      15.33 |      3.676 |      0.04 |
    | 10000 |               0.55 |               3.55 |  3.55 |    34.9 |     12.215 |      3.441 |      0.19 |
    | 12500 |               0.51 |               3.24 |  3.31 |    29.5 |     10.325 |      3.187 |      0.61 |
    | 15000 |                0.5 |               3.16 |  3.17 |    25.9 |      9.065 |      2.869 |      1.38 |
    | 20000 |                    |                  1 |  3.04 |    21.9 |      7.665 |      7.665 |      4.04 |
    #+TBLFM: $3=10**$-1;f2::$4=2.85 + 0.7 ($1/1e4)**-1.9 ; f2::$6=0.35 $-1::$7=$6/$3;f3::$8=100 (0.1037 (1e4/$1) - 0.2657 + 0.2045 ($1/1e4) - 0.0028 ($1/1e4)**2) exp(-3.03 1e4 / $1) ; f2
  + So it looks like the 4591 line intensity is relatively insensitive to T
  + Dielectronic recombination rates:
    + Nusbaumer et al use an equation of the form:
    + 1e-12 [(a/t) + b + c t + d t^{2}] \times t^{-3/2} \times e^{-f/t } cm^{3} s^{-1}
    + Where t = T/1e4 K
      | a    |  0.1037 |
      | b    | -0.2657 |
      | c    |  0.2045 |
      | d    | -0.0029 |
      | f    |    3.03 |
      | Tmin |    3500 |
      | Y    |   0.002 |
    + So this gives negligibly small values and can be ignored
** TODO Combination with (Te, Ne) from He I lines
:LOGBOOK:
CLOCK: [2014-04-18 Fri 17:05]--[2014-04-18 Fri 17:24] =>  0:19
:END:
+ We find Ne, Te from the He lines
+ Data and calculations [[id:674FBA41-692F-4BB3-8A3B-14292CE4FE03][here in keck-revisited.org]]
+ From Porter et al. 2007 it looks like:
  + 5048/5876 is T_{e}-sensitive, almost insensitive to N_{e}
    + Ratio goes approx as T_{e}^{1/2} so it may be tricky since the ratio at 10^{4} K is 0.015
    + But at least the two lines are in the same waveband (green for Manu)
    + 5048 is not covered by the Adal spectra
  + 6678/5876 is N_{e}-sensitive, almost insensitive to T_{e}
    + But only 10% variation between 10^{3} and 10^{4} pcc so high-precision required
    + And also in same  waveband (red)
    + [2014-06-21 Sat] This seems to work for the Adal spectra
      + at least I get ratios that are well-correlated with the O II density ratios
      + but they need to be corrected for extinction
    + 
* Final calibration of WFC3 filters
** Doing the combined calibration for FQ575N
+ This is the filter that we need most
** Data to use
#+name: absorption-wavelengths
| He II | 4199.83 |
| He I  |    4388 |
| He II |    4541 |
| He II |    4686 |
| He II |    5411 |
| He II |    6682 |
|       |         |

#+name: extra-lines-for-adal
| [Fe II]  | 4249.08 |
| S III    | 4253.54 |
| O II     | 4275.55 |
| O II     | 4276.75 |
| [Fe II]  | 4276.83 |
| O II     | 4303.82 |
| O II     | 4317.14 |
| O II     | 4319.63 |
| O II     | 4325.76 |
| O I      | 4326.40 |
| [Cr II]  | 4336.79 |
| O II     | 4345.55 |
| [Fe III] | 4930.54 |
| [O III]  | 4931.32 |

#+name: line-wavelengths-orion
| He I          |   3964.73 |
| [Ne III]      |   3967.79 |
| H I           |   3970.07 |
| He I          |   4026.21 |
| ?on           |    4046.0 |
| [S II]/C III  |   4068.60 |
| [S II]/O II   |   4076.35 |
| H I           |   4101.74 |
| He I          |   4120.82 |
| O II          |   4121.46 |
| O II          |   4129.32 |
| [Fe III]      |   4131.94 |
| O II          |   4132.80 |
| He I          |   4143.76 |
| [Fe II]       |   4243.97 |
| C II          |   4267.15 |
| O II/[Fe II]  |   4276.83 |
| [Fe II]       |   4287.39 |
| H I           |   4340.47 |
| [Fe II]       |   4359.34 |
| [O III]       |   4363.21 |
| O I/O II      |   4368.19 |
| He I          |   4387.93 |
| [Fe II]/O II  |   4413.78 |
| [Fe II]/O II  |   4416.27 |
| He I          |   4437.55 |
| [Fe II]/O II  |   4452.11 |
| [Fe II]/Ne II |   4457.95 |
| O II          |   4465.41 |
| O II          |   4467.92 |
| He I          |   4471.09 |
| He II         |   4541.59 |
| [Mg I]        | 4562.6017 |
| Mg I]         | 4571.0956 |
| O II          |   4590.97 |
| O II/[Ni III] |   4596.18 |
| N II/O II     |   4601.48 |
| N II          |   4613.87 |
| N II/[Fe III] |   4607.16 |
| O II          |    4610.2 |
| N II/C II?    |   4621.39 |
| N II          |   4630.54 |
| N III         |   4634.14 |
| O II          |   4638.86 |
| N III         |   4640.64 |
| O II/N III    |   4641.81 |
| N II          |   4643.06 |
| O II          |   4649.13 |
| O II          |   4650.84 |
| [Fe III]      |   4658.10 |
| O II          |   4661.63 |
| [Fe III]      |   4667.01 |
| O II          |   4676.24 |
| [Fe III]      |   4701.62 |
| [Ar IV]       |   4711.37 |
| He I          |   4713.14 |
| [Fe III]      |   4733.93 |
| [Ar IV]       |   4740.17 |
| [Fe III]      |   4754.83 |
| [Fe III]      |    4769.6 |
| [Fe III]      |   4777.88 |
| H I           |   4861.32 |
| He I          |   4921.93 |
| [O III]       |   4958.91 |
| [O III]       |   5006.84 |
| He I          |   5015.68 |
| Si II         |   5041.03 |
| He I          |   5047.74 |
| Si II         |   5055.98 |
| O I           |   5146.61 |
| [Fe II]       |   5158.81 |
| [Ar III]      |   5191.82 |
| [N I]         |   5197.90 |
| [N I]         |   5200.26 |
| [Fe II]       |   5261.61 |
| [Fe III]      |   5270.40 |
| [Fe II]       |   5273.38 |
| O I           |   5298.89 |
| C II          |   5342.40 |
| [Fe III]      |   5412.00 |
| O II          |   5433.49 |
| S II          |   5453.81 |
| ???           |    5462.0 |
| O I           |   5512.77 |
| [Cl III]      |   5517.71 |
| [Cl III]      |   5537.88 |
| O I           |   5555.03 |
| [O I]/Sky     |   5577.34 |
| O III         |   5592.37 |
| N II          |   5666.64 |
| N II          |   5679.56 |
| [N II]        |   5755.08 |
| He I          |   5875.62 |
| ??            |    5890.0 |
| O I/Si II     |   5958.39 |
| Si II         |   5978.93 |
| O I           |   6046.23 |
| Sky           |      6136 |
| [O I]         |   6300.30 |
| [S III]       |   6312.06 |
| Si II         |   6347.11 |
| [O I]         |   6363.78 |
| Si II         |   6371.36 |
| Sky           |      6398 |
| C II          |   6454.77 |
| C II          |   6461.95 |
| [N II]        |   6548.05 |
| H I           |   6562.79 |
| C II          |   6578.05 |
| [N II]        |   6583.45 |
| He I          |   6678.15 |
| [S II]        |   6716.44 |
| [S II]        |  6730.816 |
| Sky           |      6864 |
| Sky           |      6924 |
| Sky           |      6959 |

#+tblname: clean-continuum-ranges
| 3920 | 3940 |
| 3990 | 4010 |
| 4222 | 4250 |
| 4290 | 4310 |
| 4414 | 4454 |
| 4490 | 4505 |
| 5280 | 5320 |
| 5360 | 5390 |
| 5450 | 5500 |
| 5620 | 5660 |
| 5700 | 5720 |
| 5780 | 5790 |
| 5900 | 5920 |
| 5970 | 6220 |
| 6790 | 6860 |
| 6880 | 7000 |



** Manu spectra
+ [X] manu-photom.py - we will fit only those fibers that are within the box of the WFC3 data
  + 60 x 60 arcsec box centered on 5:35:13.592, -5:24:11.04
  + th1C has coords of 5:35:16.452 -5:23:22.97 
    | 5@35'13.592" | 5@35'16.452" | 0@ 0' 42.736752" |
    | -5@24'11.04" | -5@23'22.97" | 0@ 0' 48.07"     |
    #+TBLFM: @1$3=15 cos(5) ($2 - $1)::@2$3=$2 - $1
  + So this puts the box center at (-43, -48) in arcsec
  + This is running, but is going to take all day
+ [X] Need to refactor - split into three parts:
  1. [X] Extract the spectra I need 
     - save a seperate JSON db for each section
  2. [X] Perform the Gaussian fits 
     - save fit parameters separately for each section, and in different files from the actual spectra
     - have flexible mechanism for doing/redoing particular sections and particular wavranges
     - tie together the wavelengths of lines of the same ion/multiplet
       - for instance, O II lines of the V1 multiplet
  3. [X] Produce the figures
+ [X] manu-calibration.py
  + Use the circular apertures of each fiber (2.69 arcsec diameter)
+ [X] process-orion-spectra-by-filter.py manu
  + Before we can do this, we need to do one of two things:
    1. Consolidate all the litle files into a big database, as we had before
    2. Change the program to use folders instead of one big database
  + [X] Option 1 would be simpler: manu-photom-consolidate.py
  + [X] And run the program

+ [X] Do the plots
  + 
*** Using the filesystem as a poor-man's database
+ Tha main concern is to allow multiple processes to be working on the line-fitting, either on the same machine or different machines
+ So we can use separate files for saving the fit parameters of each line for each position
+ Change to using =Positions= instead of =Sections=
  + =Manu-Data/Positions/blue-0140-0262.json= has the data written by =manu-photom-select.py=, which includes the arrays of wavelengths, fluxes, etc.
  + =Manu-Data/LineFit/blue-0140-0262/5299.json= has the fit data for the line 5299 

** ODH spectra
+ [X] odh-photom.py - this fits Gaussians to all the spectra in the three slit
+ [X] odh-calibration.py - this extracts the slit apertures from the WFC3 images 
+ [X] process-odh-spectra-by-filter.py - this reorganizes the spectra data to write a table for each filter, with all the necessary information.
+ [X] orion_compare_filters.py

** Adal spectra

#+BEGIN_SRC sh :results output
time python adal-calibration.py
#+END_SRC

#+RESULTS:
: WARNING: Overwriting existing file 'Adal_xslit5_north_pad.fits'. [astropy.io.fits.hdu.hdulist]
: WARNING: Overwriting existing file 'Adal_yslit5_north_pad.fits'. [astropy.io.fits.hdu.hdulist]
: WARNING: Overwriting existing file 'Adal_xslit6_north_pad.fits'. [astropy.io.fits.hdu.hdulist]
: WARNING: Overwriting existing file 'Adal_yslit6_north_pad.fits'. [astropy.io.fits.hdu.hdulist]

* Looking at the full-field images in the quad filters

** Remapping to the same frame using mosaic

*** Create header file from the 575 image
#+BEGIN_SRC sh :results verbatim
mGetHdr -h 1 ibrd02020_drz.fits full_FQ575N.hdr
#+END_SRC

#+RESULTS:
: [struct stat="OK", ncard=84]

Not sure if this is the best approach.

*** Alternatively, create a header file from scratch
#+BEGIN_SRC sh :results verbatim
PIXEL_SIZE=0.0396177738844  # in arcsec
WIDTH=0.033  # in degrees
RA=83.806997 
DEC=-5.4029576
mHdr -p $PIXEL_SIZE "$RA $DEC" $WIDTH  full_north.hdr
#+END_SRC

#+RESULTS:
: [struct stat="OK", count="16"]

*** Reproject the 6716 and 6731 filters to the common north frame
First the 6716 line
#+BEGIN_SRC sh :results verbatim
mProjectPP -h 1 ibrdb2020_drz.fits full_FQ672N_north.fits full_north.hdr
#+END_SRC

#+RESULTS:
: [struct stat="OK", time=7]

Then the 6731 line
#+BEGIN_SRC sh :results verbatim
mProjectPP -h 1 ibrda2020_drz.fits full_FQ674N_north.fits full_north.hdr
#+END_SRC

#+RESULTS:
: [struct stat="OK", time=7]

And the 5755 line
#+BEGIN_SRC sh :results verbatim
mProjectPP -h 1 ibrd02020_drz.fits full_FQ575N_north.fits full_north.hdr
#+END_SRC

#+RESULTS:
: [struct stat="OK", time=7]

Now grab the full filter images
#+BEGIN_SRC sh :results verbatim
mProjectPP -h 1 ibrd01080_quadalign.fits full_F673N_north.fits full_north.hdr
#+END_SRC

#+RESULTS:
: [struct stat="OK", time=10]

#+BEGIN_SRC sh :results verbatim
mProjectPP -h 1 ibrd01070_quadalign.fits full_F658N_north.fits full_north.hdr
#+END_SRC

#+RESULTS:
: [struct stat="OK", time=10]

#+BEGIN_SRC sh :results verbatim
mProjectPP -h 1 ibrd010b0_quadalign.fits full_F547M_north.fits full_north.hdr
#+END_SRC

#+RESULTS:
: [struct stat="OK", time=9]



**** [2014-03-20 Thu] New re-projections for the filters that are missing
***** Check what we have
#+BEGIN_SRC python :results output verbatim
from astropy.io import fits
import glob
import os
for fn in glob.glob("ibrd*_drz.fits"):
    hdu = fits.open(fn)[0]
    filt = hdu.header.get("FILTER")
    texp = hdu.header.get("EXPTIME")
    print(fn, filt, texp)
    if texp > 600.0:
        os.symlink(fn, filt + "_drz.fits")
#+END_SRC

#+RESULTS:
#+begin_example
ibrd01040_drz.fits F656N 698.0
ibrd01050_drz.fits F487N 818.0
ibrd01060_drz.fits F502N 696.0
ibrd01070_drz.fits F658N 1204.0
ibrd01080_drz.fits F673N 1400.0
ibrd01090_drz.fits F953N 826.0
ibrd010a0_drz.fits F469N 1778.0
ibrd010b0_drz.fits F547M 696.0
ibrd010c0_drz.fits FQ436N 1650.0
ibrd02020_drz.fits FQ575N 2400.0
ibrd03020_drz.fits FQ437N 2550.0
ibrda2020_drz.fits FQ674N 1800.0
ibrda2i4q_drz.fits FQ575N 550.0
ibrdb2020_drz.fits FQ672N 2550.0
#+end_example

Full table of files at =/fs/nas11/other0/will/Orion/Rubin= on work machines

| ibrda2i4q_drz.fits | FQ575N |
| ibrd02020_drz.fits | FQ575N |
| ibrda2020_drz.fits | FQ674N |
| ibrdb2020_drz.fits | FQ672N |
| ibrd010c0_drz.fits | FQ436N |
| ibrd03020_drz.fits | FQ437N |
|--------------------+--------|
| ibrd01080_drz.fits | F673N  |
| ibrd01070_drz.fits | F658N  |
| ibrd010b0_drz.fits | F547M  |
| ibrd01040_drz.fits | F656N  |
| ibrd01060_drz.fits | F502N  |
| ibrd01090_drz.fits | F953N  |
| ibrd01050_drz.fits | F487N  |
| ibrd010a0_drz.fits | F469N  |
|--------------------+--------|

***** Reprojection of files that are missing
New measurements of the star position using ds9
#+BEGIN_EXAMPLE
FQ672N  
 83.812094 -5.4032798 fk5  697.83528 774.74739  3.2865 
FQ437N
 83.812065 -5.4031598 fk5  1344.0477 742.03222  0.553982 
FQ436N
 83.812202 -5.4032522 fk5  998.00044 620.80422  0.872861 
F656N
 83.812157 -5.4032275 fk5  1295.8463 336.65498  13.0402 
F502N
 83.812161 -5.4032301 fk5  1295.9628 336.21506  7.95772 
F953N
 83.812175 -5.4032327 fk5  1295.918 334.97176  30.477
F487N 
 83.812162 -5.4032299 fk5  1295.9111 336.10249  4.31186 
F469N
 83.812182 -5.4032326 fk5  1295.6935 334.2709  1.33216 
#+END_EXAMPLE

Extract just the x, y pixel positions from that
#+name: align-tab
| FQ437N | 1344.0477 | 742.03222 |
| FQ436N | 998.00044 | 620.80422 |
| F656N  | 1295.8463 | 336.65498 |
| F502N  | 1295.9628 | 336.21506 |
| F953N  |  1295.918 | 334.97176 |
| F487N  | 1295.9111 | 336.10249 |
| F469N  | 1295.6935 |  334.2709 |

Change the header to align on the reference star by just changing the =CRPIX= values
#+BEGIN_SRC python :results output :var tab=align-tab
from astropy.io import fits
for fn, x, y in tab:
    hdu = fits.open(fn + "_drz.fits")["SCI"]
    hdu.header["CRPIX1"] = x
    hdu.header["CRPIX2"] = y
    hdu.header["CRVAL1"] = 83.812093
    hdu.header["CRVAL2"] = -5.4032792
    hdu.writeto(fn + "_quadalign.fits")
#+END_SRC

#+RESULTS:

And now use montage to resample the images onto a common grid:

#+BEGIN_SRC sh :results verbatim output
for f in F*_quadalign.fits; do
    ff=full_$(basename $f _quadalign.fits)_north.fits
    echo $ff
    mProjectPP -h 1 $f $ff full_north.hdr
done
#+END_SRC

#+RESULTS:
#+begin_example
full_F469N_north.fits
[struct stat="OK", time=9]
full_F487N_north.fits
[struct stat="OK", time=10]
full_F502N_north.fits
[struct stat="OK", time=9]
full_F656N_north.fits
[struct stat="OK", time=9]
full_F953N_north.fits
[struct stat="OK", time=10]
full_FQ436N_north.fits
[struct stat="OK", time=6]
full_FQ437N_north.fits
[struct stat="OK", time=6]
#+end_example

And fix up the padding to be common to all images too.
#+BEGIN_SRC python :results output
import pad_utils
for filt in "FQ436N", "FQ437N", "F469N", "F487N", "F502N", "F656N", "F953N":
    pad_utils.pad(filt)
#+END_SRC

#+RESULTS:


**** Align with reference star

***** Measurements
+ ibrd01080_drz.fits
  + 83.812165 -5.4032314 fk5  1295.9822 335.83442  20.3025
+ ibrd01070_drz.fits
  + 83.812167 -5.4032311 fk5  1295.9427 335.71015  7.96115 
+ ibrd010b0_drz.fits
  + 83.812185 -5.4032365 fk5  1296.0257 333.98523  54.1418 
+ FQ672N
  + 83.812093 -5.4032792 fk5  1039.2334 1470.9976  2.73852
***** Code
We set the reference pixel at the star to be the coordinates measured from the quad filter image
#+BEGIN_SRC python :results output
from astropy.io import fits
hdu = fits.open("ibrd01080_drz.fits")["SCI"]
hdu.header["CRPIX1"] = 1295.9822 
hdu.header["CRPIX2"] = 335.83442
hdu.header["CRVAL1"] = 83.812093
hdu.header["CRVAL2"] = -5.4032792
hdu.writeto("ibrd01080_quadalign.fits")
#+END_SRC

#+RESULTS:

#+BEGIN_SRC python :results output
from astropy.io import fits
hdu = fits.open("ibrd01070_drz.fits")["SCI"]
hdu.header["CRPIX1"] = 1295.9427
hdu.header["CRPIX2"] = 335.71015
hdu.header["CRVAL1"] = 83.812093
hdu.header["CRVAL2"] = -5.4032792
hdu.writeto("ibrd01070_quadalign.fits")
#+END_SRC

#+RESULTS:

#+BEGIN_SRC python :results output
from astropy.io import fits
hdu = fits.open("ibrd010b0_drz.fits")["SCI"]
hdu.header["CRPIX1"] = 1296.0257
hdu.header["CRPIX2"] = 333.98523
hdu.header["CRVAL1"] = 83.812093
hdu.header["CRVAL2"] = -5.4032792
hdu.writeto("ibrd010b0_quadalign.fits")
#+END_SRC

#+RESULTS:

*** Fix up the images so they are all the full size
+ Annoyingly, it turns out that =mProjectPP= crops the output images to the maximum extent of the input image, which is different for each filter.
+ So we need to undo that somehow


**** Try it by hand
#+BEGIN_SRC python results: output :tangle pad_utils.py
  import numpy as np
  from astropy.io import fits
  nxx, nyy = 2999, 2999
  ii0, jj0 = 1500.0, 1500.0
  
  def pad_image_to_header(hdu):
      """Pad to a common size with alignment of the reference pixel
      """
      outimage = np.empty((nyy, nxx), dtype=float)
      outimage[:,:] = np.nan
      i0, j0 = hdu.header["CRPIX1"], hdu.header["CRPIX2"]  
      nx, ny = hdu.header["NAXIS1"], hdu.header["NAXIS2"]  
      # Corners of output image to fill with input image
      ii1 = ii0 - i0
      ii2 = ii1 + nx
      jj1 = jj0 - j0
      jj2 = jj1 + ny
      # Fill it in
      inshape = hdu.data.shape
      outshape = outimage[jj1:jj2, ii1:ii2].shape
      assert outshape == inshape, (ii1, ii2, jj1, jj2, outshape, inshape)
      outimage[jj1:jj2, ii1:ii2] = hdu.data
      return outimage
  
  def pad(filt):
      prefix = "full_" + filt
      hdu = fits.open(prefix + "_north.fits")[0]
      hdu.data = pad_image_to_header(hdu)
      hdu.header["NAXIS1"] = nxx
      hdu.header["NAXIS2"] = nyy
      hdu.header["CRPIX1"] = ii0
      hdu.header["CRPIX2"] = jj0
      hdu.writeto(prefix + "_north_pad.fits", clobber=True)
  
#+END_SRC


#+BEGIN_SRC python :results output
import pad_utils
for filt in "FQ575N", "FQ672N", "FQ674N", "F658N", "F673N", "F547M":
    pad_utils.pad(filt)
#+END_SRC
#+RESULTS:
: None

*** Now take the ratio of the two [S II] lines
#+BEGIN_SRC python
from astropy.io import fits
hdu6716 = fits.open("full_FQ672N_north_pad.fits")[0]
hdu5755 = fits.open("full_FQ575N_north_pad.fits")[0]

hdu6716.data /= hdu5755.data
hdu6716.writeto("full_FQ672N_over_FQ575N.fits", clobber=True)
#+END_SRC

#+RESULTS:
: None

*** And the ratio of (672 + 674)/673
#+BEGIN_SRC python
from astropy.io import fits
hdu6716 = fits.open("full_FQ672N_north_pad.fits")[0]
hdu6731 = fits.open("full_FQ674N_north_pad.fits")[0]
hdusum = fits.open("full_F673N_north_pad.fits")[0]

hdu6716.data = (hdu6716.data + hdu6731.data)/hdusum.data
hdu6716.writeto("full_FQ672N_plus_FQ674N_over_F673N.fits", clobber=True)
#+END_SRC

#+RESULTS:
: None

This will have a dependence on the continuum 
*** And the ratio of 673/547
#+BEGIN_SRC python :results output
from astropy.io import fits
hdu673 = fits.open("full_F673N_north_pad.fits")[0]
hdu547 = fits.open("full_F547M_north_pad.fits")[0]

hdu673.data /= hdu547.data
hdu673.writeto("full_F673N_over_F547M.fits", clobber=True)
#+END_SRC

#+RESULTS:

*** And the difference between the two of those
#+BEGIN_SRC python :results output
from astropy.io import fits
hduA = fits.open("full_F673N_over_F547M.fits")[0]
hduB = fits.open("full_FQ672N_plus_FQ674N_over_F673N.fits")[0]

hduA.data = (hduA.data - 0.2)/(0.46 - 0.2)
hduB.data = (hduB.data - 0.48)/(0.75 - 0.48)
hduB.data -= hduA.data
hduB.writeto("full_FQ672N_FQ674N_combo.fits", clobber=True)
#+END_SRC

#+RESULTS:
: WARNING: Overwriting existing file 'full_FQ672N_FQ674N_combo.fits'. [astropy.io.fits.hdu.hdulist]

*** Using the 672, 673, 674 filters to reconstruct the continuum
+ The widths of these filters are very different
  + 672: 19.4
  + 673: 117.9
  + 674: 17.6
*** And the ratio of [N II] to [S II]
#+BEGIN_SRC python
from astropy.io import fits
hdu6716 = fits.open("full_FQ672N_north_pad.fits")[0]
hdu6731 = fits.open("full_FQ674N_north_pad.fits")[0]

hdu6716.data /= hdu6731.data
hdu6716.writeto("full_FQ672N_over_FQ674N.fits", clobber=True)
#+END_SRC
** And try smoothing the images to ground-based resolutions
#+BEGIN_SRC sh
python wfc3-smooth.py
#+END_SRC

#+RESULTS:

* Again revisited [2013-12-19 Thu]

** Cleaning up the full-field images
#+BEGIN_SRC sh :results output
python ~/Work/HST-STIS/spotless/spotless.py --data-range 0 10.0 --multi-hdu --allow-shadows --output-id cr --verbose --debug ../F547M
#+END_SRC

#+RESULTS:
: Warning: HDU 'SCI' not found, using the first one instead
: Finding bad pixels by the 'edge' method
: Data scaled to range [0.00e+00, 1.00e+01]
: Edge detection with Canny method complete
: Filling of holes complete
: Number of bad pixels: 24579 (0.132% of total)
: Number of distinct bad pixel objects found: 1311
: Number of objects skipped:  56
: Replacement of bad pixels complete

#+BEGIN_SRC sh :results output
python ~/Work/HST-STIS/spotless/spotless.py --data-range 0 1.0 --multi-hdu --allow-shadows --output-id cr --verbose --debug ../F469N
#+END_SRC

#+RESULTS:
: Warning: HDU 'SCI' not found, using the first one instead
: Finding bad pixels by the 'edge' method
: Data scaled to range [0.00e+00, 1.00e+00]
: Edge detection with Canny method complete
: Filling of holes complete
: Number of bad pixels: 72709 (0.392% of total)
: Number of distinct bad pixel objects found: 4665
: Number of objects skipped:  73
: Replacement of bad pixels complete

** Comparison of my method with Bob's method
Start with the NII line ratio.

*** My way
+ EW = [(169/k) (575/547) - 4.7] / 0.26
+ 169/4.7 = 35.96
+ In A6.2 of Ring Paper I, Bob recommends multiplying this by 1.4
  + This gives 1.4 35.96 = 50.344
  + Looks like 1.2 might be a better number
    + This will give us a mean T more similar to Adal's values
*** Bob's way
+ Correction term
  + 1 + (50.44 k^{}^{-1} 575/547 - 1)^{-1}
  + k = 0.9356 according to Bob - compares very well with my 0.938
+ From 575, 658, 547 to observed rnii
  + term575 = 53.91 575/547
  + term658 = 26.08 658/547
+ Extinction correction
+ From ratios to T,n

** O'Dell & Harris observations

*** Table of slits
#+name: odh-tab2
| Sample       | Length | Center position     | Distance |           Date | Exp Time | c(Hb) |    S(Hb) | EW(Hb) |
|--------------+--------+---------------------+----------+----------------+----------+-------+----------+--------|
| 1-east       |    214 | 5:35:23.7 -5:19:23  |      4.5 |       11-25-08 |      600 |  0.51 | 5.44E-14 |    110 |
| 1-west       |    214 | 5:35:09.3  -5:19:23 |      4.3 |       11-25-08 |      600 |  0.33 | 4.61E-14 |    170 |
| 2-east       |    130 | 5:35:26.5  -5:19:53 |      4.5 |       11-25-08 |      120 |  0.36 | 2.93E-14 |    120 |
| 2-mid        |    130 | 5:35:16.5  -5:19:53 |      3.5 |       11-25-08 |      120 |  0.42 | 2.16E-13 |    270 |
| 2-west       |    130 | 5:35:09.3  -5:19:53 |      4.1 |       11-25-08 |      120 |  0.15 | 1.33E-13 |    400 |
| 3-east       |    130 | 5:35:26.5  -5:20:23 |      4.1 |       11-25-08 |      600 |  0.73 | 2.10E-13 |    130 |
| 3-mid        |    130 | 5:35:16.5  -5:20:23 |      3.0 |       11-25-08 |      600 |  0.53 | 4.13E-13 |    270 |
| 3-west       |    130 | 5:35:09.3  -5:20:23 |      3.7 |       11-25-08 |      600 |  0.20 | 1.92E-13 |    150 |
| 4-east       |    130 | 5:35:26.5  -5:20:53 |      3.7 |       11-25-08 |      180 |  0.48 | 1.27E-13 |    160 |
| 4-mid        |    130 | 5:35:16.5  -5:20:53 |      2.5 |       11-25-08 |      180 |  0.54 | 5.72E-13 |    320 |
| 4-west       |    130 | 5:35:09.3  -5:20:53 |      3.3 |       11-25-08 |      180 |  0.26 | 2.72E-13 |    370 |
| 5-east       |    ~70 | 5:35:28.5  -5:21:23 |      3.8 |       11-25-08 |      120 |  0.85 | 1.35E-13 |    120 |
| 5-mid        |    263 | 5:35:17.3  -5:21:23 |      2.0 |       11-25-08 |      120 |  0.58 | 8.42E-13 |    340 |
| 5-west       |    ~96 | 5:35:05.3  -5:21:23 |      3.2 |       11-25-08 |      120 |  0.21 | 2.31E-13 |    400 |
| 6-east       |    ~70 | 5:35:28.5  -5:21:53 |      3.6 |       11-25-08 |      120 |  0.87 | 2.09E-13 |    150 |
| 6-mid        |    263 | 5:35:17.3  -5:21:53 |      1.5 |       11-25-08 |      120 |  0.69 | 1.37E-12 |    380 |
| 6-west       |    ~96 | 5:35:05.3  -5:21:53 |      2.9 |       11-25-08 |      120 |  0.24 | 2.46E-13 |    350 |
| 7-east       |    178 | 5:35:24.9  -5:22:23 |      2.5 |       11-25-08 |       60 |  1.08 | 7.33E-13 |    170 |
| 7-mid        |    126 | 5:35:14.7  -5:22:23 |      1.0 |       11-25-08 |       60 |  0.71 | 2.70E-12 |    480 |
| 7-west       |    125 | 5:35:06.3  -5:22:23 |      2.5 |       11-25-08 |       60 |  0.27 | 3.55E-13 |    410 |
| 8-east       |    178 | 5:35:25.1  -5:22:53 |      2.3 |       11-25-08 |       60 |  0.98 | 4.48E-13 |    140 |
| 8-mid        |    126 | 5:35:14.7  -5:22:53 |      0.5 |       11-25-08 |       60 |  0.60 | 2.66E-12 |    460 |
| 8-west       |    125 | 5:35:06.3  -5:22:53 |      2.3 |       11-25-08 |       60 |  0.26 | 3.72E-13 |    380 |
| 9-east       |    ~90 | 5:35:14.4  -5:23:27 |      1.3 |       11-19-08 |     3300 |  0.94 | 2.63E-12 |    270 |
| 9-mid        |    ~52 | 5:35:05.7  -5:23:27 |      1.0 |       11-19-08 |     3300 |  0.33 | 1.87E-12 |    430 |
| 9-west       |    198 | 5:34:55.3  -5:23:27 |      3.6 |       11-19-08 |     3300 |  0.22 | 1.20E-13 |    370 |
| 10-east      |    143 | 5:35:26.1  -5:23:53 |      2.5 |       11-25-08 |       60 |  0.44 | 1.05E-12 |    380 |
| 10-mid       |    143 | 5:35:16.5  -5:23:53 |      0.5 |       11-25-08 |       60 |  0.60 | 2.83E-12 |    470 |
| 10-west      |    143 | 5:35:06.9  -5:23:53 |      2.3 |       11-25-08 |       60 |  0.29 | 4.36E-13 |    390 |
| 11-east      |    143 | 5:35:26.1  -5:24:23 |      2.8 |       11-25-08 |       60 |  0.41 | 9.41E-13 |    320 |
| 11-mid       |    143 | 5:35:16.5  -5:24:23 |      1.0 |       11-25-08 |       60 |  0.56 | 2.12E-12 |    480 |
| 11-west      |    143 | 5:35:06.9  -5:24:23 |      2.4 |       11-25-08 |       60 |  0.26 | 3.25E-13 |    380 |
| 12-east      |    111 | 5:35:27.2  -5:24:53 |      3.0 |       11-25-08 |      120 |  0.19 | 2.68E-13 |    210 |
| 12-mid       |    139 | 5:35:16.4  -5:24:53 |      1.5 |       11-25-08 |      120 |  0.60 | 2.17E-12 |    430 |
| 12-west      |    143 | 5:35:06.9  -5:24:53 |      2.6 |       11-25-08 |      120 |  0.37 | 3.93E-13 |    400 |
| 13-east      |    143 | 5:35:26.1  -5:25:23 |      3.4 |       11-25-08 |      120 |  0.22 | 3.25E-13 |    220 |
| 13-mid       |    143 | 5:35:16.5  -5:25:23 |      2.0 |       11-25-08 |      120 |  0.54 | 1.25E-12 |    430 |
| 13-west      |    143 | 5:35:06.9  -5:25:23 |      2.9 |       11-25-08 |      120 |  0.37 | 3.62E-13 |    270 |
| 14-east      |    143 | 5:35:26.1  -5:25:53 |      3.6 |       11-25-08 |      240 |  0.17 | 2.19E-13 |    300 |
| 14-mid       |    143 | 5:35:16.5  -5:25:53 |      2.5 |       11-25-08 |      240 |  0.46 | 5.27E-13 |    330 |
| 14-west      |    143 | 5:35:06.9  -5:25:53 |      3.3 |       11-25-08 |      240 |  0.21 | 2.26E-13 |    450 |
| 15-east      |    143 | 5:35:26.1  -5:26:23 |      3.9 |       11-25-08 |      360 |  0.18 | 2.01E-13 |    330 |
| 15-mid       |    143 | 5:35:16.5  -5:26:23 |      3.0 |       11-25-08 |      360 |  0.42 | 2.91E-13 |    300 |
| 15-west      |    143 | 5:35:06.9  -5:26:23 |      3.7 |       11-25-08 |      360 |  0.21 | 1.64E-13 |    380 |
| 16-east      |    143 | 5:35:26.1  -5:27:23 |      4.8 |       11-25-08 |      600 |  0.13 | 1.33E-13 |    370 |
| 16-mid       |    143 | 5:35:16.5  -5:27:23 |      4.0 |       11-25-08 |      600 |  0.29 | 1.34E-13 |    280 |
| 16-west      |    143 | 5:35:06.9  -5:27:23 |      4.5 |       11-25-08 |      600 |  0.13 | 6.12E-14 |    260 |
| 17           |    429 | 5:35:16.5  -5:29:23 |      6.0 |       11-25-08 |      600 |  0.02 | 2.50E-14 |    230 |
| 18           |    429 | 5:35:13.6  -5:30:23 |      7.0 |        1-16-09 |      600 |     0 | 2.62E-14 |    250 |
| 19-east      |    168 | 5:35:48.7  -5:31:23 |     11.3 |        1-16-09 |     1800 |  0.12 | 1.54E-14 |    160 |
| 19-west      |    261 | 5:35:34.3  -5:31:23 |      9.1 |        1-16-09 |     1800 |     0 | 1.48E-14 |    280 |
| 20           |    429 | 5:35:13.6  -5:31:23 |      8.0 |        1-16-09 |     1200 |     0 | 2.09E-14 |    300 |
| 21           |    429 | 5:35:13.6  -5:33:23 |     10.0 |        1-16-09 |     1200 |     0 | 1.87E-14 |    300 |
| 22           |    429 | 5:35:13.6  -5:35:23 |     12.0 |        1-16-09 |     1200 |     0 | 1.16E-14 |    250 |
| 23           |    429 | 5:35:13.6  -5:37:23 |     14.0 |        1-16-09 |     1200 |     0 | 8.20E-15 |    210 |
| 24-north     |    156 | 5:35:13.0  -5:25:54 |      2.5 |       11-21-08 |     5000 |  0.35 | 6.34E-13 |    350 |
| 24-south     |    168 | 5:35:06.7  -5:30:03 |      7.0 |       11-21-08 |     5000 |     0 | 2.07E-14 |    190 |
| 25-NE        |    120 | 5:35:01.4  -5:28:26 |      6.2 |       11-21-08 |     4200 |  0.06 | 3.74E-14 |    180 |
| 25-SW        |    116 | 5:34:48.6  -5:32:35 |     11.4 |       11-21-08 |     4200 |     0 | 1.03E-14 |    130 |
| 26-north     |    111 | 5:34:46.9  -5:32:24 |     11.0 |       11-22-08 |     3600 |     0 | 4.69E-15 |     30 |
| 26- south    |    ~77 | 5:34:46.9  -5:36:59 |     15.6 |       11-22-08 |     3600 |     0 | 1.18E-14 |     80 |
| 27-east      |    234 | 5:34:48.0  -5:25:14 |      7.5 |       11-22-08 |     1800 |     0 | 2.39E-14 |    400 |
| 27-west      |    195 | 5:34:33.6  -5:25:14 |     10.9 |       11-22-08 |     1800 |  0.01 | 1.65E-14 |    370 |
| 28-east      |    195 | 5:34:14.8  -5:26:02 |     16.0 |       11-22-08 |     3600 |  0.07 | 1.33E-14 |    480 |
| 28-west      |    209 | 5:33:59.6  -5:26:02 |     19.6 |       11-22-08 |     3600 |  0.21 | 7.54E-15 |    270 |
| A-east       |    ~53 | 5:35:37.7 -5:16:23  |       97 | 12-09+13+14-09 |     3200 |  0.68 | 1.49E-14 |     90 |
| A-mid        |    ~43 | 5:35:31.2 -5:16:23  |       23 | 12-09+13+14-09 |     3200 |  0.77 | 2.68E-13 |     80 |
| A-rift       |   ~ 46 | 5:35:34.2 -5:16:23  |       47 | 12-09+13+14-09 |     3200 |  1.20 | 2.19E-13 |     60 |
| A-west       |    121 | 5:35:25.8 -5:16:23  |       89 | 12-09+13+14-09 |     3200 |  0.54 | 1.43E-13 |    150 |
| A(N-S)-north |    ~91 | 5:35:30.0 -5:14:32  |       98 |    12-12+15-09 |     3600 |  1.04 | 1.78E-13 |    150 |
| A(N-S)-mid   |    113 | 5:35:30.0 -5:15:59  |       21 |    12-12+15-09 |     3600 |  0.71 | 2.57E-13 |    130 |
| A(N-S)-south |    108 | 5:35:30.0 -5:17:57  |      119 |    12-12+15-09 |     3600 |  0.66 | 8.31E-14 |    110 |
| B            |    345 | 5:34:47.0 -5:27:40  |      8.5 |    12-12+15-09 |     4500 |     0 | 2.17E-14 |    450 |
| B1991        |    ~61 | 5:35:07.9 -5:22:27  |      2.1 |       12-14-09 |      120 |  0.19 | 2.99E-13 |    340 |
| C            |    344 | 5:34:35.5 -5:27:21  |     11.0 |    12-12+15-09 |     4500 |     0 | 1.29E-14 |    400 |
| D-NE         |    156 | 5:34:32.7 -5:26:05  |     11.4 |    12-13+14-09 |     2400 |     0 | 1.48E-14 |    480 |
| D-NW         |    156 | 5:34:20.0 -5:25:05  |     14.4 |    12-13+14-09 |     2400 |  0.06 | 2.06E-14 |    640 |
| D-SE         |    156 | 5:34:32.7 -5:27:06  |     11.7 |       12-14-09 |     1200 |     0 | 1.30E-14 |    410 |
| D-SW         |    156 | 5:34:20.0 -5:27:06  |     14.7 |       12-14-09 |     1200 |  0.03 | 1.60E-14 |    490 |
| D-north      |    ~57 | 5:34:26.3 -5:25:18  |     12.7 |    12-12+15-09 |     6500 |  0.01 | 2.42E-14 |    720 |
| D-south      |    ~79 | 5:34:26.3 -5:29:55  |     14.1 |    12-12+15-09 |     6500 |     0 | 9.91E-15 |    460 |
| E            |    344 | 5:34:13.9 -5:36:00  |     20.1 |    12-10+13-09 |     3000 |     0 | 1.53E-15 |    190 |
| F-north      |    221 | 5:33:50.4 -5:35:33  |     24.7 |    12-12+15-09 |     4500 |     0 | 3.85E-15 |    350 |
| F-south      |    124 | 5:33:50.4 -5:37:14  |     26.2 |    12-12+15-09 |     4500 |     0 | 3.22E-15 |    220 |
| G            |    344 | 5:33:23.6 05:39:21  |     30.8 |    12-12+15-09 |     4500 |     0 | 1.60E-15 |    150 |
| H            |    344 | 5:34:33.2 -5:42:24  |     21.9 |    12-10+13-09 |     4800 |     0 | 1.73E-15 |    200 |
| I            |    344 | 5:34:33.2 -5:45:20  |     24.5 |       12-14-09 |     1200 |     0 | 1.18E-15 |    140 |

*** Make a ds9 region file of the slit positions
#+BEGIN_SRC python :var tab=odh-tab2 :results output
text = """
global color=green dashlist=8 3 width=1 font="helvetica 10 normal roman" select=1 highlite=1 dash=0 fixed=0 edit=1 move=1 delete=1 include=1 source=1
fk5
"""
box_template = 'box({:s},{:s},{:.2f}",{:.2f}",0.0) # text={{{:s}}}'
width = 1.9, 2.6
for name, length, coords, D, Date, time, chb, Shb, EWhb in tab[1:]:
    ra, dec = coords.split()
    try:
        length = float(length.strip("~"))
    except AttributeError:
        length = float(length)
    if Date.startswith("12") and Date.endswith("09"):
        width = 2.6
    else:
        width = 1.9
    text += box_template.format(ra, dec, length, width, str(name)) + "\n"
with open("odell-harris-slits.reg", "w") as f:
    f.write(text)
#+END_SRC

#+RESULTS:


*** Table of fluxes for relevant slits
+ The 9-east slit does not actually overlap
+ The 10-mid and 11-mid slits do, but they extend a long way to the east as well
+ The "record" column is from Bob's notes on his comparison with the ODH spectra
  + presumably, this is for a custom portion of the slit in the overlap region
| Wavelength |   9-east |   10-mid |   11-mid |   record |
|------------+----------+----------+----------+----------|
|       3869 |        - |   0.1861 |   0.1700 |          |
|    4069+76 |        - |   0.0310 |   0.0178 |          |
|       4102 |        - |   0.2600 |   0.2503 |          |
|       4340 |   0.4852 |   0.4706 |   0.4751 |          |
|       4363 |   0.0157 |   0.0100 |   0.0088 |          |
|       4471 |   0.0462 |   0.0454 |   0.0439 |          |
|       4658 |   0.0077 |   0.0095 |   0.0092 |          |
|       4861 |   1.0000 |   1.0000 |   1.0000 |          |
|       4959 |   1.0429 |   1.0276 |   0.9889 |          |
|       5007 |   3.2126 |   3.1027 |   2.9771 |          |
|       5199 |   0.0031 |   0.0030 |   0.0030 |          |
| 5262+70+73 |   0.0040 |        - |        - |          |
|       5518 |   0.0040 |   0.0035 |   0.0035 |          |
|       5538 |   0.0048 |   0.0045 |   0.0049 |          |
|       5755 |   0.0051 |   0.0108 |   0.0070 |          |
|       5876 |   0.1337 |   0.1326 |   0.1315 |          |
|       5979 |   0.0009 |   0.0007 |   0.0012 |          |
|       6300 |   0.0040 |   0.0126 |   0.0069 |          |
|       6312 |   0.0163 |   0.0174 |   0.0145 |          |
|    6348+71 |   0.0028 |   0.0027 |   0.0037 |          |
|       6363 |   0.0013 |   0.0038 |   0.0023 |          |
|       6548 |   0.1497 |   0.1808 |   0.1259 |          |
|       6563 |   2.8907 |   2.8907 |   2.8906 |          |
|       6583 |   0.4003 |   0.5031 |   0.4071 |          |
|       6678 |   0.0340 |   0.0350 |   0.0348 |          |
|       6716 |   0.0341 |   0.0281 |   0.0295 |          |
|       6731 |   0.0452 |   0.0472 |   0.0481 |          |
|       7065 |        - |   0.0650 |   0.0615 |          |
|       7136 |        - |   0.1474 |   0.1408 |          |
|------------+----------+----------+----------+----------|
|      C(Hb) |     0.94 |     0.60 |     0.56 |          |
|      S(Hb) | 2.63E-12 | 2.83E-12 | 2.12E-12 |          |
|     EW(Hb) |      270 |      470 |      480 |          |
|------------+----------+----------+----------+----------|
|  6716/6731 |   0.7544 |   0.5953 |   0.6133 |   0.5316 |
|  5755/6583 |   0.0127 |   0.0215 |   0.0172 |   0.0221 |
|  4363/5007 |   0.0049 |   0.0032 |   0.0030 | 0.003783 |
|   EW(5755) |     1.47 |     5.41 |     3.58 |          |
|   EW(4363) |     3.26 |     3.62 |     3.25 |          |
|   EW(6716) |    11.51 |    16.51 |    17.70 |          |
#+TBLFM: @34$2..@34$4=@27/@28; f4::@35$2..@35$4=@16/@25;f4::@36$2..@36$4=@6/@11;f4::@37$2..@37$4=@33 @16 / 0.938; f2::@38$2..@38$4=@33 @6 / 1.3; f2::@39$2..@39$4=@33 @27 / 0.8; f2






























** Aligning the "north" images
Choose a faint star, 83.812024 -5.4032676 on the Bally image

#+name: wcs-info
| 658 | 549.47682 | 947.40207 |
| 575 | 549.53663 | 947.39367 |
| 547 | 547.89619 | 946.71499 |
| 436 | 549.53486 | 947.46514 |
| 487 | 549.53486 | 947.46514 |
| 437 | 549.23257 | 947.62798 |
| 469 |       548 |  947.6977 |
| 502 | 550.06973 | 947.76743 |
| 672 | 549.46514 | 947.76743 |
| 674 | 549.46514 | 947.76743 |
| 673 | 548.23257 | 947.46514 |

#+BEGIN_SRC python :var tab=wcs-info :results output
  from astropy.io import fits
  for wav, x, y in tab:
      infile = "north{}.fits".format(wav)
      outfile = infile.replace(".fits", "-wcs.fits")
      hdu = fits.open(infile)[0]
      hdu.header.update(CRPIX1=x, CRPIX2=y, CRVAL1=83.812024, CRVAL2=-5.4032676)
      hdu.writeto(outfile, clobber=True)

#+END_SRC

#+RESULTS:
#+begin_example
WARNING: Overwriting existing file 'north658-wcs.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'north575-wcs.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'north547-wcs.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'north436-wcs.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'north487-wcs.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'north437-wcs.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'north469-wcs.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'north502-wcs.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'north672-wcs.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'north674-wcs.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'north673-wcs.fits'. [astropy.io.fits.hdu.hdulist]
#+end_example


** Save the ipython notebook with the Rubin STIS slit calculations
#+BEGIN_SRC sh :results verbatim
ipython nbconvert "Rubin STIS Spectra.ipynb"
#+END_SRC

#+RESULTS:

#+BEGIN_SRC sh :results verbatim
ipython nbconvert --help
#+END_SRC

#+RESULTS:
#+begin_example
This application is used to convert notebook files (*.ipynb) to various other
formats.

WARNING: THE COMMANDLINE INTERFACE MAY CHANGE IN FUTURE RELEASES.

Options
-------

Arguments that take values are actually convenience aliases to full
Configurables, whose aliases are listed on the help line. For more information
on full configurables, see '--help-all'.

--stdout
    Write notebook output to stdout instead of files.
--init
    Initialize profile with default config files.  This is equivalent
    to running `ipython profile create <profile>` prior to startup.
--quiet
    set log level to logging.CRITICAL (minimize logging output)
--debug
    set log level to logging.DEBUG (maximize logging output)
--profile=<Unicode> (BaseIPythonApplication.profile)
    Default: 'default'
    The IPython profile to use.
--post=<DottedOrNone> (NbConvertApp.post_processor_class)
    Default: ''
    PostProcessor class used to write the  results of the conversion
--config=<Unicode> (BaseIPythonApplication.extra_config_file)
    Default: ''
    Path to an extra config file to load.
    If specified, load this config file in addition to any other IPython config.
--output=<Unicode> (NbConvertApp.output_base)
    Default: ''
    overwrite base name use for output files. can only  be use when converting
    one notebook at a time.
--ipython-dir=<Unicode> (BaseIPythonApplication.ipython_dir)
    Default: '/Users/will/.ipython'
    The name of the IPython directory. This directory is used for logging
    configuration (through profiles), history storage, etc. The default is
    usually $HOME/.ipython. This options can also be specified through the
    environment variable IPYTHONDIR.
--to=<CaselessStrEnum> (NbConvertApp.export_format)
    Default: 'html'
    Choices: ['custom', 'html', 'latex', 'markdown', 'python', 'rst', 'slides']
    The export format to be used.
--template=<Unicode> (Exporter.template_file)
    Default: 'default'
    Name of the template file to use
--log-level=<Enum> (Application.log_level)
    Default: 30
    Choices: (0, 10, 20, 30, 40, 50, 'DEBUG', 'INFO', 'WARN', 'ERROR', 'CRITICAL')
    Set the log level by value or name.
--writer=<DottedObjectName> (NbConvertApp.writer_class)
    Default: 'FilesWriter'
    Writer class used to write the  results of the conversion
--profile-dir=<Unicode> (ProfileDir.location)
    Default: ''
    Set the profile location directly. This overrides the logic used by the
    `profile` option.

To see all available configurables, use `--help-all`

Examples
--------

    The simplest way to use nbconvert is
    
    > ipython nbconvert mynotebook.ipynb
    
    which will convert mynotebook.ipynb to the default format (probably HTML).
    
    You can specify the export format with `--to`.
    Options include ['custom', 'html', 'latex', 'markdown', 'python', 'rst', 'slides']
    
    > ipython nbconvert --to latex mynotebook.ipnynb
    
    Both HTML and LaTeX support multiple output templates. LaTeX includes
    'basic', 'book', and 'article'.  HTML includes 'basic' and 'full'.  You 
    can specify the flavor of the format used.
    
    > ipython nbconvert --to html --template basic mynotebook.ipynb
    
    You can also pipe the output to stdout, rather than a file
    
    > ipython nbconvert mynotebook.ipynb --stdout
    
    A post-processor can be used to compile a PDF
    
    > ipython nbconvert mynotebook.ipynb --to latex --post PDF
    
    You can get (and serve) a Reveal.js-powered slideshow
    
    > ipython nbconvert myslides.ipynb --to slides --post serve
    
    Multiple notebooks can be given at the command line in a couple of 
    different ways:
    
    > ipython nbconvert notebook*.ipynb
    > ipython nbconvert notebook1.ipynb notebook2.ipynb
    
    or you can specify the notebooks list in a config file, containing::
    
        c.NbConvertApp.notebooks = ["my_notebook.ipynb"]
    
    > ipython nbconvert --config mycfg.py

#+end_example

** Interference patterns in the maps
+ The Hb/ha ratio has obvious interference patterns.  These have peak-to--peak amplitudes of about 5% in the worst cases.
** Modelling the variation in the 575/658 ratio
+ A large part will be caused by continuum, so should be correlated with 547/575
*** Simple line plus continuum model
+ F547M = Cont W547 T547
+ FQ575N = (Color Cont W575 + Line) T575
+ Where:
  + F... is the filter signal
  + W... is the width
    + W575 = 20.6
    + W547 = 650.0
  + T... is the peak throughput
    + T575 = 0.23
    + T547 = 0.26
  + Color is the 575/547 continuum ratio (\approx 0.938)
  + Cont, Line = continuum and line intensities
+ If we substitute for Cont, then
  + FQ575N = (Color F547M W575 /  (W547 T547) + Line) T575
  + FQ575N = (a F547M + Line) T575
  + Where a = Color W575 / W547 T547 =  0.938 20.6 / 0.26 650.0 = 0.114336094675
**** This is now done in my shiny notebook
EW vs 547/575 ratio:
| 547/575 |    EW |
|---------+-------|
|      15 | 31.79 |
|      20 | 18.73 |
|      25 | 10.90 |
|      30 |  5.68 |
|      35 |  1.95 |
#+TBLFM: $2=((169 / 0.938 $1 ) - 4.7 ) / 0.23 ;f2

** DONE Recheck the EW of Orion and Ring Nebula
CLOSED: [2013-12-21 Sat 11:26]
+ [[file:EW(%5BN%20II%5D%205755).ipynb][This ipython notebook]] has the calculations
+ Bottom line is 3 \AA EW for [N II] 5755 \AA in Orion
+ But that is for far-out regions.  In the Rubin slit we have 5 to 15 \AA
+ And 100 \AA in the Ring Nebula
** DONE Use Bally STIS slit for better estimate of color term
CLOSED: [2014-01-09 Thu 10:03]
+ Pixel scale is 2.746 \AA
+ Each line is about 100 \AA wide due to 2 arcsec slit
*** Conclusions from Bally HST10 slit spectrum
1. The 575/547 color correction is found to be 0.938, which is consistent within the errors with the value of 0.93 found from the Rubin spectrum
2. The "true" spatial variation (that is, corrected for noise, see below) in the color correction (for this slit) is about 0.5% RMS and occurs on scales of >= 100 pixels, or 5 arcsec
   + Since the WFC3 images may sample a wider range of conditions than the STIS slit, there may be larger variation there
3. The 469/547 color correction is 1.29 +/- 0.03 (pure continuum), or 1.36 +/- 0.03 (full He I + [Fe III] line contribution).  The actual case with the WFC3 F469N filter will lie between these two extremes.  The "true" variation in either case is about 2.7% RMS, but there is only a small correlation between the 469/547 and 575/547 continuum ratios: slope \(-0.09\) with \(R^{2 }< 17\%\).
   + As a result, it is probably not worth trying use 469/547 to estimate 575/547, since even in the absence of noise, all we could achieve would be to reduce the RMS from 0.5% to 0.45%.  /And/ we would be adding more noise, which is not good.
4. The "noise" (as measured by the variance between two narrow adjacent continuum bands) does not fall quite as steep as \(N^{{-1}}\).  We need to be aware of this when we try and noise-subtract the variance profiles.  This should not be such an issue with the images, since \(N\) increases quadratically with scale, instead of just linearly as it does with the spectra.
   + This is not so surprising, since it is only shot noise that falls as \(1/N\).  Read noise, dark current, flat-field variations, interference patterns, etc can all contribute to the noise and will behave differently.
   + [ ] We do have independent estimates of these for WFC3 from the studies of flats that I did for the Ring project - need to dig those up.  Although that was with white light so it wouldn't catch any interference fringes that appear with certain emission lines.
   + Cosmic rays also contribute to noise (since the CR removal is never perfect), and in a highly non-gaussian way.  

*** Lines that we can see in the G430L spectrum
+ NOT [N II] 5755
  + Unfortunately, this is just off the red side of the spectrum
+ [Cl III] 5518,38
  + Both of roughly equal strength
+ [Fe III] 5270
+ [N I] 5198,200
+ Other weak lines blending together
+ Overlap (very strong)
  + H\beta 4861
  + [O III] 4959
  + [O III] 5007
+ Overlap (similar strength)
  + He I 4713
  + [Fe III] 4658
  + The F469N (53.1 \AA) filter is 4662.25 \to 4715.35
    + So the lines are at the edges of the filters
    + We need to take into account that the filters are given in vacuum wavelengths
+ Overlap
  + He I 4471 (roughly 4 x stronger than 4363)
  + He I 4388 (2 \to 3 times weaker than 4363)
    + a tiny perturbation to 4471
  + H\gamma 4340 + [O III] 4363
    + The 4363 line can be seen as a slight bump on the blue side of the 4471 line
    + Also as a similar bump on 4340, but harder to see since 4340 is brighter
+ Overlap
  + H\delta 4101 strong
  + He I 4026
  + [S II] 
*** DONE Remove CRs with spotless.py
CLOSED: [2014-01-05 Sun 17:04]
#+BEGIN_SRC sh :results verbatim
cp /Users/will/Work/HST-STIS/Bally8324/o5gf57010_sx2.fits bally-stis-hst10-g430l.fits
python ~/Work/HST-STIS/spotless/spotless.py --data-range 0 3e-15 --multi-hdu --allow-shadows --output-id cr --include-regions-from-file bally-stis-hst10-g430l-badpix.reg --verbose --debug bally-stis-hst10-g430l
#+END_SRC

#+RESULTS:
#+begin_example
Finding bad pixels by the 'edge' method
Data scaled to range [0.00e+00, 3.00e-15]
Edge detection with Canny method complete
Filling of holes complete
WARNING: FITSFixedWarning: 'unitfix' made the change 'Changed units: 'angstrom' -> 'Angstrom''. [astropy.wcs.wcs]
Regions from bally-stis-hst10-g430l-badpix.reg added to bad pixels
Number of bad pixels: 91131 (6.318% of total)
Number of distinct bad pixel objects found: 245
Number of objects skipped:  4
Replacement of bad pixels complete
WARNING: Overwriting existing file 'bally-stis-hst10-g430l-cr.fits'. [astropy.io.fits.hdu.hdulist]
#+end_example

This is not perfect, but it will do for now

*** 
** DONE Use of the Rubin STIS slits to estimate color term
CLOSED: [2014-01-04 Sat 00:24]
+ We find a color correction of 0.93 in [[file:Rubin%20STIS%20spectra.ipynb][this ipynb file]]
  + There is no evidence that it varies with EW
  + On the other hand, there is the slight worry that the STIS spectra do not cover the entire spectral range of F547M
    + F547M has \lambda_{0} = 5447 \AA and \Delta\lambda = 650 \AA, so 5122 \to 5772 \AA
    + The STIS spectra go from 5448 upwards, so the bluemost extent is the center of the band
    + We are missing the short wavelength half of its bandpass (5122 \to 5448), which has 30% higher transmission than the long wavelength half that we have (5448 \to 5772)
    + We do have a bluer spectrum covering the range 4820 \to 5100
      + [X] We could test the range 5020 \to 5100 to see if that has any variation wrt 5448 \to 5772
        + Too noisy to be of much use
      + [X] Also look for any other STIS spectra in the archive
        + Bally spectrum is best

+ These /do not quite/ overlap with our region
+ [X] Work out which slits I need
+ [X] Combine pairs to remove cosmic rays
  + [X] Need to use spotless too
  + Final file =rubin-stis-slit1-5734-merge-cr.fits=
+ [X] CANCELED Take slice through the WFC3 images to compare with the different filters
  + Not so useful since no overlap with quad filters
*** DONE Using spotless on the STIS spectrum
CLOSED: [2013-12-31 Tue 16:42]

#+BEGIN_SRC sh :results verbatim
python ~/Work/HST-STIS/spotless/spotless.py --data-range 5e-15 1e-13 --use-log-scale --multi-hdu --output-id cr --verbose --debug --allow-shadows rubin-stis-slit1-5734-merge
#+END_SRC

#+RESULTS:
Finding bad pixels by the 'edge' method
Data scaled to range [5.00e-15, 1.00e-13]
Edge detection with Canny method complete
Filling of holes complete
Number of bad pixels: 8686 (0.602% of total)
Number of distinct bad pixel objects found: 216
Number of objects skipped:  3
Replacement of bad pixels complete
WARNING: Overwriting existing file 'rubin-stis-slit1-5734-merge-cr.fits'. [astropy.io.fits.hdu.hdulist]

#+BEGIN_SRC sh :results verbatim
python ~/Work/HST-STIS/spotless/spotless.py --data-range 5e-15 1e-13 --use-log-scale --multi-hdu --output-id cr --verbose --debug --allow-shadows rubin-stis-slit1-6581-merge
#+END_SRC

#+RESULTS:
: Finding bad pixels by the 'edge' method
: Data scaled to range [5.00e-15, 1.00e-13]
: Edge detection with Canny method complete
: Filling of holes complete
: Number of bad pixels: 30888 (2.141% of total)
: Number of distinct bad pixel objects found: 285
: Number of objects skipped:  25
: Replacement of bad pixels complete

#+BEGIN_SRC sh :results verbatim
python ~/Work/HST-STIS/spotless/spotless.py --data-range 0 5e-13 --multi-hdu --allow-shadows --output-id cr --verbose --debug rubin-stis-slit1-4961-merge
#+END_SRC

#+RESULTS:
: Finding bad pixels by the 'edge' method
: Data scaled to range [0.00e+00, 5.00e-13]
: Edge detection with Canny method complete
: Filling of holes complete
: Number of bad pixels: 30343 (2.104% of total)
: Number of distinct bad pixel objects found: 73
: Number of objects skipped:  5
: Replacement of bad pixels complete
: WARNING: Overwriting existing file 'rubin-stis-slit1-4961-merge-cr.fits'. [astropy.io.fits.hdu.hdulist]



**** Help for spotless.py
#+BEGIN_SRC sh :results verbatim
python ~/Work/HST-STIS/spotless/spotless.py --help
#+END_SRC

#+RESULTS:
#+begin_example
usage: spotless.py [-h] [--hdu-index HDU_INDEX] [--output-id OUTPUT_ID]
                   [--method {thresh,edge,segment}] [--onlybadpix]
                   [--threshold THRESHOLD] [--dmax DMAX] [--ddmax DDMAX]
                   [--data-range MIN MAX] [--use-log-scale]
                   [--segment-pars LO HI]
                   [--edge-pars SIGMA LOW_THRESHOLD HIGH_THRESHOLD]
                   [--thick-edges] [--reject-filaments] [--allow-shadows]
                   [--clip-negative]
                   [--exclude-regions-from-file EXCLUDE_REGIONS_FROM_FILE]
                   [--include-regions-from-file INCLUDE_REGIONS_FROM_FILE]
                   [--verbose] [--debug] [--multi-hdu]
                   fitsfile

Remove cosmic rays and other bad pixels from an image

positional arguments:
  fitsfile              Name of image FITS file (sans extension)

optional arguments:
  -h, --help            show this help message and exit
  --hdu-index HDU_INDEX
                        Which HDU to use from the FITS file (default: 0)
  --output-id OUTPUT_ID
                        Extra string to add to output filenames to aid in
                        layer identification (default: )
  --method {thresh,edge,segment}
                        Algorithm to use to find the bad pixels (default:
                        edge)
  --onlybadpix          Only calculate the bad pixel map - do not replace
                        pixels in the image (default: False)
  --threshold THRESHOLD
                        Assume any pixel above this level is bad (default:
                        None)
  --dmax DMAX           Maximum diameter of features to zap. Leave alone any
                        roughly circular objects that are larger than this.
                        (default: 5)
  --ddmax DDMAX         Absolute maximum diameter of features to zap. Leave
                        alone any objects that are larger than this, whatever
                        their shape may be. (default: 10)
  --data-range MIN MAX  Range for data scaling (default: None)
  --use-log-scale       Use logarithmic data scaling (default: False)
  --segment-pars LO HI  For 'segment' method only: thresholds of scaled data
                        to seed the good/bad regions (default: (0.0, 1.0))
  --edge-pars SIGMA LOW_THRESHOLD HIGH_THRESHOLD
                        For 'edge' method only: parameters for the Canny edge
                        detection algorithm. See: http://scikits-
                        image.org/docs/dev/auto_examples/plot_canny.html
                        (default: (1.0, 0.1, 0.2))
  --thick-edges         Make the edges be 3 pixels wide instaed of the default
                        1 (default: False)
  --reject-filaments    Try to reject objects that look filamentary, since
                        they are probably not cosmic rays (default: False)
  --allow-shadows       Also remove objects that are darker than their
                        surroudings (not generally advised, especially if you
                        have dark globules in your image!) (default: False)
  --clip-negative       Also remove all negative pixels (default: False)
  --exclude-regions-from-file EXCLUDE_REGIONS_FROM_FILE
                        Read DS9 regions from a file, which are to be marked
                        as definite good pixels (default: None)
  --include-regions-from-file INCLUDE_REGIONS_FROM_FILE
                        Read DS9 regions from a file, which are to be marked
                        as definite bad pixels (default: None)
  --verbose, -v         Print informative progress messages (default: False)
  --debug, -d           Save auxiliary images of intermediate steps (default:
                        False)
  --multi-hdu, -m       Work in multi-HDU mode. This assumes that the image is
                        in the "SCI" HDU in the input file (the argument
                        --hdu-index is ignored). All additional HDUs in the
                        input file are copied through to the output file. Only
                        one output file is written, all auxilliary arrays
                        ("edges", "labels", "badpix", etc) are written as
                        additional HDUs in the same file. (default: False)
#+end_example

*** Mail that I sent [2013-12-20 Fri]
#+BEGIN_QUOTE
A little later than promised due to family commitments, but I have managed to get some work done on this project.  I decided to go back to the beginning and make sure I was getting the fundamentals right.  So I have been checking the value of the Equivalent Width of [N II] 5755 from various datasets that I have lying around (Keck and STIS).  I also have calculated it for the Ring Nebula from the SPM B&Ch spectra. 

The bottom line is that for multiple positions in Orion, EW(5755) = 3 Angstrom.  Whereas in the main ring of the Ring Nebula, EW(5755) = 100 Angstrom.  These should be compared with the nominal width of the FQ575N filter of WFC3, which is 20.6 Angstrom.

What this means is that our Ring Nebula paper is safe because the continuum contamination of the [N II] auroral line filter is small (~ 20%).  In Orion, on the other hand, the FQ575N filter is dominated by continuum, which is 6 times stronger than the emission line that we want to measure.

This means that if we want to know the [N II] line intensity to a precision of (say) 10%, then we need to know the continuum to a precision of better than 2%. 

So, what I plan on doing next is to check how precisely we can estimate the continuum around 5755 Ang using the filters we have: F547M and F469N.  I plan to do this by comparison with STIS spectra that Bob Rubin obtained many years ago (published in 2003MNRAS.340..362R - Gary is a coauthor).  One of his slit positions overlaps our WFC3 Orion S field and includes the ranges 4308-4594, 4818-5104, and 5448-6020.  So the spectra cover half of the F547M bandpass and they straddle the F469N bandpass but unfortunately do not include it.  Therefore, they should be fine for looking at spatial variations in the continuum color, but will not help us in estimating the line contamination of F469N. 

Of course, the same spectra will also allow a direct comparison of the 5755 intensity with our WFC3 measurements where they overlap, and I think this is worth doing too. 
#+END_QUOTE

** Using the 469 filter to estimate the color term
** Write up calculation of the filter calibration
** Remove the radial trend in the temperatures
* Revisiting this project [2013-08-04 Sun]

+ Main aim is to assess whether we can measure t^2([N II]) or not.
+ First task is to accurately measure the 5755/6584 ratio
  + The main problem is that the 5755 line only contributes about 10% to the FQ575N filter.  The remainder is continuum.  So that continuum needs to be measured and subtracted very accurately.
  + Secondary problem is extinction
+ Second task is to find T([N II]) and t^2 from the 5755/6584 ratio
  + Bob has some of the complications described in [[file:record]]
  + Circular dependence of reddening on T via intrinsic Hb/Ha ratio
  + Dependence of T(N II) on density:
    + t(NII)=2.5/{longRNII - 2.108 + [1 + 4.4E-5Ne/t^1/2]}
    + Density varies from 1000 to 6000 cm^{-3}
      |    n |           |
      |------+-----------|
      | 1000 | 1.0429058 |
      | 6000 | 1.2574349 |
      #+TBLFM: $2=1 + 4.5e-5 $1 / sqrt(1.1)



* The C(Hb) map

+ Strangely, this is consistently higher by about 0.3 with respect to the previous maps, such as O'Dell & Yusef-Zadeh (2000)

* The [N II] temperature map

The main issue here is the correction for the underlying continuum. 

+ In the Ring Nebula EW(Hb) = 800 Angstrom and is roughly constant in the inner region (drops at the outside, where dust scattering becomes important)
+ In Orion, the EW is smaller: roughly 400 Angstrom in the inner regions, but varying strongly with position
+ From O'Dell & Harris we have spectrophotometry
  + The relevant regions are the western portions of slits 11 and 12
  + 

|          |  11-west |  12-west |
|----------+----------+----------|
| c(Hb)    |     0.26 |     0.37 |
| S(Hb)    | 3.25E−13 | 3.93E−13 |
| EW(Hb)   |      380 |      400 |
| NII 5755 |   0.0039 |   0.0032 |
| NII 6584 |   0.3792 |   0.2964 |
| EW(5755) |    1.482 |     1.28 |
| EW(6584) |  144.096 |   118.56 |
#+TBLFM: @7$2..@8$3=@-2 @4
 

** Factors affecting the 5755/6584 determination

*** Spatial variations in the continuum color

+ Bob's =k= term
  + Defined as 
: flux ratio of the continuum (in wavelength intervals) at the line
: filter wavelength and at 547 nm


**** Fig 2 of O'Dell & Harris
+ The spectrum rises towards the blue, even though it is not de-reddened
+ The E sample (EW=190) is bluer than the 12-mid sample (EW=430)
+ Between 547 and 575 there is only a small difference
  + I measure about 0.06 dex for 12-mid
    + Corresponds to a ratio of k = 10**-0.06 = 0.87
    + So even this is significantly different from unity
  + This will have a potentially large effect since EW(5755) is small
+ Between 547 and 658 the difference is a bit larger



**** Evidence from the 469/547 ratio
+ The 469 filter is potentially contaminated by [Fe III] 4701.53 and He I 4713.139, so we have to be careful
  + Baldwin has fluxes as follows
    | lambda(obs) | lambda_0 | Ion      | delta V | FWHM |  I/6678 | Icorr/6678 |     S/N | Notes   |
    |-------------+----------+----------+---------+------+---------+------------+---------+---------|
    |    4701.603 |  4701.53 | [Fe III] |     4.6 |   14 |  0.0390 |     0.0559 |   188.8 |         |
    |    4713.164 | 4713.139 | He I     |     1.5 |   19 |  0.1340 |     0.1916 |   354.3 | average |
    |    4861.334 |  4861.33 | H\beta   |     0.2 |   26 | 17.4964 |    24.2016 | 62680.0 |         |
  + So, assuming H beta EW is 400 Angstrom, we get EWs for the two lines of 400 [0.0559, 0.1916]/24.2016 = [0.924, 3.167] Angstroms
  + The filter width is 53.1 Angstrom according to Bob
    + In addition, the He I line falls on the red flank of the filter, where the transmission is about 0.12, which is 0.6 times the peak
    + Although it will be very sensitive to the heliocentric correction since we are on a very steep part of the transmission curve.
  + So the fractional contribution of the He I line should be 0.6 3.167 / 53.1 = 0.0358 => only about 3.5%
  + The [Fe III] line has a transmission of 0.19 = 0.95 times peak, giving a fractional contribution of 0.95 0.924 / 53.1 = 0.016, which is 1.6%
  + So, in *normal* circumstances the line contamination of F469N should be about 5% when EW(Hb) = 400 Angstrom
    + And would be even less when the EW(Hb) is lower
  + An exception will be from shocked regions that have much enhanced [Fe III] emission
    + For example HH202 from Mesa Delgado et al (2012)
      + The nebular component has flux 0.237 on scale Hb=100 (similar to Baldwin)
      + The shock component has flux 3.915 on scale Hb=100
	+ For Hb:
	  + shock = (6.00±0.20) ×10−12 erg cm−2 s−1
	  + nebula = (3.80±0.20)×10−12 erg cm−2 s−1
	+ So, if we did not resolve the 2 components we would get
	  + 100 I([Fe III]) / I(Hb) =  (6.00 3.915 + 3.80 0.237)/(6.00 + 3.80) = 2.49
	  + So if EW(Hb) = 400, we would have EW([Fe III]) = 400 2.49 / 100 = 9.96
      + So fractional contribution of shocked [Fe III] to F469N is 0.95 9.96 / 53.1 = 0.178
	+ => nearly 20%
    + We can compare this with the excess in 469/547 seen at the position of the HH529 counterflow, which is about 10%
      + So this is not quite as extreme as in HH202, possible because the shock component is not as strong relative to the nebular component
  + Bob estimates (in Ring paper, penultimate para of appendix) that up to 10% of the 469 signal may be from lines (principally He I).
    + I get only half this value (/see above/) 
  + In principle, this could be corrected for if we had observations of another He line.... we don't
  + On the other hand, to zeroth order the He I will follow H I, which in turn follows the Paschen continuum
  + This means that /variations/ in 469/547 are unlikely to be due to the He I line
    + Except for enhanced [Fe III] emission from shocks, which is seen in two or three very localised regions
  + But apart from that, it should be telling us the continuum color
  + It shows peak-to-peak variations of about 20% in the "interesting" (NW) zone, and about 10% in the more boring (SE) zone
  + The ratio 469/547 is /negatively/ correlated with 487/547, which is to first order the EW of Hb
    + That is, the continuum is bluer when EW(Hb) is lower
    + This is what we expect, since the continuum color should be bluer in regions where the scattered continuum is higher
    + It is the /opposite/ of what one would expect if line contamination of 469 were a serious issue
      + Since in that case, the line contamination should be relatively higher when there is less continuum to dilute it
      + Which implies 469/547 should go up when 487/547 goes up, which is not observed.
    + 487/547 shows peak-to-peak variations of order 50% in the NW zone, and 20% in the SE zone


* Useful data
** WFC3 filters

*** Useful continuum filters

Which lines are in which filters?

| Name   | Description    | Pivot λp (nm) | Width (nm) | Peak System Throughput |  lam_1 |  lam_2 |
| 1      | 2              |             3 |          4 |                        |        |        |
|--------+----------------+---------------+------------+------------------------+--------+--------|
| F467M  | Strömgren b    |         468.3 |       20.1 |                   0.28 | 4582.5 | 4783.5 |
| F547M  | Strömgren y    |         544.7 |       65.0 |                   0.26 | 5122.0 | 5772.0 |
| FQ634N | 6194 continuum |         634.9 |        6.4 |                   0.26 | 6317.0 | 6381.0 |
| F645N  | Continuum      |         645.4 |        8.4 |                   0.25 | 6412.0 | 6496.0 |
#+TBLFM: $6=10 ($3 - 0.5 $4) ; f1::$7=10 ($3 + 0.5 $4) ; f1

**** F467M Strömgren b 4582-4783 (W=201 A)

+ This is 4 times broader than F469N, which helps to dilute the lines.
+ But, the sum of the lines are 3 times higher flux!
  + So we don't gain much
  + The majority are He I and [Fe III]

|----------+----------+----------+---+------+----+--------+--------+-------+---------------------------------------------------------------------|
| 4571.200 | 4571.096 | Mg I     |   |  6.9 | 19 | 0.0014 | 0.0021 |   7.4 | the strongest semiforbidden optical line                            |
| 4590.972 | 4590.974 | O II     |   | -0.2 | 13 | 0.0040 | 0.0059 |  27.2 |                                                                     |
| 4596.175 | 4596.177 | O II     |   | -0.1 | 14 | 0.0032 | 0.0047 |  21.3 |                                                                     |
| 4597.048 |  4596.84 | [Ni III] |   | 13.6 | 18 | 0.0019 | 0.0028 |  10.5 |                                                                     |
| 4601.472 | 4601.478 | N II     |   | -0.4 | 15 | 0.0025 | 0.0037 |  15.9 |                                                                     |
| 4602.080 | 4602.129 | O II     |   | -3.2 | 20 | 0.0015 | 0.0022 |   7.5 |                                                                     |
| 4607.114 |  4607.03 | [Fe III] |   |      | 14 | 0.0094 | 0.0138 |  57.1 |                                                                     |
|          | 4607.153 | N II     |   |      |    |        |        |       |                                                                     |
| 4609.440 | 4609.436 | O II     |   |  0.3 | 19 | 0.0023 | 0.0034 |   9.9 |                                                                     |
| 4613.848 | 4613.868 | N II     | ? | -1.3 |  9 | 0.0015 | 0.0022 |   8.2 | average; anomalously low FWHM                                       |
| 4621.355 | 4621.418 | Si II    |   |      | 21 | 0.0030 | 0.0044 |   7.3 | average                                                             |
|          | 4621.696 | Si II    |   |      |    |        |        |       | observed line might include Si II triplet                           |
|          | 4621.722 | Si II    |   |      |    |        |        |       |                                                                     |
|          | 4621.570 | [C I]    |   |      |    |        |        |       |                                                                     |
|          | 4621.393 | N II     |   |      |    |        |        |       | main contributor                                                    |
| 4628.294 | 4628.046 | [Ni II]  | ? | 16.1 |  9 | 0.0008 | 0.0012 |   4.7 | anomalously low FWHM                                                |
| 4630.536 | 4630.539 | N II     |   |      | 14 | 0.0076 | 0.0111 |  37.2 |                                                                     |
|          |  4630.61 | N III    |   |      |    |        |        |       |                                                                     |
| 4634.072 |  4634.13 | N III    | ? | -3.8 | 13 | 0.0008 | 0.0012 |   5.2 | from multiplet with strongest line at 4640.64                       |
| 4638.841 | 4638.856 | O II     |   | -0.9 | 14 | 0.0083 | 0.0121 |  53.9 |                                                                     |
| 4640.569 |  4640.64 | N III    |   | -4.6 | 13 | 0.0013 | 0.0019 |   9.0 | from multiplet with strongest line at 4640.64                       |
| 4641.806 | 4641.810 | O II     |   | -0.3 | 14 | 0.0166 | 0.0241 | 109.0 |                                                                     |
| 4643.086 | 4643.086 | N II     |   |  0.0 | 15 | 0.0037 | 0.0054 |  22.5 |                                                                     |
| 4649.133 | 4649.135 | O II     |   | -0.1 | 14 | 0.0266 | 0.0386 | 171.5 | this is the strongest line of the multiplet; all lines are observed |
| 4650.827 | 4650.838 | O II     |   | -0.7 | 13 | 0.0081 | 0.0117 |  54.9 |                                                                     |
| 4658.149 |  4658.05 | [Fe III] |   |  6.4 | 15 | 0.1246 | 0.1804 | 844.6 |                                                                     |
| 4661.621 | 4661.632 | O II     |   | -0.7 | 14 | 0.0091 | 0.0132 |  67.4 |                                                                     |
| 4667.047 |  4667.01 | [Fe III] |   |  2.4 | 16 | 0.0050 | 0.0072 |  35.9 |                                                                     |
| 4673.720 | 4673.733 | O II     |   | -0.8 | 13 | 0.0014 | 0.0020 |  11.5 |                                                                     |
| 4676.224 | 4676.235 | O II     |   | -0.7 | 16 | 0.0060 | 0.0087 |  43.5 | cosmic ray hit on wing                                              |
| 4696.317 | 4696.353 | O II     | ? | -2.3 | 15 | 0.0011 | 0.0016 |   5.9 | weakest line from multiplet 4649.135                                |
| 4699.167 | 4699.011 | O II     |   |      | 23 | 0.0022 | 0.0032 |   7.5 |                                                                     |
|          | 4699.218 | O II     |   |      |    |        |        |       |                                                                     |
| 4701.603 |  4701.53 | [Fe III] |   |  4.6 | 14 | 0.0390 | 0.0559 | 188.8 |                                                                     |
| 4705.358 | 4705.346 | O II     |   |  0.8 | 13 | 0.0030 | 0.0043 |  14.2 |                                                                     |
| 4711.331 |  4711.37 | [Ar IV]  |   | -2.5 | 13 | 0.0109 | 0.0156 |  38.9 | average                                                             |
| 4713.164 | 4713.139 | He I     |   |  1.5 | 19 | 0.1340 | 0.1916 | 354.3 | average                                                             |
| 4728.294 | 4728.068 | [Fe II]  | ? | 14.3 | 14 | 0.0011 | 0.0016 |   7.0 | possible line from multiplet with 4889.617                          |
| 4733.937 |  4733.91 | [Fe III] |   |  1.7 | 15 | 0.0166 | 0.0236 | 100.8 |                                                                     |
| 4740.188 |  4740.17 | [Ar IV]  |   |  1.1 | 13 | 0.0125 | 0.0178 |  92.5 |                                                                     |
| 4752.953 | 4752.691 | O II     | ? | 16.5 | 22 | 0.0016 | 0.0023 |   8.1 |                                                                     |
| 4754.776 |  4754.69 | [Fe III] |   |  5.4 | 15 | 0.0232 | 0.0329 | 161.6 |                                                                     |
| 4756.469 |          |          | ? |      | 21 | 0.0021 | 0.0030 |  11.1 |                                                                     |
| 4762.400 |          |          | ? |      | 21 | 0.0010 | 0.0014 |   5.6 |                                                                     |
| 4769.496 |  4769.43 | [Fe III] |   |  4.2 | 15 | 0.0136 | 0.0192 |  88.4 |                                                                     |
| 4774.942 | 4774.718 | [Fe II]  |   | 14.1 | 13 | 0.0012 | 0.0017 |   8.3 | from multiplet with strongest line at 4814.534                      |
| 4777.734 |  4777.68 | [Fe III] |   |  3.4 | 14 | 0.0080 | 0.0113 |  53.4 |                                                                     |
| 4779.715 | 4779.722 | N II     |   | -0.4 | 14 | 0.0014 | 0.0020 |   9.6 |                                                                     |
| 4788.139 | 4788.138 | N II     |   |  0.0 | 17 | 0.0020 | 0.0028 |  12.1 |                                                                     |
| 4789.611 |  4789.45 | [F II]   | ? | 10.1 | 16 | 0.0009 | 0.0013 |   5.3 |                                                                     |
| 4792.073 | 4792.007 | S II     | ? |  4.2 | 23 | 0.0010 | 0.0014 |   4.3 |                                                                     |
| 4793.839 | 4793.648 | N II     | ? | 12.0 | 25 | 0.0019 | 0.0027 |   7.7 | several lines of this multiplet are observed                        |
| 4802.489 |          |          | ? |      | 15 | 0.0017 | 0.0024 |   8.6 |                                                                     |
| 4803.267 | 4803.287 | N II     |   | -1.2 | 12 | 0.0023 | 0.0032 |  13.2 | the same multiplet as 4774, 4779, 4781, 4788, 4793, 4810            |
| 4814.741 | 4814.534 | [Fe II]  |   | 12.9 | 18 | 0.0086 | 0.0120 |  28.5 | average; from multiplet with strongest line at 4814.534             |
| 4815.563 | 4815.617 | N II     |   |      | 17 | 0.0030 | 0.0042 |  10.3 | average                                                             |
|          | 4815.552 | S II     |   |      |    | 0.0024 |        |       |                                                                     |
|----------+----------+----------+---+------+----+--------+--------+-------+---------------------------------------------------------------------|
|          |          |          |   |      |    |        |  0.783 |       |                                                                     |
     #+TBLFM: @58$8=vsum(@I..@II)

**** F547M Strömgren y 5122-5772
|----------+----------+----------+---+------+----+--------+--------+--------+--------------------------------------------------------------------------|
| 5121.856 | 5121.828 | C II     |   |  1.7 | 17 | 0.0018 | 0.0024 |   11.3 | B                                                                        |
| 5131.924 |          |          | ? |      | 19 | 0.0013 | 0.0017 |    6.0 | B                                                                        |
| 5146.890 | 5146.749 | Co I     | ? |  8.2 | 17 | 0.0049 | 0.0064 |    8.9 | R                                                                        |
| 5146.917 | 5146.749 | Co I     | ? |  9.8 | 18 | 0.0064 | 0.0083 |   25.5 | B                                                                        |
| 5158.951 | 5158.777 | [Fe II]  |   | 10.1 | 21 | 0.0140 | 0.0182 |   56.7 | B                                                                        |
| 5158.956 | 5158.777 | [Fe II]  |   | 10.4 | 21 | 0.0113 | 0.0147 |   56.6 | R                                                                        |
| 5169.274 | 5169.033 | Fe II    |   | 14.0 | 13 | 0.0014 | 0.0018 |   10.8 | R possibly pumped; strongest line in multiplet; other possible 5018.440  |
| 5169.288 | 5169.033 | Fe II    |   | 14.8 | 10 | 0.0011 | 0.0014 |    8.8 | B                                                                        |
| 5191.700 | 5191.816 | [Ar III] |   | -6.7 | 14 | 0.0127 | 0.0164 |   63.7 | R average                                                                |
| 5198.159 | 5197.902 | [N I]    |   | 14.8 | 11 | 0.0203 | 0.0262 |  291.8 | R                                                                        |
| 5198.169 | 5197.902 | [N I]    |   | 15.4 | 11 | 0.0253 | 0.0327 |  287.0 | B                                                                        |
| 5200.516 | 5200.257 | [N I]    |   | 14.9 | 12 | 0.0119 | 0.0154 |  168.5 | R                                                                        |
| 5200.526 | 5200.257 | [N I]    |   | 15.5 | 11 | 0.0155 | 0.0200 |  175.3 | B                                                                        |
| 5219.353 | 5219.307 | S III    | ? |  2.6 | 18 | 0.0007 | 0.0009 |    3.9 | R                                                                        |
| 5219.359 | 5219.307 | S III    |   |  3.0 | 14 | 0.0009 | 0.0012 |    9.8 | B                                                                        |
| 5220.275 | 5220.059 | [Fe II]  | ? | 12.4 | 19 | 0.0011 | 0.0014 |    5.5 | R average                                                                |
| 5220.297 | 5220.059 | [Fe II]  |   | 13.7 | 20 | 0.0012 | 0.0015 |    9.9 | B                                                                        |
| 5261.854 | 5261.621 | [Fe II]  |   | 13.3 | 15 | 0.0107 | 0.0136 |   38.2 | B possible contribution from Ca I 5261.704 ^{3}D-^{3 }P                     |
| 5261.856 | 5261.621 | [Fe II]  |   | 13.4 | 13 | 0.0088 | 0.0112 |   71.3 | R possible contribution from Ca I 5261.704 ^{3}D-^{3 }P                     |
| 5269.228 | 5268.874 | [Fe II]  | ? | 20.2 | 20 | 0.0007 | 0.0009 |    4.1 | R                                                                        |
| 5270.530 |  5270.40 | [Fe III] |   |  7.4 | 15 | 0.0638 | 0.0812 |  335.1 | R average; possible contribution from Ca I 5270.270 ^{3}D-^{ 3}P            |
| 5270.543 |  5270.40 | [Fe III] |   |  8.1 | 15 | 0.0649 | 0.0826 |  252.8 | B average; possible contribution from Ca I 5270.270 ^{3}D-^{ 3}P            |
| 5273.577 | 5273.346 | [Fe II]  |   | 13.2 | 16 | 0.0057 | 0.0073 |   35.3 | R average                                                                |
| 5273.598 | 5273.346 | [Fe II]  |   | 14.3 | 16 | 0.0053 | 0.0067 |   26.4 | B                                                                        |
| 5275.306 | 5275.123 | O I      |   |      | 19 | 0.0018 | 0.0023 |    8.5 | R average                                                                |
|          | 5275.166 | O I      |   |      |    |        |        |        | R                                                                        |
| 5275.339 | 5275.123 | O I      | ? |      | 20 | 0.0015 | 0.0019 |    6.3 | B cannot see on two-dimensional image                                    |
|          | 5275.166 | O i      | ? |      |    |        |        |        | B                                                                        |
| 5297.037 | 5296.829 | [Fe II]  | ? | 11.8 | 15 | 0.0006 | 0.0008 |    4.7 | R                                                                        |
| 5299.245 | 5299.044 | O I      |   |      | 16 | 0.0046 | 0.0058 |   36.1 | R                                                                        |
|          | 5299.088 | O I      |   |      |    |        |        |        | R                                                                        |
| 5299.252 | 5299.044 | O I      |   |      | 18 | 0.0055 | 0.0070 |   37.2 | B                                                                        |
|          | 5299.088 | O I      |   |      |    |        |        |        | B                                                                        |
| 5333.862 | 5333.646 | [Fe II]  |   | 12.2 | 17 | 0.0028 | 0.0035 |   20.9 | B                                                                        |
| 5333.866 | 5333.646 | [Fe II]  |   | 12.4 | 18 | 0.0025 | 0.0031 |   16.5 | R                                                                        |
| 5342.392 |          |          | ? |      | 14 | 0.0028 | 0.0035 |   26.5 | B                                                                        |
| 5342.395 |          |          | ? |      | 15 | 0.0026 | 0.0033 |   26.2 | R                                                                        |
| 5363.659 |  5363.34 | [Ni IV]  | ? | 17.9 | 15 | 0.0014 | 0.0017 |   10.4 | B                                                                        |
| 5363.665 |  5363.34 | [Ni IV]  | ? | 17.9 | 11 | 0.0008 | 0.0010 |    8.4 | R                                                                        |
| 5376.606 | 5376.452 | [Fe II]  |   |  8.6 | 40 | 0.0037 | 0.0046 |    8.4 | B same multiplet as 5159, 5262                                           |
| 5376.646 | 5376.452 | [Fe II]  |   | 10.8 | 23 | 0.0023 | 0.0029 |   12.1 | R average; fuzzy on two-dimensional image                                |
| 5412.130 |  5411.98 | [Fe III] |   |  8.3 | 18 | 0.0068 | 0.0084 |   30.3 | B                                                                        |
| 5412.149 |  5411.98 | [Fe III] |   |  9.4 | 13 | 0.0062 | 0.0077 |   42.9 | R                                                                        |
| 5432.762 | 5432.797 | S II     | ? | -1.9 | 14 | 0.0009 | 0.0011 |    6.9 | B                                                                        |
| 5432.824 | 5432.797 | S II     | ? |  1.5 | 15 | 0.0012 | 0.0015 |    6.2 | R same multiplet as 5453.855                                             |
| 5433.365 | 5433.129 | [Fe II]  |   | 13.0 | 15 | 0.0018 | 0.0022 |    7.6 | R average; same multiplet as 5273                                        |
| 5433.369 | 5433.129 | [Fe II]  |   | 13.3 | 20 | 0.0017 | 0.0021 |   10.1 | B                                                                        |
| 5453.843 | 5453.855 | S II     |   | -0.7 | 13 | 0.0013 | 0.0016 |    9.1 | R same multiplet as 5432.797                                             |
| 5453.853 | 5453.855 | S II     |   | -0.1 | 11 | 0.0012 | 0.0015 |   11.4 | B                                                                        |
| 5495.626 | 5495.655 | N II     |   | -1.6 | 24 | 0.0019 | 0.0023 |    9.2 | B, gh                                                                    |
| 5495.640 | 5495.655 | N II     |   | -0.8 | 15 | 0.0013 | 0.0016 |   14.9 | R several weak lines of this multiplet possibly observed                 |
| 5506.859 | 5506.778 | Fe I     | ? |      | 10 | 0.0005 | 0.0006 |    5.3 | R                                                                        |
|          |  5507.00 | S I      | ? |      |    |        |        |        | R                                                                        |
| 5512.978 | 5512.772 | O I      |   |      | 16 | 0.0035 | 0.0043 |   40.2 | R average; ID lambda is average of sextet with all lines within 0.2A     |
|          | 5512.820 | O I      |   |      |    |        |        |        | R                                                                        |
|          | 5512.980 | Ca I     |   |      |    |        |        |        | R                                                                        |
| 5512.994 | 5512.772 | O I      |   |      | 16 | 0.0038 | 0.0046 |   14.3 | B wavelength is approximate, averaged for several lines in the multiplet |
|          | 5512.820 | O I      |   |      |    |        |        |        | B                                                                        |
|          | 5512.980 | Ca I     |   |      |    |        |        |        | B                                                                        |
| 5517.675 |  5517.66 | [Cl III] |   |      | 14 | 0.0810 | 0.0984 |  456.3 | R average, blended with weak line                                        |
|          |  5517.66 | [Ni IV]  |   |      |    |        |        |        | R                                                                        |
| 5517.680 |  5517.66 | [Cl III] |   |      | 14 | 0.0832 | 0.1011 |  258.4 | B blended with weak line                                                 |
|          |  5517.66 | [Ni IV]  |   |      |    |        |        |        | B                                                                        |
| 5518.354 | 5518.102 | N I      | ? |      | 14 | 0.0047 | 0.0057 |    8.9 | B average, blend with strong line                                        |
|          | 5518.576 | N I      | ? |      |    |        |        |        | B average                                                                |
| 5518.342 | 5518.102 | N I      | ? |      | 14 | 0.0050 | 0.0061 |   26.9 | R                                                                        |
|          | 5518.576 | N I      | ? |      | 14 |        |        |        | R average, blend with strong line                                        |
| 5527.508 |          |          |   |      | 21 | 0.0027 | 0.0033 |   16.7 | R not seen in blue spectrum                                              |
| 5535.357 | 5535.347 | N II     | ? |      | 24 | 0.0012 | 0.0015 |    5.3 | R                                                                        |
|          | 5535.353 | C II     | ? |      |    |        |        |        | R                                                                        |
|          | 5535.383 | N II     | ? |      |    |        |        |        | R several weak lines of this multiplet are possibly observed             |
| 5537.829 |   5537.7 | [Cl III] |   |      | 17 | 0.1257 | 0.1522 |  701.9 | B                                                                        |
| 5537.830 |   5537.7 | [Cl III] |   |      | 14 | 0.1220 | 0.1477 |  856.1 | R average                                                                |
| 5551.843 | 5551.922 | N II     |   | -4.3 | 20 | 0.0014 | 0.0017 |    8.6 | R several weak lines of this multiplet are possibly observed             |
| 5551.901 | 5551.922 | N II     |   | -1.1 | 19 | 0.0014 | 0.0017 |    8.1 | B                                                                        |
| 5555.209 | 5555.004 | O I      |   |      | 19 | 0.0055 | 0.0066 |   32.2 | B                                                                        |
|          | 5555.053 | O I      |   |      |    |        |        |        | B                                                                        |
| 5555.224 | 5555.004 | O I      |   |      | 17 | 0.0050 | 0.0060 |   24.8 | R average                                                                |
|          | 5555.053 | O I      |   |      |    |        |        |        | R                                                                        |
| 5577.523 | 5577.339 | [O I]    |   |  9.9 | 22 | 0.0028 | 0.0034 |   16.4 | B                                                                        |
| 5577.537 | 5577.339 | [O I]    |   | 10.7 | 20 | 0.0028 | 0.0034 |   15.6 | R                                                                        |
| 5606.145 | 5606.151 | S II     | ? | -0.3 | 11 | 0.0005 | 0.0006 |    6.0 | B strongest line in multiplet                                            |
| 5666.606 |  5666.63 | N II     | ? | -1.3 | 15 | 0.0045 | 0.0053 |    6.3 | B                                                                        |
| 5666.619 |  5666.63 | N II     |   | -0.6 | 15 | 0.0063 | 0.0075 |   55.3 | R                                                                        |
| 5675.990 |  5676.02 | N II     |   | -1.6 | 25 | 0.0038 | 0.0045 |    9.5 | B                                                                        |
| 5676.000 |  5676.02 | N II     |   | -1.1 | 15 | 0.0024 | 0.0028 |   21.9 | R                                                                        |
| 5679.542 |  5679.56 | N II     |   | -1.0 | 18 | 0.0088 | 0.0104 |   30.2 | B                                                                        |
| 5679.551 |  5679.56 | N II     |   | -0.5 | 15 | 0.0088 | 0.0104 |   80.1 | R                                                                        |
| 5686.178 |  5686.21 | N II     | ? | -1.7 | 17 | 0.0018 | 0.0021 |    7.1 | B                                                                        |
| 5686.198 |  5686.21 | N II     |   | -0.6 | 13 | 0.0016 | 0.0019 |   15.0 | R                                                                        |
| 5710.736 |  5710.77 | N II     |   | -1.8 | 18 | 0.0020 | 0.0023 |   12.0 | B                                                                        |
| 5710.757 |  5710.77 | N II     |   | -0.7 | 13 | 0.0018 | 0.0021 |   14.3 | R                                                                        |
| 5739.691 |  5739.73 | Si III   |   | -2.0 | 13 | 0.0047 | 0.0055 |   44.9 | R                                                                        |
| 5739.699 |  5739.73 | Si III   |   | -1.6 | 14 | 0.0049 | 0.0057 |   42.3 | B                                                                        |
| 5747.190 | 5746.966 | [Fe II]  | ? | 11.7 | 17 | 0.0007 | 0.0008 |    5.5 | B                                                                        |
| 5754.663 |  5754.59 | [N II]   |   |  3.8 | 18 | 0.1727 | 0.2014 |  974.0 | R average                                                                |
| 5754.664 |  5754.59 | [N II]   |   |  3.9 | 19 | 0.1693 | 0.1974 | 1162.2 | B                                                                        |
|----------+----------+----------+---+------+----+--------+--------+--------+--------------------------------------------------------------------------|
|          |          |          |   |      |    |        | 1.4545 |        |                                                                          |
#+TBLFM: @98$8=vsum(@I..@II)
+ Total line strength is about 1 x that of the reference line (is that H\beta?)
  + We need to be careful with double counting, since many lines are observed in both the red and the blue arm
  + No, it is 6678 and H\beta has 24.2016, so we have a total of about 4% of H\beta
  + So the total EW(lines) is about 16 \AA for EW(H\beta) = 400 \AA
  + The filter width is 650 \AA, so line contamination is 2.5%
+ Strongest lines
  + [N II] 5755: 0.17
  + [Cl III] 5517+5538 : 0.21
  + [Ar III] 5199: 0.012
  + [N I] 5198+5200: 0.04
  + [Fe II] 5159+5261: 0.03
  + [Fe III] 5270: 0.07
  + TOTAL: 0.532 of which [N II] is 33%
    + This is 0.022 times H\beta \Rightarrow EW(lines) \approx 9 \AA
+ In the Ring Nebula: [N II] and [N I] are the only lines seen by Guerrero, and are both similar strengths, with EW > 50A each

**** FQ634N 6317-6381
Note that [S III] is just outside - need to check transmission there

| 6312.075 |  6312.06 | [S III] |   |  0.7 | 14 | 0.4755 | 0.5050 | 2908.8 | average        |
| 6347.147 |  6347.11 | Si II   |   |  1.8 | 20 | 0.0420 | 0.0444 |  227.4 | average        |
| 6364.011 | 6363.776 | [O I]   |   | 11.1 | 16 | 0.0621 | 0.0654 |  469.5 | average        |
| 6365.433 |  6365.10 | [Ni II] |   |      | 10 | 0.0020 | 0.0021 |   20.9 | average        |
| 6371.396 |  6371.37 | Si II   |   |  1.2 | 19 | 0.0212 | 0.0223 |  153.1 | average; blend |


**** F645N 6412-6496
| 6402.273 | 6402.246 | Ne I    | ? | 1.3 | 13 | 0.0018 | 0.0019 | 17.7 | identified by Esteban 1998 |
| 6440.522 | 6440.400 | [Fe II] | ? | 5.7 | 19 | 0.0005 | 0.0005 |  4.6 |                            |
| 6461.836 |          |         |   |     | 14 | 0.0060 | 0.0062 | 39.2 | average                    |


*** Just the filters we use

Bob says in the Ring paper...

: We adopted the pre-launch determined values of W from Table 6.2 of the
: WFC3 Instrument Handbook, except increasing the values slightly
: because of the broadening due to short wavelength shift of the filter
: profile. The amount of the shift was guided by the determination from
: emission-lines falling on the short wavelength portion of the filter
: profile described below. The adopted values of W were FQ436N (4.5 nm),
: FQ437N (3.3 nm), F469N (5.31 nm), F487N (6.2 nm), FQ575N (2.06 nm),
: FQ672N (2.21 nm), F673N (12.31 nm), and FQ674N (2.11 nm). It was not
: necessary to adopt a value of W for F502N, F656N, and F658N because
: the observed continuum was so weak that the continuum correction was
: less than 0.01).

Which gives ...

| Name   | Description            | Pivot λp (nm) | Width (nm) | Peak System Throughput | EW (Ang) | EW/EW547 | W/W547 |
| 1      | 2                      |             3 |          4 |                      5 |        6 |        7 |      8 |
|--------+------------------------+---------------+------------+------------------------+----------+----------+--------|
| FQ436N | Hγ 4340 + [O III] 4363 |         436.7 |        4.3 |                   0.19 |      8.2 |   0.0485 | 0.0662 |
| FQ437N | [O III] 4363           |         437.1 |       3.30 |                   0.20 |      6.6 |   0.0391 | 0.0508 |
| F469N  | He II 4686             |         468.8 |       5.31 |                   0.20 |     10.6 |   0.0627 | 0.0817 |
| F487N  | Hβ 4861                |         487.1 |       6.20 |                   0.25 |     15.5 |   0.0917 | 0.0954 |
| F502N  | [O III] 5007           |         501.0 |       6.50 |                   0.26 |     16.9 |   0.1000 | 0.1000 |
| F547M  | Strömgren y            |         544.7 |      65.00 |                   0.26 |    169.0 |   1.0000 | 1.0000 |
| FQ575N | [N II] 5754            |         575.8 |       2.06 |                   0.23 |      4.7 |   0.0278 | 0.0317 |
| F656N  | Hα 6562                |         656.1 |       1.80 |                   0.24 |      4.3 |   0.0254 | 0.0277 |
| F658N  | [N II] 6583            |         658.4 |       2.80 |                   0.26 |      7.3 |   0.0432 | 0.0431 |
| FQ672N | [S II] 6717            |         671.6 |       2.21 |                   0.25 |      5.5 |   0.0325 | 0.0340 |
| F673N  | [S II] 6717/6731       |         676.6 |      12.31 |                   0.25 |     30.8 |   0.1822 | 0.1894 |
| FQ674N | [S II] 6731            |         673.1 |       2.11 |                   0.19 |      4.0 |   0.0237 | 0.0325 |
#+TBLFM: $6=10 $-1 $-2; f1::$7=$-1/@8$-1; f4::$8=$4/@8$4;f4

+ For the most part, the transmission profiles are very square, but F547M has a significant slope: from 0.26 at 525 nm to 0.19 at 580 nm.
  + This does not affect the nominal width, which is EW/peak
  + But it means that there will be a color term in the filter sensitivity
  + Variation is about 20%


**** Notes to the table columns

Columns 1-4 are described below. 

6 - EW is Width times Peak Throughput (in Angstroms for a change).

7 - EW normalised to the F547M filter

8 - Same as previous, but for the nominal widths instead

*** All filter characteristics from the WFC3 Instrument Handbook


From http://www.stsci.edu/hst/wfc3/documents/handbooks/currentIHB/c06_uvis06.html

Table 6.2: WFC3/UVIS Filters and Grism


*** UVIS Long-Pass (LP) and Extremely Wide (X) Filters

| Name   | Description                        | Pivot λp (nm) | Width (nm) | Peak System Throughput |
| 1      | 2                                  |             3 |          4 |                        |
|--------+------------------------------------+---------------+------------+------------------------|
| F200LP | Clear                              |         488.3 |      502.2 |                   0.33 |
| F300X  | Extremely wide UV; grism reference |         280.7 |       66.3 |                   0.17 |
| F350LP | Long pass                          |         584.6 |      475.8 |                   0.29 |
| F475X  | Extremely wide blue                |         493.9 |      205.6 |                   0.28 |
| F600LP | Long pass                          |         744.4 |      229.2 |                   0.29 |
| F850LP | SDSS z′                            |         916.6 |      118.2 |                   0.09 |

*** UVIS Wide-Band (W) Filters

| Name  | Description    | Pivot λp (nm) | Width (nm) | Peak System Throughput |
| 1     | 2              |             3 |          4 |                        |
|-------+----------------+---------------+------------+------------------------|
| F218W | ISM feature    |         222.4 |       32.2 |                   0.05 |
| F225W | UV wide        |         235.9 |       46.7 |                   0.10 |
| F275W | UV wide        |         270.4 |       39.8 |                   0.13 |
| F336W | U, Strömgren u |         335.5 |       51.1 |                   0.20 |
| F390W | Washington C   |         392.1 |       89.6 |                   0.25 |
| F438W | WFPC2 B        |         432.5 |       61.8 |                   0.24 |
| F475W | SDSS g′        |         477.3 |      134.4 |                   0.27 |
| F555W | WFPC2 V        |         530.8 |      156.2 |                   0.28 |
| F606W | WFPC2 Wide V   |         588.7 |      218.2 |                   0.29 |
| F625W | SDSS r′        |         624.2 |      146.3 |                   0.28 |
| F775W | SDSS i′        |         764.7 |      117.1 |                   0.23 |
| F814W | WFPC2 Wide I   |         802.4 |      153.6 |                   0.23 |
|       |                |               |            |                        |

*** UVIS Medium-Band (M) Filters

| Name   | Description     | Pivot λp (nm) | Width (nm) | Peak System Throughput |
| 1      | 2               |             3 |          4 |                        |
|--------+-----------------+---------------+------------+------------------------|
| F390M  | Ca II continuum |         389.7 |       20.4 |                   0.22 |
| F410M  | Strömgren v     |         410.9 |       17.2 |                   0.27 |
| FQ422M | Blue continuum  |         421.9 |       11.2 |                   0.19 |
| F467M  | Strömgren b     |         468.3 |       20.1 |                   0.28 |
| F547M  | Strömgren y     |         544.7 |       65.0 |                   0.26 |
| F621M  | 11% passband    |         621.9 |       60.9 |                   0.28 |
| F689M  | 11% passband    |         687.6 |       68.3 |                   0.25 |
| F763M  | 11% passband    |         761.2 |       70.4 |                   0.21 |
| F845M  | 11% passband    |         843.6 |       78.7 |                   0.14 |
|        |                 |               |            |                        |

*** UVIS Narrow-Band (N) Filters

| Name   | Description            | Pivot λp (nm) | Width (nm) | Peak System Throughput |
| 1      | 2                      |             3 |          4 |                        |
|--------+------------------------+---------------+------------+------------------------|
| FQ232N | C II] 2326             |         241.3 |        3.4 |                   0.04 |
| FQ243N | [Ne IV] 2425           |         246.8 |        3.6 |                   0.05 |
| F280N  | Mg II 2795/2802        |         283.1 |        4.3 |                   0.06 |
| F343N  | [Ne V] 3426            |         343.5 |       25.0 |                   0.21 |
| F373N  | [O II] 3726/3728       |         373.0 |        5.0 |                   0.18 |
| FQ378N | z ([O II] 3726)        |         379.2 |        9.9 |                   0.20 |
| FQ387N | [Ne III] 3868          |         387.4 |        3.4 |                   0.18 |
| F395N  | Ca II 3933/3968        |         395.5 |        8.5 |                   0.22 |
| FQ436N | Hγ 4340 + [O III] 4363 |         436.7 |        4.3 |                   0.19 |
| FQ437N | [O III] 4363           |         437.1 |        3.0 |                   0.20 |
| F469N  | He II 4686             |         468.8 |        5.0 |                   0.20 |
| F487N  | Hβ 4861                |         487.1 |        6.0 |                   0.25 |
| FQ492N | z (Hβ)                 |         493.3 |       11.4 |                   0.25 |
| F502N  | [O III] 5007           |         501.0 |        6.5 |                   0.26 |
| FQ508N | z ([O III] 5007)       |         509.1 |       13.1 |                   0.26 |
| FQ575N | [N II] 5754            |         575.8 |        1.8 |                   0.23 |
| FQ619N | CH4 6194               |         619.9 |        6.1 |                   0.26 |
| F631N  | [O I] 6300             |         630.4 |        5.8 |                   0.25 |
| FQ634N | 6194 continuum         |         634.9 |        6.4 |                   0.26 |
| F645N  | Continuum              |         645.4 |        8.4 |                   0.25 |
| F656N  | Hα 6562                |         656.1 |        1.8 |                   0.24 |
| F657N  | Wide Hα + [N II]       |         656.7 |       12.1 |                   0.26 |
| F658N  | [N II] 6583            |         658.4 |        2.8 |                   0.26 |
| F665N  | z (Hα + [N II])        |         665.6 |       13.1 |                   0.26 |
| FQ672N | [S II] 6717            |         671.6 |        1.9 |                   0.25 |
| F673N  | [S II] 6717/6731       |         676.6 |       11.8 |                   0.25 |
| FQ674N | [S II] 6731            |         673.1 |        1.8 |                   0.19 |
| F680N  | z (Hα + [N II])        |         687.7 |       37.1 |                   0.25 |
| FQ727N | CH4 7270               |         727.5 |        6.4 |                   0.21 |
| FQ750N | 7270 continuum         |         750.3 |        7.0 |                   0.18 |
| FQ889N | CH4 25 km-agt5         |         889.2 |        9.8 |                   0.10 |
| FQ906N | CH4 2.5 km-agt         |         905.8 |        9.9 |                   0.08 |
| FQ924N | CH4 0.25 km-agt        |         924.8 |        9.2 |                   0.08 |
| FQ937N | CH4 0.025 km-agt       |         937.2 |        9.3 |                   0.07 |
| F953N  | [S III] 9532           |         953.0 |        9.7 |                   0.05 |
|        |                        |               |            |                        |


*** Column descriptions

1. The spectral-element naming convention is as follows for both the
   UVIS and IR channels. All filter names begin with F, and grisms
   with G; if the filter is part of a four-element quad mosaic, a Q
   follows F. Then there is a three-digit number giving the nominal
   effective wavelength of the bandpass, in nm (UVIS channel) or nm/10
   (IR channel). (For long-pass filters, the number is instead the
   nominal blue cut-off wavelength in nm.) Finally, for the filters,
   one or two letters indicate the bandpass width: X (extremely wide),
   LP (long pass), W (wide), M (medium), or N (narrow).

2. Filters intended for imaging in a red-shifted bandpass are given
   descriptions similar to the following: “z (Hα + [N II])”.

3. “Pivot wavelength” is a measure of the effective wavelength of a
   filter (see Section 9.3 and Tokunaga & Vacca 2005, PASP, 117,
   421). It is calculated here based on the integrated system
   throughput. Filter transmissions were measured in air, but the
   equivalent vacuum wavelengths are reported in this table.

4. Widths listed are passband rectangular width, defined as the
   equivalent width divided by the maximum throughput within the
   filter bandpass. Equivalent width is the integral with respect to
   wavelength of the throughput across the filter passband.



* Bob's formulae for the filter calibrations

** FQ575N

\[
r_{\mathrm{pred}} = 1 + \left[50.44 k^{-1} \frac{R_{\mathrm{F575N}}}{R_{\mathrm{F547M}}} - 1\right]^{-1}
\]


* Export options						   :noexport:
#+TITLE:     Orion t^2 project
#+AUTHOR:    William Henney
#+EMAIL:     w.henney@crya.unam.mx
#+DESCRIPTION:
#+KEYWORDS:
#+LANGUAGE:  en
#+PROPERTY: header-args    :exports both
#+OPTIONS:   H:5 num:nil toc:t \n:nil @:t ::t |:t ^:{} -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc
#+INFOJS_OPT: view:nil toc:nil ltoc:t mouse:underline buttons:0 path:http://orgmode.org/org-info.js
#+EXPORT_SELECT_TAGS: export
#+EXPORT_EXCLUDE_TAGS: noexport
#+LINK_UP:   
#+LINK_HOME: 
#+XSLT:

